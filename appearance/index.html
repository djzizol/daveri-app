<!doctype html>
<html lang="pl">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title data-i18n="appearance.page.metaTitle"></title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <style>
    /* ========== PODSTAWOWE RESET + ROOT ========== */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    :root {
      /* ===== ONE CANVAS APP - DARK MODE ===== */
      --dv-bg: #0d0e13;
      --dv-bg2: #0d0e13;
      --dv-panel: transparent;
      --dv-surface: rgba(255, 255, 255, .04);
      --dv-surface2: rgba(255, 255, 255, .08);
      --dv-stroke: rgba(255, 255, 255, .06);
      --dv-stroke2: rgba(255, 255, 255, .10);
      --dv-text: #e5e5e5;
      --dv-text2: #b0b0b0;
      --dv-muted: #808080;
      --dv-muted2: #606060;
      --text-primary: var(--dv-text);
      /* ===== BRAND GRADIENTS ===== */
      --dv-burg: #fb7185;
      --dv-vio: #a855f7;
      --dv-blue: #60a5fa;
      --dv-grad: linear-gradient(135deg, var(--dv-burg) 0%, var(--dv-vio) 48%, var(--dv-blue) 100%);
      /* ===== ACCENT ===== */
      --dv-accent: #8b5cf6;
      --dv-accent-hover: #a78bfa;
      --dv-accent-muted: rgba(139, 92, 246, .12);
      --dv-accent-glow: rgba(139, 92, 246, .20);
      /* ===== RADIUS ===== */
      --dv-radius-xl: 12px;
      --dv-radius-lg: 10px;
      --dv-radius-md: 8px;
      --dv-radius-sm: 6px;
      --dv-radius-xs: 4px;
      --dv-radius-pill: 999px;
      /* ===== SPACING ===== */
      --dv-section-gap: 48px;
      --dv-content-padding: 24px;
      /* ===== TRANSITIONS ===== */
      --dv-ease: cubic-bezier(.22, .61, .36, 1);
      --dv-transition-fast: .15s var(--dv-ease);
      --dv-transition-med: .2s var(--dv-ease);
      /* ===== TYPOGRAPHY ===== */
      --dv-font-sans: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      --dv-font-mono: 'SF Mono', 'Monaco', 'Fira Code', monospace;
      /* ===== SIDEBAR WIDTH ===== */
      --dv-sidebar-w: 0px;
      /* ===== DIVIDER ===== */
      --dv-divider: rgba(255, 255, 255, .04);
    }

    /* ===== LIGHT MODE ===== */
    [data-theme="light"] {
      --dv-bg: #f5f5f5;
      --dv-bg2: #f5f5f5;
      --dv-panel: transparent;
      --dv-surface: rgba(0, 0, 0, .04);
      --dv-surface2: rgba(0, 0, 0, .08);
      --dv-stroke: rgba(0, 0, 0, .06);
      --dv-stroke2: rgba(0, 0, 0, .10);
      --dv-text: #1a1a1a;
      --dv-text2: #4a4a4a;
      --dv-muted: #6a6a6a;
      --dv-muted2: #9a9a9a;
      --dv-divider: rgba(0, 0, 0, .06);
      --text-primary: var(--dv-text);
    }

    /* ========== BODY - ONE CANVAS WITH AMBIENT LIGHT ========== */
    body {
      font-family: var(--dv-font-sans);
      background: var(--dv-bg);
      color: var(--dv-text);
      letter-spacing: -0.015em;
      min-height: 100vh;
      overflow-x: hidden;
      line-height: 1.5;
      position: relative;
    }
    
    /* Neutral ambient light layer */
    body::before {
      content: "";
      position: fixed;
      inset: 0;
      background:
        radial-gradient(circle at 20% 30%, rgba(255,255,255,0.06), transparent 40%),
        radial-gradient(circle at 80% 60%, rgba(255,255,255,0.04), transparent 45%),
        radial-gradient(circle at 50% 80%, rgba(255,255,255,0.03), transparent 40%);
      pointer-events: none;
      z-index: 0;
      animation: ambientDrift 30s ease-in-out infinite;
    }
    
    @keyframes ambientDrift {
      0%, 100% {
        background-position: 0% 0%, 100% 100%, 50% 50%;
        opacity: 1;
      }
      25% {
        background-position: 10% 20%, 90% 80%, 40% 60%;
        opacity: 0.9;
      }
      50% {
        background-position: 20% 10%, 80% 90%, 60% 40%;
        opacity: 1;
      }
      75% {
        background-position: 5% 15%, 95% 85%, 45% 55%;
        opacity: 0.95;
      }
    }
    
    /* Floating blur light - subtle ambient bloom */
    body::after {
      content: "";
      position: fixed;
      width: 600px;
      height: 600px;
      background: radial-gradient(circle, rgba(255,255,255,0.06), transparent 60%);
      filter: blur(100px);
      opacity: 0.35;
      pointer-events: none;
      z-index: 0;
      top: 20%;
      left: 30%;
      animation: floatLight 40s ease-in-out infinite;
    }
    
    @keyframes floatLight {
      0%, 100% {
        transform: translate(0, 0);
      }
      25% {
        transform: translate(15%, 10%);
      }
      50% {
        transform: translate(25%, -5%);
      }
      75% {
        transform: translate(10%, 15%);
      }
    }

    /* ========== APP CONTAINER ========== */
    .app-container {
      max-width: 1600px;
      margin: 0 auto;
      padding: 0 var(--dv-content-padding);
      position: relative;
    }

    /* ========== SIDEBAR LAYOUT CSS ========== */
    /* Page wrapper - flexbox layout */
    #page-wrapper {
      display: flex;
      min-height: 100vh;
      width: 100%;
      position: relative;
      z-index: 1;
    }

    /* Sidebar spacer - reserves space for fixed sidebar */
    #sidebar-spacer {
      width: var(--dv-sidebar-w, 0px);
      flex-shrink: 0;
      transition: width .22s cubic-bezier(.22, .61, .36, 1);
    }

    /* Main content - fills remaining space */
    #main-content {
      flex: 1;
      min-width: 0;
      max-width: 100%;
      transition: all .22s cubic-bezier(.22, .61, .36, 1);
      overflow-x: hidden;
    }

    /* App container adjusts to available space */
    .app-container {
      max-width: 100%;
      transition: all .22s cubic-bezier(.22, .61, .36, 1);
    }

    /* ========== APP HEADER - CONTEXT ONLY ========== */
    .app-header {
      display: flex;
      justify-content: flex-start;
      align-items: center;
      padding: 12px 0;
      margin-bottom: 0;
      border-radius: 0;
      background: transparent;
      border: none;
    }

    /* Logo - hidden, context selector only */
    .app-logo {
      display: none;
    }

    /* Bot selector inline */
    .header-right {
      margin-left: 0;
    }

    .header-right .control-group {
      display: none;
    }

    /* Control Group */
    .control-group {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* Buttons - Minimal, app-style */
    .btn {
      height: 32px;
      padding: 0 12px;
      border-radius: var(--dv-radius-sm);
      border: none;
      font-size: 13px;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      cursor: pointer;
      transition: all .15s ease;
      background: var(--dv-surface);
      color: var(--dv-text);
    }

    .btn:hover {
      background: var(--dv-surface2);
    }

    .btn:active {
      opacity: 0.8;
    }

    .btn-secondary {
      background: transparent;
      color: var(--dv-muted);
    }

    .btn-secondary:hover {
      background: var(--dv-surface);
      color: var(--dv-text);
    }

    .btn-primary {
      background: var(--dv-text);
      color: var(--dv-bg);
      font-weight: 500;
    }

    .btn-primary:hover {
      background: #fff;
    }

    [data-theme="light"] .btn-primary {
      background: var(--dv-text);
      color: #fff;
    }

    [data-theme="light"] .btn-primary:hover {
      background: #000;
    }

    .btn-sm {
      height: 28px;
      padding: 0 10px;
      font-size: 12px;
    }

    /* ========== SINGLE ROW CANVAS LAYOUT ========== */
    .content-area {
      display: grid;
      grid-template-columns: 320px minmax(0, 1fr) 420px;
      align-items: stretch;
      height: 100vh;
      overflow: hidden;
      background: transparent;
      gap: 0;
      position: relative;
      z-index: 1;
    }

    .layout-mobile-tabs {
      display: none;
    }

    .config-column {
      min-width: 240px;
      height: 100vh;
      overflow: auto;
      border-right: 1px solid var(--dv-divider);
      background: transparent;
      flex-shrink: 0;
      /* Elegant thin scrollbar - Firefox */
      scrollbar-width: thin;
      scrollbar-color: rgba(255, 255, 255, 0.2) transparent;
    }

    /* Elegant thin scrollbar - Chrome / Edge / Safari */
    .config-column::-webkit-scrollbar {
      width: 5px;
    }

    .config-column::-webkit-scrollbar-track {
      background: transparent;
    }

    .config-column::-webkit-scrollbar-thumb {
      background-color: rgba(255, 255, 255, 0.2);
      border-radius: 999px;
    }

    .config-column::-webkit-scrollbar-thumb:hover {
      background-color: rgba(255, 255, 255, 0.4);
    }

    .live-preview-column,
    .device-preview-column {
      min-width: 0;
      height: 100vh;
      overflow: auto;
    }

    .live-preview-column {
      border-right: 1px solid var(--dv-divider);
    }

    .preview-area {
      min-width: 0;
      min-height: 0;
      overflow: visible;
      background: transparent;
    }
    
    /* Premium Section Labels */
    .preview-section {
      display: flex;
      flex-direction: column;
      height: 100%;
      min-width: 0;
    }
    
    .preview-section .work-column,
    .preview-section .mobile-column,
    .preview-section .monitor-wrapper {
      flex: 1;
      height: auto;
    }
    
    .section-label {
      font-size: 13px;
      font-weight: 500;
      color: rgba(255, 255, 255, 0.65);
      margin-bottom: 12px;
      letter-spacing: 0.2px;
      padding-left: 4px;
      flex-shrink: 0;
    }
    
    /* Ambient Particles Canvas */
    #ambientParticles {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 0;
      opacity: 0.6;
    }

    /* ========== BOTTOM ACTIONS ========== */
    .bottom-actions {
      display: flex;
      justify-content: flex-end;
      gap: 12px;
      padding: 24px 0;
      margin-top: 48px;
      border-top: 1px solid var(--dv-divider);
    }

    /* ========== CONFIG PANEL - NO HEIGHT LIMITS ========== */
    .config-panel {
      background: transparent;
      border-radius: 0;
      border: none;
      overflow: visible;
      height: auto;
      padding-top: 24px;
      padding-bottom: 48px;
    }

    .config-accordion {
      padding: 0;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    /* Config Section - Flat, no cards */
    .config-section {
      background: transparent;
      border-radius: var(--dv-radius-md);
      border: none;
      margin-bottom: 0;
      overflow: hidden;
      transition: background .15s ease;
    }

    .config-section:hover {
      background: var(--dv-surface);
    }

    .config-section.active {
      background: var(--dv-surface);
    }

    /* Section Header */
    .section-header {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      cursor: pointer;
      user-select: none;
      border-radius: var(--dv-radius-md);
      transition: background .15s ease;
    }

    .section-header:hover {
      background: var(--dv-surface);
    }

    .section-icon {
      width: 24px;
      height: 24px;
      border-radius: var(--dv-radius-xs);
      background: transparent;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .section-icon i {
      font-size: 14px;
      color: var(--dv-muted);
    }

    .section-title {
      flex: 1;
      min-width: 0;
    }

    .section-title h3 {
      font-size: 13px;
      font-weight: 500;
      letter-spacing: -0.02em;
      color: var(--dv-text);
      color: var(--dv-text);
      margin-bottom: 2px;
    }

    .section-title p {
      font-size: 12px;
      color: var(--dv-muted);
      letter-spacing: 0.02em;
    }

    .arrow {
      font-size: 12px;
      color: var(--dv-muted2);
      transition: transform var(--dv-transition-med), color var(--dv-transition-med);
    }

    .config-section.active .arrow {
      transform: rotate(180deg);
      color: var(--dv-vio);
    }

    /* Section Content - Smooth accordion */
    .section-content {
      padding: 0 16px;
      max-height: 0;
      overflow: hidden;
      opacity: 0;
      transition: max-height .25s ease, padding .2s ease, opacity .2s ease;
    }

    .config-section.active .section-content {
      padding: 8px 16px 20px;
      max-height: 800px;
      opacity: 1;
    }

    /* Option Groups */
    .option-group {
      margin-bottom: 24px;
    }

    .option-group:last-child {
      margin-bottom: 0;
    }

    .option-group h4 {
      font-size: 12px;
      font-weight: 800;
      color: var(--dv-muted);
      text-transform: uppercase;
      letter-spacing: var(--dv-letter-spacing-wide);
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .option-group h4::after {
      content: "";
      flex: 1;
      height: 1px;
      background: linear-gradient(90deg, var(--dv-stroke), transparent);
    }

    /* Sub-section headers */
    .subsection-header {
      font-size: 13px;
      font-weight: 700;
      color: var(--dv-text);
      margin: 16px 0 12px 0;
      padding-left: 8px;
      border-left: 3px solid var(--dv-vio);
    }

    /* Option Tiles */
    .option-tiles {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
      gap: 8px;
    }

    .option-tile {
      background: var(--dv-surface);
      border: none;
      border-radius: var(--dv-radius-md);
      padding: 12px;
      cursor: pointer;
      transition: all .15s ease;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      position: relative;
    }

    .option-tile:hover {
      background: var(--dv-surface2);
    }

    .option-tile.active {
      background: var(--dv-accent-muted);
      outline: 2px solid var(--dv-accent);
      outline-offset: -2px;
    }

    .tile-preview {
      width: 48px;
      height: 48px;
      border-radius: var(--dv-radius-xs);
      background: rgba(255, 255, 255, .05);
      border: 1px solid var(--dv-stroke);
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      z-index: 1;
    }

    /* Window Preview Shapes */
    .window-preview {
      width: 32px;
      height: 24px;
      background: rgba(255, 255, 255, .1);
      border: 1px solid var(--dv-stroke2);
    }

    .window-preview.rounded-soft {
      border-radius: 16px;
    }

    .window-preview.rounded-medium {
      border-radius: 12px;
    }

    .window-preview.rounded-hard {
      border-radius: 4px;
    }

    /* Bubble Preview Shapes */
    .bubble-preview {
      width: 32px;
      height: 20px;
      background: rgba(168, 85, 247, .3);
      border: 1px solid var(--dv-vio);
    }

    .bubble-preview.pill {
      border-radius: 20px;
    }

    .bubble-preview.rounded {
      border-radius: 12px;
    }

    .bubble-preview.compact {
      border-radius: 6px;
      width: 28px;
    }

    /* Animation Preview */
    .animation-preview {
      width: 32px;
      height: 24px;
      background: linear-gradient(90deg, rgba(168, 85, 247, .3), rgba(96, 165, 250, .3));
      border-radius: var(--dv-radius-xs);
      position: relative;
      overflow: hidden;
    }

    .animation-preview.fade::after {
      content: "";
      position: absolute;
      inset: 0;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, .3), transparent);
      animation: dvShimmer 1.5s infinite;
    }

    .animation-preview.slide::after {
      content: "";
      position: absolute;
      inset: 0;
      background: linear-gradient(90deg, transparent 0%, rgba(255, 255, 255, .2) 50%, transparent 100%);
      animation: dvShimmer 2s infinite var(--dv-ease);
    }

    @keyframes dvShimmer {
      0% {
        transform: translateX(-100%);
      }

      100% {
        transform: translateX(100%);
      }
    }

    .tile-label {
      font-size: 11px;
      font-weight: 700;
      color: var(--dv-muted);
      text-align: center;
      letter-spacing: 0.02em;
      position: relative;
      z-index: 1;
    }

    .option-tile.active .tile-label {
      color: var(--dv-text);
      font-weight: 800;
    }

    /* Sliders */
    .slider-group {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .slider-container {
      position: relative;
    }

    .slider-container label {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      font-size: 13px;
      font-weight: 700;
      color: var(--dv-text);
    }

    .slider-value {
      font-size: 12px;
      font-weight: 800;
      color: var(--dv-vio);
      background: rgba(168, 85, 247, .1);
      padding: 4px 10px;
      border-radius: var(--dv-radius-pill);
      border: 1px solid rgba(168, 85, 247, .3);
    }

    .slider {
      -webkit-appearance: none;
      appearance: none;
      width: 100%;
      height: 6px;
      border-radius: var(--dv-radius-pill);
      background: linear-gradient(90deg, var(--dv-vio), var(--dv-blue));
      outline: none;
      cursor: pointer;
      position: relative;
    }

    .slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: var(--dv-text);
      border: 2px solid var(--dv-vio);
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(0, 0, 0, .5);
      transition: all var(--dv-transition-fast);
    }

    .slider::-webkit-slider-thumb:hover {
      transform: scale(1.15);
      box-shadow: 0 6px 18px rgba(0, 0, 0, .6), 0 0 0 3px rgba(168, 85, 247, .2);
    }

    .slider::-moz-range-thumb {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: var(--dv-text);
      border: 2px solid var(--dv-vio);
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(0, 0, 0, .5);
    }

    /* Form Elements */
    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-size: 13px;
      font-weight: 700;
      color: var(--dv-text);
    }

    .font-select {
      width: 100%;
      height: 36px;
      padding: 0 12px;
      border-radius: var(--dv-radius-sm);
      border: none;
      background: var(--dv-surface);
      color: var(--dv-text);
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      appearance: none;
      -webkit-appearance: none;
      background-image:
        linear-gradient(45deg, transparent 50%, var(--dv-muted) 50%),
        linear-gradient(135deg, var(--dv-muted) 50%, transparent 50%);
      background-position:
        calc(100% - 12px) 14px,
        calc(100% - 8px) 14px;
      background-size: 5px 5px, 5px 5px;
      background-repeat: no-repeat;
      transition: background .15s ease;
    }

    .font-select:hover {
      background: var(--dv-surface2);
    }

    .font-select:focus {
      outline: 2px solid var(--dv-accent);
      outline-offset: -2px;
    }

    /* Toggles */
    .toggle-group {
      margin: 24px 0;
    }

    .toggle {
      display: flex;
      align-items: center;
      gap: 12px;
      cursor: pointer;
    }

    .toggle input {
      display: none;
    }

    .toggle-slider {
      width: 36px;
      height: 20px;
      background: var(--dv-surface2);
      border: none;
      border-radius: var(--dv-radius-pill);
      position: relative;
      transition: background .15s ease;
      cursor: pointer;
    }

    .toggle-slider::before {
      content: "";
      position: absolute;
      width: 14px;
      height: 14px;
      background: var(--dv-muted);
      border-radius: 50%;
      top: 3px;
      left: 3px;
      transition: all .2s ease;
    }

    .toggle input:checked+.toggle-slider {
      background: var(--dv-accent);
    }

    .toggle input:checked+.toggle-slider::before {
      background: #fff;
      transform: translateX(16px);
    }

    .toggle-label {
      font-size: 13px;
      font-weight: 600;
      color: var(--dv-text);
    }

    /* Color Tiles */
    .color-tiles-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
      margin-bottom: 16px;
    }

    .color-tile {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      padding: 8px;
      border-radius: var(--dv-radius-md);
      cursor: pointer;
      border: none;
      background: var(--dv-surface);
      transition: all .15s ease;
      position: relative;
      overflow: visible;
    }

    .color-tile:hover {
      transform: scale(1.1);
      outline: 2px solid var(--dv-accent);
      outline-offset: 2px;
    }

    .color-tile::before {
      content: "";
      position: absolute;
      inset: 0;
      background: var(--dv-grad);
      opacity: 0;
      transition: opacity var(--dv-transition-med);
    }

    .color-tile:hover {
      transform: translateY(-2px);
      border-color: var(--dv-stroke2);
      box-shadow: 0 4px 12px rgba(0, 0, 0, .3);
    }

    .color-tile.active {
      border-color: var(--dv-accent);
      box-shadow: 0 0 12px rgba(139, 92, 246, .3);
    }

    .color-tile.active::before {
      opacity: 0.2;
    }

    .color-preview {
      width: 32px;
      height: 32px;
      border-radius: var(--dv-radius-sm);
      box-shadow: inset 0 2px 4px rgba(0, 0, 0, .3);
      border: 2px solid rgba(255, 255, 255, .1);
      position: relative;
      z-index: 1;
      flex-shrink: 0;
    }

    .color-tile.active .color-preview {
      border-color: rgba(255, 255, 255, .5);
      box-shadow: 0 0 12px rgba(168, 85, 247, .4), inset 0 2px 4px rgba(0, 0, 0, .3);
    }

    .color-label {
      font-size: 10px;
      font-weight: 600;
      color: var(--dv-muted);
      text-align: center;
      position: relative;
      z-index: 1;
      white-space: nowrap;
      max-width: 100%;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .color-tile.active .color-label {
      color: var(--dv-text);
      font-weight: 700;
    }

    .color-tile.active .color-label {
      color: var(--dv-text);
      font-weight: 800;
    }

    /* ========== PRESET TOOLBAR - INLINE, NO CARD ========== */
    .preset-bar {
      display: flex;
      align-items: center;
      height: 36px;
      background: transparent;
      border-bottom: 1px solid var(--dv-divider);
      gap: 0;
      padding: 0 16px;
      position: sticky;
      top: 0;
      z-index: 10;
      flex-shrink: 0;
    }

    .preset-segment {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0 12px;
      height: 100%;
      font-size: 11px;
      font-weight: 500;
      letter-spacing: 0.02em;
      color: var(--dv-muted);
      cursor: pointer;
      transition: all .15s ease;
      user-select: none;
      border-radius: 0;
      background: transparent;
      border: none;
      border-bottom: 2px solid transparent;
      margin-bottom: -1px;
    }

    .preset-segment:hover {
      color: var(--dv-text);
      background: rgba(255, 255, 255, 0.03);
    }

    .preset-segment.active {
      color: var(--dv-text);
      font-weight: 600;
      border-bottom-color: var(--dv-accent);
    }

    .preset-segment:first-child {
      display: none;
    }

    /* Overlay dla tła chatu */
    .chat-background-overlay {
      position: absolute;
      inset: 0;
      z-index: 0;
      pointer-events: none;
      transition: background-color var(--dv-transition-med);
    }

    /* Nowe opcje dla tła */
    .bg-options {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-bottom: 16px;
    }

    .bg-option {
      border-radius: var(--dv-radius-sm);
      overflow: hidden;
      cursor: pointer;
      border: 2px solid transparent;
      transition: all var(--dv-transition-med);
      position: relative;
    }

    .bg-option.active {
      border-color: var(--dv-accent);
      box-shadow: 0 0 12px rgba(139, 92, 246, .3);
    }

    .bg-option-preview {
      height: 60px;
      background-size: cover;
      background-position: center;
    }

    .bg-option-label {
      padding: 8px;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      font-size: 11px;
      text-align: center;
      font-weight: 600;
    }

    /* ========== SINGLE ROW ELEMENTS - ELASTIC SCALING ========== */

    /* Desktop Chat Preview - widget po lewej */
    .work-column {
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      flex-shrink: 0;
      height: 100%;
      width: clamp(280px, 22vw, 380px);
      padding: 16px;
    }

    .chat-scale {
      transform: none;
      transform-origin: center center;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .work-column .work-chat {
      width: 100%;
      height: 100%;
      max-width: 340px;
      max-height: 580px;
      border-radius: 20px;
      box-shadow: 
        0 0 0 1px rgba(255, 255, 255, 0.08),
        0 8px 32px rgba(0, 0, 0, 0.4),
        0 2px 8px rgba(0, 0, 0, 0.2);
      transition: all 0.3s ease;
    }

    .work-column .work-chat:hover {
      box-shadow: 
        0 0 0 1px rgba(255, 255, 255, 0.12),
        0 12px 48px rgba(0, 0, 0, 0.5),
        0 4px 12px rgba(0, 0, 0, 0.3);
      transform: translateY(-2px);
    }

    /* Mobile Phone - widget z ramka telefonu */
    .mobile-column {
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      height: 100%;
      width: clamp(260px, 20vw, 340px);
      padding: 16px;
    }

    .phone-scale {
      transform: none;
      transform-origin: center center;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* ========== MONITOR WRAPPER - KONTENER NA MONITOR ========== */
    .monitor-wrapper {
      flex: 1 1 auto;
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100%;
      min-height: 0;
      padding: 16px;
    }

    /* ========== MONITOR FRAME - PROSTY 16:9 ========== */
    .monitor-frame {
      position: relative;
      width: min(100%, 640px);
      max-width: 100%;
      aspect-ratio: 16 / 9;
      margin: 0 auto;
      background: linear-gradient(162deg, #090d13 0%, #0d1118 48%, #141829 100%);
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      overflow: hidden;
      box-shadow: 0 18px 40px rgba(0, 0, 0, 0.45);
    }

    .monitor-screen {
      position: absolute;
      inset: 0;
      overflow: hidden;
      background: linear-gradient(135deg, #0d0d0d 0%, #171717 100%);
    }

    .monitor-viewport {
      position: absolute;
      width: 1920px;
      height: 1080px;
      transform-origin: top left;
      background: transparent;
    }

    /* Chat inside monitor - pozycja prawy dolny rog */
    .monitor-chat {
      position: absolute;
      width: 380px;
      height: 520px;
      right: 40px;
      bottom: 40px;
      border-radius: 16px;
      box-shadow: 
        0 0 0 1px rgba(255, 255, 255, 0.1),
        0 8px 32px rgba(0, 0, 0, 0.6);
      transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .monitor-chat.minimized {
      display: none;
    }

    /* Minimized icon - pozycja lewy dolny */
    .monitor-icon {
      position: absolute;
      left: 40px;
      bottom: 40px;
      display: none;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .monitor-icon:hover {
      transform: scale(1.05);
    }

    .monitor-icon.visible {
      display: flex;
    }

    /* DEPRECATED - old classes kept for compatibility */
    .monitor-column {
      display: block;
    }

    .desktop-monitor-wrapper {
      display: block;
    }

    .desktop-monitor-label {
      display: none;
    }

    .desktop-monitor {
      display: block;
    }

    .desktop-monitor-stand {
      display: none;
    }

    /* DEPRECATED - Remove old sections */
    .top-section {
      display: block;
    }

    .bottom-section {
      display: none;
    }

    /* ========== MOBILE IPHONE FRAME - elegancka ramka ========== */
    .iphone-frame {
      width: 100%;
      height: 100%;
      max-width: 280px;
      max-height: 560px;
      background: linear-gradient(145deg, #1c1c1e 0%, #0a0a0a 100%);
      border-radius: 40px;
      border: 3px solid #3a3a3c;
      position: relative;
      overflow: hidden;
      box-shadow: 
        0 0 0 1px rgba(255, 255, 255, 0.05),
        0 20px 60px rgba(0, 0, 0, 0.5),
        inset 0 1px 0 rgba(255, 255, 255, 0.1);
      padding: 12px;
    }

    /* Boczne przyciski telefonu */
    .iphone-frame::before {
      content: "";
      position: absolute;
      right: -4px;
      top: 100px;
      width: 4px;
      height: 60px;
      background: #3a3a3c;
      border-radius: 0 2px 2px 0;
    }

    .iphone-frame::after {
      content: "";
      position: absolute;
      left: -4px;
      top: 80px;
      width: 4px;
      height: 30px;
      background: #3a3a3c;
      border-radius: 2px 0 0 2px;
      box-shadow: 0 50px 0 #3a3a3c;
    }

    .iphone-screen {
      width: 100%;
      height: 100%;
      background: var(--dv-bg);
      border-radius: 32px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      position: relative;
    }

    /* Dynamic Island wewnatrz ekranu */
    .iphone-screen::before {
      content: "";
      position: absolute;
      top: 12px;
      left: 50%;
      transform: translateX(-50%);
      width: 80px;
      height: 24px;
      background: #000;
      border-radius: 12px;
      z-index: 10;
    }

    /* Home indicator */
    .iphone-screen::after {
      content: "";
      position: absolute;
      bottom: 8px;
      left: 50%;
      transform: translateX(-50%);
      width: 100px;
      height: 4px;
      background: rgba(255, 255, 255, 0.3);
      border-radius: 2px;
      z-index: 10;
    }

    /* Mobile minimized icon - BOTTOM-LEFT of phone screen */
    .mobile-icon {
      position: absolute;
      left: 16px;
      bottom: 24px;
      display: none;
      z-index: 5;
    }

    .mobile-icon.visible {
      display: flex;
    }

    /* DEPRECATED - Remove old split preview styles */
    .preview-workspace {
      display: none;
    }

    .split-preview {
      display: none;
    }

    .preview-column {
      display: none;
    }

    .work-preview-column {
      display: none;
    }

    .device-preview-column {
      display: block;
    }

    /* ========== MONITOR CHAT - REAL PIXEL DIMENSIONS ========== */
    #monitorChat {
      width: 380px;
      height: 520px;
      background: var(--dv-bg);
      border-radius: 16px;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      box-shadow: 
        0 0 0 1px rgba(255, 255, 255, 0.1),
        0 12px 40px rgba(0, 0, 0, 0.5);
      border: none;
    }

    #monitorChat .chat-header {
      padding: 12px 14px;
      background: rgba(255, 255, 255, .03);
      border-bottom: 1px solid rgba(255, 255, 255, .06);
    }

    #monitorChat .chat-avatar {
      width: 28px;
      height: 28px;
      font-size: 12px;
    }

    #monitorChat .chat-name {
      font-size: 13px;
    }

    #monitorChat .chat-status {
      font-size: 10px;
    }

    #monitorChat .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    #monitorChat .message-content {
      padding: 10px 14px;
      font-size: 13px;
      border-radius: 14px;
    }

    #monitorChat .chat-input {
      padding: 10px 12px;
    }

    #monitorChat .chat-input input {
      height: 36px;
      font-size: 13px;
      border-radius: 18px;
    }

    #monitorChat .send-btn {
      width: 36px;
      height: 36px;
      font-size: 14px;
    }

    #monitorChat .quick-replies-bottom {
      padding: 8px 12px;
    }

    #monitorChat .quick-replies-bottom button {
      padding: 6px 12px;
      font-size: 11px;
      border-radius: 12px;
    }

    #monitorChat .chat-watermark {
      padding: 6px;
      font-size: 9px;
    }

    /* ========== TRUE NATIVE MOBILE CHAT UI ========== */
    /* Mobile chat - ten sam styl co widget po lewej */

    .mobile-chat-root {
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      background: var(--dv-bg);
      padding-top: 44px; /* Przestrzen na Dynamic Island */
    }

    .mobile-header {
      height: 52px;
      display: flex;
      align-items: center;
      padding: 0 14px;
      background: rgba(255, 255, 255, .03);
      border-bottom: 1px solid rgba(255, 255, 255, .06);
      flex-shrink: 0;
    }

    .mobile-header-brand {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .mobile-header-avatar {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: rgba(168, 85, 247, 0.2);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      color: var(--dv-vio);
    }

    .mobile-header-info {
      display: flex;
      flex-direction: column;
    }

    .mobile-header-name {
      font-size: 13px;
      font-weight: 600;
      color: inherit;
    }

    .mobile-header-status {
      font-size: 10px;
      color: inherit;
      opacity: 0.7;
    }

    .mobile-messages {
      flex: 1;
      overflow-y: auto;
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      scrollbar-width: thin;
      scrollbar-color: rgba(255, 255, 255, 0.1) transparent;
    }

    .mobile-message {
      max-width: 85%;
      display: flex;
      flex-direction: column;
    }

    .mobile-message.bot {
      align-self: flex-start;
    }

    .mobile-message.user {
      align-self: flex-end;
    }

    .mobile-message-content {
      padding: 10px 14px;
      border-radius: 16px;
      font-size: 13px;
      line-height: 1.4;
    }

    .mobile-message.bot .mobile-message-content {
      background: rgba(255, 255, 255, .08);
      border-bottom-left-radius: 4px;
    }

    .mobile-message.user .mobile-message-content {
      background: rgba(139, 92, 246, .15);
      border-bottom-right-radius: 4px;
    }

    .mobile-input-bar {
      height: 56px;
      display: flex;
      align-items: center;
      padding: 8px 10px 16px;
      gap: 8px;
      background: rgba(255, 255, 255, .02);
      border-top: 1px solid rgba(255, 255, 255, .06);
      flex-shrink: 0;
    }

    .mobile-input {
      flex: 1;
      height: 36px;
      border-radius: 18px;
      padding: 0 14px;
      border: 1px solid rgba(255, 255, 255, .1);
      background: rgba(255, 255, 255, .05);
      color: var(--dv-text);
      font-size: 13px;
    }

    .mobile-input:focus {
      outline: none;
      border-color: var(--dv-accent);
      background: rgba(255, 255, 255, .08);
    }

    .mobile-send-button {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: var(--dv-vio);
      border: none;
      color: #fff;
      font-size: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s ease;
      flex-shrink: 0;
    }

    .mobile-send-button:hover {
      background: var(--dv-accent-hover);
      transform: scale(1.05);
    }

    .mobile-send-button:active {
      transform: scale(0.95);
    }

    .mobile-quick-replies {
      display: flex;
      gap: 6px;
      padding: 6px 10px;
      flex-wrap: wrap;
      background: rgba(255, 255, 255, .02);
      border-top: 1px solid rgba(255, 255, 255, .06);
    }

    .mobile-quick-replies button {
      padding: 6px 12px;
      border-radius: 14px;
      background: rgba(255, 255, 255, .06);
      color: var(--dv-text);
      border: 1px solid rgba(255, 255, 255, .1);
      font-size: 11px;
      font-weight: 500;
      cursor: pointer;
    }

    .mobile-quick-replies button:hover {
      background: rgba(255, 255, 255, .1);
    }

    .mobile-watermark {
      display: none;
    }

    /* Minimized icon na telefonie */
    .mobile-icon {
      position: absolute;
      left: 16px;
      bottom: 32px;
      display: none;
      z-index: 5;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .mobile-icon:hover {
      transform: scale(1.05);
    }

    .mobile-icon.visible {
      display: flex;
    }

    /* ========== MOBILE CHAT - MOBILE-FIRST UI ========== */
    .mobile-chat-clone {
      display: flex;
      flex-direction: column;
      height: 100%;
      background: var(--dv-bg);
      overflow: hidden;
      font-size: 15px;
      padding-top: 40px;
      /* Space for dynamic island */
    }

    .mobile-chat-clone.minimized {
      display: none;
    }

    .mobile-chat-clone .chat-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 18px;
      background: rgba(255, 255, 255, .03);
      border-bottom: 1px solid rgba(255, 255, 255, .06);
    }

    .mobile-chat-clone .chat-brand {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .mobile-chat-clone .chat-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: rgba(168, 85, 247, 0.2);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      color: var(--dv-vio);
    }

    .mobile-chat-clone .chat-name {
      font-size: 14px;
      font-weight: 600;
      color: inherit;
    }

    .mobile-chat-clone .chat-status {
      font-size: 11px;
      color: inherit;
      opacity: 0.7;
    }

    .mobile-chat-clone .close-btn {
      width: 32px;
      height: 32px;
      font-size: 16px;
      border-radius: 10px;
      background: rgba(255, 255, 255, .06);
      border: 1px solid rgba(255, 255, 255, .08);
    }

    .mobile-chat-clone .chat-messages {
      flex: 1;
      padding: 18px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      overflow-y: auto;
    }

    .mobile-chat-clone .message {
      max-width: 85%;
      margin-bottom: 4px;
    }

    .mobile-chat-clone .message-content {
      padding: 14px 18px;
      border-radius: 20px;
      font-size: 15px;
      line-height: 1.5;
    }

    .mobile-chat-clone .message.bot {
      align-self: flex-start;
    }

    .mobile-chat-clone .message.bot .message-content {
      background: rgba(255, 255, 255, .08);
      border: 1px solid rgba(255, 255, 255, .08);
      border-bottom-left-radius: 6px;
    }

    .mobile-chat-clone .message.user {
      align-self: flex-end;
    }

    .mobile-chat-clone .message.user .message-content {
      background: rgba(139, 92, 246, .2);
      border: 1px solid rgba(139, 92, 246, .3);
      border-bottom-right-radius: 6px;
    }

    .mobile-chat-clone .chat-input {
      display: flex;
      gap: 12px;
      padding: 16px 16px 32px;
      background: rgba(255, 255, 255, .02);
      border-top: 1px solid rgba(255, 255, 255, .06);
    }

    .mobile-chat-clone .chat-input input {
      flex: 1;
      height: 52px;
      padding: 0 20px;
      border-radius: 26px;
      border: 1px solid rgba(255, 255, 255, .12);
      background: rgba(255, 255, 255, .08);
      color: var(--dv-text);
      font-size: 16px;
    }

    .mobile-chat-clone .send-btn {
      width: 52px;
      height: 52px;
      border-radius: 26px;
      background: var(--dv-vio);
      border: none;
      color: #fff;
      font-size: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .mobile-chat-clone .chat-watermark {
      display: none;
      /* Hidden on mobile */
    }

    .mobile-chat-clone .quick-replies-bottom {
      display: flex;
      gap: 8px;
      padding: 10px 14px;
      flex-wrap: wrap;
    }

    .mobile-chat-clone .quick-replies-bottom button {
      padding: 10px 16px;
      border-radius: 20px;
      background: rgba(255, 255, 255, .08);
      color: var(--dv-text);
      border: 1px solid rgba(255, 255, 255, .12);
      font-size: 13px;
      font-weight: 500;
    }

    /* Clone chat styles for device previews */
    .device-chat-clone {
      display: flex;
      flex-direction: column;
      height: 100%;
      background: var(--dv-bg);
      overflow: hidden;
    }

    .device-chat-clone .chat-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 6px 10px;
      background: rgba(255, 255, 255, .02);
      border-bottom: 1px solid rgba(255, 255, 255, .04);
    }

    .device-chat-clone .chat-brand {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .device-chat-clone .chat-avatar {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: rgba(168, 85, 247, 0.2);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 8px;
      color: var(--dv-vio);
    }

    .device-chat-clone .chat-name {
      font-size: 10px;
      font-weight: 500;
      color: inherit;
    }

    .device-chat-clone .chat-status {
      font-size: 8px;
      color: inherit;
      opacity: 0.7;
    }

    .device-chat-clone .chat-messages {
      flex: 1;
      padding: 8px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      overflow-y: auto;
    }

    .device-chat-clone .message {
      max-width: 85%;
      margin-bottom: 4px;
    }

    .device-chat-clone .message-content {
      padding: 6px 10px;
      border-radius: 8px;
      font-size: 10px;
      line-height: 1.4;
    }

    .device-chat-clone .message.bot {
      align-self: flex-start;
    }

    .device-chat-clone .message.bot .message-content {
      background: rgba(255, 255, 255, .06);
      border: 1px solid rgba(255, 255, 255, .08);
    }

    .device-chat-clone .message.user {
      align-self: flex-end;
    }

    .device-chat-clone .message.user .message-content {
      background: rgba(255, 255, 255, .08);
      border: 1px solid rgba(255, 255, 255, .10);
    }

    .device-chat-clone .chat-input {
      display: flex;
      gap: 6px;
      padding: 6px 8px;
      background: rgba(255, 255, 255, .02);
      border-top: 1px solid rgba(255, 255, 255, .04);
    }

    .device-chat-clone .chat-input input {
      flex: 1;
      height: 24px;
      padding: 0 8px;
      border-radius: 4px;
      border: 1px solid rgba(255, 255, 255, .06);
      background: rgba(255, 255, 255, .04);
      color: var(--dv-text);
      font-size: 10px;
    }

    .device-chat-clone .send-btn {
      width: 24px;
      height: 24px;
      border-radius: 4px;
      background: rgba(255, 255, 255, .08);
      border: none;
      color: var(--dv-muted);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
    }

    .device-chat-clone .chat-watermark {
      padding: 4px;
      text-align: center;
      font-size: 8px;
      color: var(--dv-muted2);
    }

    .device-chat-clone .quick-replies-bottom {
      display: flex;
      gap: 4px;
      padding: 4px 8px;
      flex-wrap: wrap;
    }

    .device-chat-clone .quick-replies-bottom button {
      padding: 3px 8px;
      border-radius: 4px;
      background: rgba(255, 255, 255, .06);
      color: var(--dv-muted);
      border: 1px solid rgba(255, 255, 255, .08);
      font-size: 9px;
    }

    /* Preview Headers - HIDDEN */
    .preview-header {
      display: none;
    }

    /* Work Preview Column */
    .work-preview-column {
      height: 600px;
    }

    /* Preview Containers - transparentne, obrazek widoczny */
    .work-preview {
      flex: 1;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 16px;
      position: relative;
      overflow: auto;
      background: transparent;
    }

    .device-preview {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 20px;
      gap: 16px;
      overflow: auto;
      background: transparent;
      align-items: center;
      justify-content: flex-start;
      padding-top: 24px;
      padding-bottom: 40px;
    }

    /* Device Controls - HIDDEN */
    .device-controls {
      display: none;
    }

    .device-btn {
      flex: 1;
      padding: 6px 14px;
      border-radius: var(--dv-radius-sm);
      border: none;
      background: transparent;
      color: var(--dv-muted);
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      transition: all .15s ease;
    }

    .device-btn.active {
      background: var(--dv-accent);
      color: white;
    }

    .device-btn:hover:not(.active) {
      color: var(--dv-text);
    }

    /* Info o skali - HIDDEN */
    .scale-info-container {
      display: none !important;
    }

    /* Viewport */
    .viewport {
      width: 100%;
      height: 100%;
      position: relative;
      background: transparent;
      border-radius: 4px;
      overflow: hidden;
      z-index: 1;
    }

    /* Virtual Desktop - neutral background */
    .virtual-desktop {
      position: relative;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #1a1a1a 0%, #0f0f0f 100%);
      z-index: 1;
    }

    /* Device Inner */
    .device-inner {
      width: 100%;
      height: 100%;
      position: relative;
      border-radius: 4px;
      background: transparent;
    }

    /* Chat w monitorze - calmer, integrated */
    .device-chat {
      position: absolute !important;
      z-index: 3;
      transition: all 0.2s ease;
      will-change: transform, width, height;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.2);
      background: #1f1f1f;
      border-radius: var(--dv-radius-md);
      border: 1px solid rgba(255, 255, 255, .06);
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    /* Pozycje chatu w virtual desktop - margines od krawędzi monitora */
    .device-chat.chat-position-bottom-left {
      left: 20px !important;
      bottom: 20px !important;
      right: auto !important;
      top: auto !important;
    }

    .device-chat.chat-position-bottom-right {
      right: 20px !important;
      bottom: 20px !important;
      left: auto !important;
      top: auto !important;
    }

    .device-chat.chat-position-top-left {
      left: 20px !important;
      top: 20px !important;
      right: auto !important;
      bottom: auto !important;
    }

    .device-chat.chat-position-top-right {
      right: 20px !important;
      top: 20px !important;
      left: auto !important;
      bottom: auto !important;
    }

    /* Overlay z informacją o skali (hover) */
    .scale-overlay {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 10px 15px;
      border-radius: 8px;
      font-size: 12px;
      font-family: var(--dv-font-mono);
      z-index: 5;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.3s;
      border: 1px solid rgba(255, 255, 255, 0.2);
      text-align: center;
      min-width: 180px;
    }

    .device-inner:hover .scale-overlay {
      opacity: 1;
    }

    .scale-dimensions {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 5px;
      margin-bottom: 3px;
    }

    .dimension {
      color: #60a5fa;
      font-weight: bold;
    }

    .separator {
      color: #a855f7;
    }

    .scale-percent {
      color: #fb7185;
      font-size: 11px;
      text-align: center;
    }

    /* ========== CHAT ICON (COLLAPSED STATE) ========== */
    .chat-icon-button {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: var(--dv-grad);
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 20px rgba(124, 58, 237, 0.4), 0 8px 32px rgba(0, 0, 0, 0.3);
      transition: all var(--dv-transition-med);
      position: relative;
      z-index: 10;
    }

    .chat-icon-button:hover {
      transform: scale(1.08);
      box-shadow: 0 6px 28px rgba(124, 58, 237, 0.5), 0 12px 40px rgba(0, 0, 0, 0.4);
    }

    .chat-icon-button i {
      font-size: 24px;
      color: #fff;
    }

    .chat-icon-button img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: inherit;
    }

    .chat-icon-button.shape-circle {
      border-radius: 50%;
    }

    .chat-icon-button.shape-rounded {
      border-radius: 16px;
    }

    .chat-icon-button.shape-square {
      border-radius: 8px;
    }

    /* Pulsująca animacja dla ikony */
    .chat-icon-button::after {
      content: "";
      position: absolute;
      inset: -4px;
      border-radius: inherit;
      background: var(--dv-grad);
      opacity: 0;
      z-index: -1;
      animation: iconPulse 2s ease-in-out infinite;
    }

    @keyframes iconPulse {

      0%,
      100% {
        opacity: 0;
        transform: scale(1);
      }

      50% {
        opacity: 0.3;
        transform: scale(1.15);
      }
    }

    /* ========== CHAT WINDOWS ========== */
    /* WORK CHAT - UX Preview (style reflection only) */
    .work-chat {
      background: var(--dv-bg);
      border-radius: 20px;
      border: 1px solid rgba(255, 255, 255, .08);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      box-shadow:
        0 8px 32px rgba(0, 0, 0, .4),
        0 2px 8px rgba(0, 0, 0, .2);
      position: relative;
      /* Flexible size for UX preview */
      width: 340px;
      height: 500px;
      transition: all var(--dv-transition-med);
    }

    .work-chat::before {
      content: none;
      display: none;
    }

    /* PRAWY CHAT - DEVICE CHAT (SYMULACJA STRONY) */
    .device-chat {
      background: var(--dv-bg);
      border-radius: var(--dv-radius-lg);
      border: 1px solid var(--dv-stroke);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      box-shadow: 0 4px 12px rgba(0, 0, 0, .3);
      position: relative;
      transition: all var(--dv-transition-med);
      /* ROZMIARY ZALEŻNE OD SUWAKÓW */
    }

    /* Chat Header - slim */
    .chat-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 6px 10px;
      background: rgba(255, 255, 255, .02);
      border-bottom: 1px solid rgba(255, 255, 255, .04);
      position: relative;
      z-index: 1;
    }

    .chat-brand {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .chat-avatar {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: rgba(255, 255, 255, .08);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      overflow: hidden;
      font-size: 10px;
    }

    .chat-info {
      display: flex;
      flex-direction: column;
      gap: 2px;
      min-width: 0;
    }

    .chat-name {
      font-size: 11px;
      font-weight: 500;
      color: inherit;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .chat-status {
      font-size: 10px;
      font-weight: 500;
      color: inherit;
      opacity: 0.7;
      letter-spacing: 0.01em;
      text-transform: none;
    }

    .chat-actions {
      display: flex;
      gap: 8px;
    }

    /* Three-dot menu button - HIDDEN */
    .icon-btn {
      display: none;
    }

    /* Close Button X */
    /* Close Button - larger, cleaner, more rounded */
    .close-btn {
      width: 36px;
      height: 36px;
      border-radius: 12px;
      background: rgba(255, 255, 255, .06);
      border: 1px solid rgba(255, 255, 255, .1);
      color: inherit;
      opacity: 0.7;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      font-size: 16px;
    }

    .close-btn:hover {
      background: rgba(255, 80, 80, .15);
      border-color: rgba(255, 80, 80, .25);
      color: #ff6b6b;
      transform: scale(1.05);
    }

    /* ========== CHAT ICON (MINIMIZED STATE) ========== */
    .chat-icon {
      width: 56px;
      height: 56px;
      border-radius: 16px;
      background: var(--dv-grad);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow:
        0 6px 24px rgba(139, 92, 246, 0.4),
        0 2px 8px rgba(0, 0, 0, 0.3);
      transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
      color: #fff;
      font-size: 22px;
    }

    .chat-icon:hover {
      transform: scale(1.08) translateY(-2px);
      box-shadow:
        0 10px 32px rgba(139, 92, 246, 0.5),
        0 4px 12px rgba(0, 0, 0, 0.4);
    }

    .chat-icon:active {
      transform: scale(0.98);
    }

    /* Small variant for previews */
    .chat-icon.small {
      width: 48px;
      height: 48px;
      border-radius: 14px;
      font-size: 18px;
    }

    .close-btn:hover {
      background: rgba(255, 59, 48, 0.2);
      color: #FF3B30;
      border-color: rgba(255, 59, 48, 0.3);
    }

    /* Quick Replies - slim, neutral */
    .quick-replies-top {
      display: flex;
      gap: 6px;
      padding: 6px 10px;
      flex-wrap: wrap;
      border-bottom: 1px solid rgba(255, 255, 255, .04);
      background: transparent;
    }

    .quick-replies-bottom {
      display: flex;
      gap: 6px;
      padding: 6px 10px;
      flex-wrap: wrap;
      border-top: 1px solid rgba(255, 255, 255, .04);
      background: transparent;
    }

    .quick-replies-top button,
    .quick-replies-bottom button {
      padding: 4px 10px;
      border-radius: var(--dv-radius-xs);
      background: rgba(255, 255, 255, .06);
      color: var(--dv-muted);
      border: 1px solid rgba(255, 255, 255, .08);
      cursor: pointer;
      font-size: 11px;
      transition: all var(--dv-transition-fast);
      font-weight: 500;
    }

    .quick-replies-top button:hover,
    .quick-replies-bottom button:hover {
      background: rgba(255, 255, 255, .1);
      color: var(--dv-text);
    }

    /* Chat Messages - reduced spacing */
    .chat-messages {
      flex: 1;
      padding: 10px;
      overflow-y: auto;
      position: relative;
      z-index: 1;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .chat-messages::-webkit-scrollbar {
      width: 6px;
    }

    .chat-messages::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, .03);
      border-radius: var(--dv-radius-pill);
    }

    .chat-messages::-webkit-scrollbar-thumb {
      background: var(--dv-vio);
      border-radius: var(--dv-radius-pill);
    }

    .message {
      display: flex;
      flex-direction: column;
      margin-bottom: 4px;
      max-width: 85%;
      opacity: 1;
      animation-fill-mode: forwards;
    }

    .message.bot {
      align-items: flex-start;
      align-self: flex-start;
    }

    .message.user {
      align-items: flex-end;
      align-self: flex-end;
      margin-left: auto;
    }

    .message-content {
      padding: 12px 16px;
      border-radius: 18px;
      font-size: 13px;
      line-height: 1.5;
      font-weight: 400;
      color: var(--dv-text);
      position: relative;
      overflow: hidden;
      max-width: 100%;
      word-wrap: break-word;
    }

    .message.bot .message-content {
      background: rgba(255, 255, 255, .07);
      border: 1px solid rgba(255, 255, 255, .08);
      border-bottom-left-radius: 6px;
    }

    .message.user .message-content {
      background: rgba(139, 92, 246, .15);
      border: 1px solid rgba(139, 92, 246, .2);
      border-bottom-right-radius: 6px;
    }

    .message-time {
      font-size: 10px;
      color: var(--dv-muted2);
      margin-top: 4px;
      font-weight: 600;
      letter-spacing: 0.02em;
    }

    /* Chat Input - modern SaaS */
    .chat-input {
      display: flex;
      gap: 10px;
      padding: 12px 14px;
      background: rgba(255, 255, 255, .02);
      border-top: 1px solid rgba(255, 255, 255, .05);
      position: relative;
      z-index: 1;
    }

    .chat-input input {
      flex: 1;
      height: 40px;
      padding: 0 16px;
      border-radius: 20px;
      border: 1px solid rgba(255, 255, 255, .1);
      background: rgba(255, 255, 255, .05);
      color: var(--dv-text);
      font-size: 13px;
      font-weight: 400;
      transition: all 0.2s ease;
    }

    .chat-input input:focus {
      outline: none;
      border-color: var(--dv-accent);
      background: rgba(255, 255, 255, .08);
      box-shadow: 0 0 0 3px rgba(168, 85, 247, .15);
    }

    .chat-input input::placeholder {
      color: var(--dv-muted);
    }

    .send-btn {
      width: 40px;
      height: 40px;
      border-radius: 20px;
      background: var(--dv-vio);
      border: none;
      color: #fff;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      font-size: 14px;
    }

    .send-btn:hover {
      background: var(--dv-accent-hover);
      transform: scale(1.05);
    }

    .send-btn:active {
      transform: scale(0.95);
    }

    /* Watermark - slim, muted */
    .chat-watermark {
      padding: 4px 10px;
      text-align: center;
      font-size: 9px;
      color: var(--dv-muted2);
      font-weight: 400;
      letter-spacing: 0.01em;
      position: relative;
      z-index: 1;
    }

    .chat-watermark .watermark-brand {
      color: var(--dv-muted);
      font-weight: 500;
    }

    /* Chat font size variable */
    .work-chat,
    .device-chat {
      --chat-font-size: 12px;
    }

    .message-content,
    .chat-input input,
    .chat-name,
    .chat-status,
    .quick-replies-top button,
    .quick-replies-bottom button {
      font-size: var(--chat-font-size);
    }

    /* ========== POSITION TILES ========== */
    .position-tiles {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-top: 16px;
    }

    .position-tile {
      background: rgba(255, 255, 255, .03);
      border: 1px solid var(--dv-stroke);
      border-radius: var(--dv-radius-md);
      padding: 20px;
      cursor: pointer;
      transition: all var(--dv-transition-med);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 12px;
      position: relative;
      overflow: hidden;
      height: 100px;
    }

    .position-tile::before {
      content: "";
      position: absolute;
      inset: 0;
      background: var(--dv-grad);
      opacity: 0;
      transition: opacity var(--dv-transition-med);
    }

    .position-tile:hover {
      transform: translateY(-2px);
      border-color: var(--dv-stroke2);
      box-shadow: 0 4px 12px rgba(0, 0, 0, .3);
    }

    .position-tile.active {
      border-color: var(--dv-accent);
      box-shadow: 0 0 12px rgba(139, 92, 246, .3);
    }

    .position-tile.active::before {
      opacity: 0.1;
    }

    .position-preview {
      width: 60px;
      height: 40px;
      position: relative;
      border: 2px solid rgba(255, 255, 255, .2);
      border-radius: 6px;
    }

    .position-indicator {
      width: 16px;
      height: 16px;
      background: var(--dv-vio);
      border-radius: 50%;
      position: absolute;
      box-shadow: 0 0 8px rgba(168, 85, 237, 0.6);
    }

    /* Position indicators */
    .position-bottom-left .position-indicator {
      left: 6px;
      bottom: 6px;
    }

    .position-bottom-right .position-indicator {
      right: 6px;
      bottom: 6px;
    }

    .position-top-left .position-indicator {
      left: 6px;
      top: 6px;
    }

    .position-top-right .position-indicator {
      right: 6px;
      top: 6px;
    }

    .position-label {
      font-size: 11px;
      font-weight: 700;
      color: var(--dv-muted);
      text-align: center;
      letter-spacing: 0.02em;
      position: relative;
      z-index: 1;
    }

    .position-tile.active .position-label {
      color: var(--dv-text);
      font-weight: 800;
    }

    /* Color Editor Modal */
    .color-editor-modal {
      position: fixed;
      inset: 0;
      z-index: 10000;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(20px);
      opacity: 0;
      visibility: hidden;
      transition: opacity .2s ease, visibility .2s ease;
    }

    .color-editor-modal.show {
      opacity: 1;
      visibility: visible;
    }

    .modal-backdrop {
      position: absolute;
      inset: 0;
      background: transparent;
      cursor: pointer;
    }

    .modal-content {
      position: relative;
      z-index: 10001;
      background: rgba(30, 30, 30, .95);
      backdrop-filter: blur(20px);
      border-radius: var(--dv-radius-lg);
      border: 1px solid var(--dv-stroke);
      width: 100%;
      max-width: 400px;
      animation: dvSlideUp 0.2s ease;
      overflow: hidden;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 20px;
      border-bottom: 1px solid var(--dv-divider);
    }

    .modal-header h3 {
      font-size: 16px;
      font-weight: 800;
      color: var(--dv-text);
      margin: 0;
    }

    .modal-close {
      width: 32px;
      height: 32px;
      border-radius: var(--dv-radius-sm);
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid var(--dv-stroke);
      color: var(--dv-muted);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all var(--dv-transition-fast);
      font-size: 14px;
      line-height: 1;
    }

    .modal-close:hover {
      background: rgba(255, 255, 255, 0.08);
      color: var(--dv-text);
      border-color: var(--dv-stroke2);
    }

    .modal-body {
      padding: 24px;
    }

    .color-display {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-bottom: 24px;
    }

    .color-preview-large {
      width: 60px;
      height: 60px;
      border-radius: var(--dv-radius-md);
      border: 3px solid rgba(255, 255, 255, 0.2);
      box-shadow:
        inset 0 2px 8px rgba(0, 0, 0, 0.3),
        0 4px 16px rgba(0, 0, 0, 0.4);
    }

    .color-hex {
      font-family: var(--dv-font-mono);
      font-size: 18px;
      font-weight: 700;
      color: var(--dv-text);
      letter-spacing: 0.05em;
    }

    .color-controls {
      margin-bottom: 24px;
    }

    .color-controls label {
      display: block;
      margin-bottom: 10px;
      font-size: 13px;
      font-weight: 700;
      color: var(--dv-text);
    }

    .color-input {
      width: 100%;
      height: 40px;
      border-radius: var(--dv-radius-md);
      border: 1px solid var(--dv-stroke);
      background: rgba(255, 255, 255, 0.05);
      cursor: pointer;
    }

    .color-presets {
      margin-bottom: 16px;
    }

    .color-presets label {
      display: block;
      margin-bottom: 12px;
      font-size: 13px;
      font-weight: 700;
      color: var(--dv-text);
    }

    .preset-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .preset-grid-btn {
      width: 36px;
      height: 36px;
      border-radius: 8px;
      border: 2px solid transparent;
      cursor: pointer;
      margin: 4px;
      transition: all 0.2s ease;
    }

    .preset-grid-btn:hover {
      transform: scale(1.1);
    }

    .modal-footer {
      padding: 20px 24px;
      border-top: 1px solid var(--dv-stroke);
      display: flex;
      justify-content: flex-end;
      gap: 12px;
      background: rgba(255, 255, 255, 0.02);
    }

    /* Modal animations */
    @keyframes dvFadeIn {
      from {
        opacity: 0;
      }

      to {
        opacity: 1;
      }
    }

    @keyframes dvSlideUp {
      from {
        transform: translateY(20px);
        opacity: 0;
      }

      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    /* ========== AVATAR Z NAZWĄ ========== */
    .chat-brand-avatar {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .avatar-with-name {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
    }

    .avatar-preview-small {
      width: 36px;
      height: 36px;
      border-radius: var(--dv-radius-md);
      background-size: cover;
      background-position: center;
      border: 2px solid var(--dv-stroke);
    }

    .bot-name-input {
      width: 100%;
      margin-top: 12px;
      padding: 8px 12px;
      border-radius: var(--dv-radius-sm);
      border: 1px solid var(--dv-stroke);
      background: rgba(255, 255, 255, 0.05);
      color: var(--dv-text);
      font-size: 13px;
    }

    .bot-name-input:focus {
      outline: none;
      border-color: var(--dv-accent);
      box-shadow: 0 0 0 2px rgba(168, 85, 247, 0.15);
    }

    /* ========== AVATAR UPLOAD ========== */
    .avatar-upload-container {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-top: 16px;
      padding: 16px;
      background: rgba(255, 255, 255, 0.03);
      border-radius: var(--dv-radius-md);
      border: 1px solid var(--dv-stroke);
    }

    .avatar-upload-buttons {
      display: flex;
      gap: 8px;
    }

    .avatar-preview {
      width: 80px;
      height: 80px;
      border-radius: var(--dv-radius-md);
      background-size: cover;
      background-position: center;
      border: 1px solid var(--dv-stroke);
      overflow: hidden;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--dv-muted);
      font-size: 12px;
    }

    .avatar-preview.has-image {
      border: 2px solid var(--dv-vio);
      box-shadow: 0 0 12px rgba(139, 92, 246, .3);
    }

    .avatar-preview img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: inherit;
      display: block;
    }

    .avatar-preview i {
      font-size: 24px;
    }

    /* ========== UTILITY CLASSES ========== */
    .hidden {
      display: none !important;
    }

    /* ========== ANIMATION CLASSES ========== */
    @keyframes messageFadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes messageSlideIn {
      from {
        opacity: 0;
        transform: translateX(-20px);
      }

      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    @keyframes messagePopIn {
      from {
        opacity: 0;
        transform: scale(0.9);
      }

      to {
        opacity: 1;
        transform: scale(1);
      }
    }

    @keyframes messageTyping {
      0% {
        opacity: 0.3;
      }

      50% {
        opacity: 1;
      }

      100% {
        opacity: 0.3;
      }
    }

    .message.fade-animated {
      animation: messageFadeIn 0.3s ease forwards;
    }

    .message.slide-animated {
      animation: messageSlideIn 0.4s cubic-bezier(0.22, 0.61, 0.36, 1) forwards;
    }

    .message.pop-animated {
      animation: messagePopIn 0.35s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
    }

    .message.typing-animated {
      animation: messageTyping 1.5s infinite;
    }

    /* ========== RESPONSIVE - ELASTIC SCALING ========== */
    @media (max-width: 1400px) {
      #monitorFrame {
        width: min(100%, 560px);
      }
    }

    /* Background image upload */
    .bg-upload-container {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-top: 16px;
      padding: 16px;
      background: rgba(255, 255, 255, 0.03);
      border-radius: var(--dv-radius-md);
      border: 1px solid var(--dv-stroke);
    }

    .bg-upload-buttons {
      display: flex;
      gap: 8px;
    }

    .bg-preview {
      width: 100%;
      height: 80px;
      border-radius: var(--dv-radius-sm);
      background-size: cover;
      background-position: center;
      border: 1px solid var(--dv-stroke);
      margin-top: 8px;
      position: relative;
      overflow: hidden;
    }

    .bg-preview-overlay {
      position: absolute;
      inset: 0;
      background: rgba(0, 0, 0, 0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 11px;
      font-weight: 600;
    }

    /* Quick replies editor */
    .quick-reply-row {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
      align-items: center;
    }

    .quick-reply-row input {
      flex: 1;
      padding: 8px 12px;
      border-radius: var(--dv-radius-sm);
      border: 1px solid var(--dv-stroke);
      background: rgba(255, 255, 255, 0.05);
      color: var(--dv-text);
      font-size: 13px;
    }

    .quick-reply-row input:focus {
      outline: none;
      border-color: var(--dv-accent);
      box-shadow: 0 0 0 2px rgba(168, 85, 247, 0.15);
    }

    .quick-reply-row button {
      padding: 8px 12px;
      background: rgba(255, 59, 48, 0.2);
      color: #FF3B30;
      border: 1px solid rgba(255, 59, 48, 0.3);
      border-radius: var(--dv-radius-sm);
      cursor: pointer;
      font-weight: 600;
    }

    .quick-reply-row button:hover {
      background: rgba(255, 59, 48, 0.3);
    }

    /* Dark overlay slider */
    .overlay-slider-container {
      margin-top: 16px;
    }

    .overlay-slider-container label {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      font-size: 13px;
      font-weight: 700;
      color: var(--dv-text);
    }

    .overlay-value {
      font-size: 12px;
      font-weight: 800;
      color: var(--dv-vio);
      background: rgba(168, 85, 247, .1);
      padding: 4px 10px;
      border-radius: var(--dv-radius-pill);
      border: 1px solid rgba(168, 85, 247, .3);
    }

    /* MOBILE CHAT - NOWY */
    .mobile-chat-root {
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      background: var(--chat-bg, #fff);
      font-family: var(--chat-font, -apple-system, sans-serif);
    }

    .mobile-header {
      height: 56px;
      display: flex;
      align-items: center;
      padding: 0 16px;
      gap: 12px;
      background: var(--header-bg, #fff);
      border-bottom: 1px solid rgba(0, 0, 0, 0.1);
      flex-shrink: 0;
    }

    .mobile-header-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: var(--accent-color, #6C5CE7);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 14px;
      font-weight: 600;
    }

    .mobile-header-info {
      flex: 1;
    }

    .mobile-header-name {
      font-size: 16px;
      font-weight: 600;
      color: inherit;
    }

    .mobile-header-status {
      font-size: 12px;
      color: inherit;
      opacity: 0.7;
    }

    .mobile-messages {
      flex: 1;
      overflow-y: auto;
      padding: 16px 12px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      min-height: 0;
    }

    .mobile-message {
      display: flex;
      gap: 8px;
      max-width: 85%;
      animation: var(--message-animation, slideInUp) 0.3s ease;
    }

    .mobile-message.bot {
      align-self: flex-start;
    }

    .mobile-message.user {
      align-self: flex-end;
      flex-direction: row-reverse;
    }

    .mobile-message-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: var(--bot-bubble-bg, #6C5CE7);
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 12px;
    }

    .mobile-message.user .mobile-message-avatar {
      background: var(--user-bubble-bg, #e0e0e0);
    }

    .mobile-message-bubble {
      padding: 10px 14px;
      border-radius: var(--bubble-radius, 18px);
      font-size: 15px;
      line-height: 1.4;
      word-wrap: break-word;
    }

    .mobile-message.bot .mobile-message-bubble {
      background: var(--bot-bubble-bg, #6C5CE7);
      color: var(--bot-text-color, #fff);
      border-bottom-left-radius: 4px;
    }

    .mobile-message.user .mobile-message-bubble {
      background: var(--user-bubble-bg, #e0e0e0);
      color: var(--user-text-color, #000);
      border-bottom-right-radius: 4px;
    }

    .mobile-input-bar {
      height: 64px;
      display: flex;
      align-items: center;
      padding: 8px 12px;
      gap: 8px;
      background: var(--input-bg, #fff);
      border-top: 1px solid rgba(0, 0, 0, 0.1);
      flex-shrink: 0;
    }

    .mobile-input {
      flex: 1;
      height: 44px;
      border-radius: 22px;
      padding: 0 16px;
      border: 1px solid var(--input-border, #ddd);
      background: var(--input-field-bg, #f5f5f5);
      font-size: 15px;
      font-family: inherit;
      outline: none;
    }

    .mobile-send-button {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background: var(--accent-color, #6C5CE7);
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      flex-shrink: 0;
      transition: transform 0.2s;
    }

    .mobile-send-button:hover {
      transform: scale(1.05);
    }

    /* ========== VISUAL BUILDER OVERRIDES ========== */
    #dv-configurator {
      padding: 18px 24px 20px;
      max-width: 100%;
      --preview-block-height: clamp(560px, calc(100vh - 236px), 640px);
    }

    #dv-configurator .app-header {
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      padding: 0;
    }

    #dv-configurator .header-left {
      display: flex;
      align-items: center;
      gap: 18px;
      min-width: 0;
      flex: 1 1 auto;
    }

    #dv-configurator .appearance-page-header {
      display: flex;
      align-items: center;
      gap: 14px;
      min-width: 0;
      flex: 0 1 auto;
    }

    #dv-configurator .page-header-icon {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      background: linear-gradient(
        135deg,
        rgba(139, 92, 246, 0.18),
        rgba(236, 72, 153, 0.18),
        rgba(59, 130, 246, 0.18)
      );
      border: 1px solid rgba(255, 255, 255, 0.06);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      flex: 0 0 40px;
    }

    #dv-configurator .page-header-icon img {
      width: 20px;
      height: 20px;
      object-fit: contain;
      filter: brightness(0) saturate(100%) invert(100%);
      opacity: .95;
      display: block;
    }

    #dv-configurator .page-header-text {
      display: flex;
      flex-direction: column;
      gap: 2px;
      min-width: 0;
    }

    #dv-configurator .page-header-text h1 {
      margin: 0;
      font-size: 26px;
      font-weight: 700;
      color: var(--dv-text);
      letter-spacing: -0.02em;
    }

    #dv-configurator .page-header-text p {
      margin: 0;
      font-size: 13px;
      color: var(--dv-text2);
    }

    #dv-configurator .appearance-bot-picker {
      display: flex;
      align-items: center;
      gap: 8px;
      flex: 0 0 auto;
      min-width: 220px;
      max-width: 300px;
    }

    #dv-configurator .appearance-bot-label {
      font-size: 11px;
      font-weight: 700;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: #8f99ac;
      flex-shrink: 0;
    }

    #dv-configurator .appearance-bot-select-shell {
      position: relative;
      height: 36px;
      min-width: 220px;
      border-radius: 11px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      background: #151821;
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 0 32px 0 12px;
      transition: all 120ms ease;
    }

    #dv-configurator .appearance-bot-select-shell:hover {
      border-color: rgba(139, 92, 246, 0.35);
      background: #181c27;
    }

    #dv-configurator .appearance-bot-select-shell i:first-child {
      color: #9ea8bb;
      font-size: 12px;
      flex-shrink: 0;
    }

    #dv-configurator .appearance-bot-select-shell i:last-child {
      position: absolute;
      right: 11px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 10px;
      color: #8f99ac;
      pointer-events: none;
    }

    #dv-configurator #appearanceBotSelect {
      appearance: none;
      border: none;
      outline: none;
      background: transparent;
      color: #e5eaf5;
      width: 100%;
      font-size: 12px;
      font-weight: 600;
      line-height: 1;
      cursor: pointer;
      padding-right: 2px;
    }

    #dv-configurator #appearanceBotSelect option {
      background: #111318;
      color: #e5eaf5;
    }

    #dv-configurator .header-right {
      margin-left: auto;
      flex: 0 0 auto;
    }

    #dv-configurator .header-right .control-group {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    #dv-configurator .header-right .btn {
      height: 34px;
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      background: #151821;
      color: #d9e0ef;
      font-size: 12px;
      font-weight: 600;
    }

    #dv-configurator .header-right .btn:hover {
      border-color: rgba(139, 92, 246, 0.34);
      background: #1a1f2c;
    }

    #dv-configurator .header-right .btn.btn-primary {
      background: rgba(139, 92, 246, 0.16);
      border-color: rgba(139, 92, 246, 0.4);
      color: #f3f6ff;
    }

    #dv-configurator .header-right .btn.btn-primary:hover {
      background: rgba(139, 92, 246, 0.24);
      border-color: rgba(139, 92, 246, 0.55);
    }

    #dv-configurator .appearance-layout {
      display: grid;
      grid-template-rows: auto auto minmax(0, 1fr);
      gap: 14px 20px;
      align-items: stretch;
      height: 100vh;
      min-height: 0;
      overflow: hidden;
      background: transparent;
    }

    #dv-configurator .steps-nav {
      grid-column: 1 / -1;
      grid-row: 1;
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 0;
      padding: 2px 0 4px;
      overflow-x: auto;
      scrollbar-width: none;
    }

    #dv-configurator .steps-nav::-webkit-scrollbar {
      display: none;
    }

    #dv-configurator .layout-mobile-tabs {
      grid-column: 1 / -1;
      grid-row: 2;
      display: none;
      gap: 4px;
      width: fit-content;
      padding: 3px;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      background: #151821;
    }

    #dv-configurator .layout-tab-btn {
      height: 30px;
      padding: 0 14px;
      border-radius: 999px;
      border: none;
      background: transparent;
      color: var(--dv-text2);
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 120ms ease;
    }

    #dv-configurator .layout-tab-btn.active {
      background: rgba(255, 255, 255, 0.14);
      color: #fff;
      box-shadow:
        0 1px 2px rgba(0, 0, 0, 0.35),
        inset 0 1px 0 rgba(255, 255, 255, 0.32);
    }

    #dv-configurator .appearance-sidebar {
      grid-column: 1;
      grid-row: 3;
      min-width: 0;
      height: 100vh;
      min-height: 0;
      overflow: auto;
    }

    #dv-configurator .live-preview-column {
      grid-column: 2;
      grid-row: 3;
      min-width: 0;
      height: 100vh;
      min-height: 0;
      overflow: auto;
    }

    #dv-configurator .device-preview-column {
      grid-column: 3;
      grid-row: 3;
      min-width: 0;
      height: 100vh;
      min-height: 0;
      overflow: auto;
    }

    #dv-configurator .step-item {
      flex: 1 1 0;
      min-width: 162px;
      display: flex;
      align-items: center;
      gap: 8px;
      text-align: left;
      position: relative;
      padding: 0;
      border: none;
      border-radius: 0;
      cursor: pointer;
      color: var(--dv-text2);
      background: transparent;
      transition: all 120ms ease;
    }

    #dv-configurator .step-item::before {
      content: "";
      position: absolute;
      left: 0;
      right: 0;
      bottom: -6px;
      height: 1px;
      background: linear-gradient(
        90deg,
        transparent,
        rgba(139, 92, 246, 0.55),
        rgba(236, 72, 153, 0.5),
        rgba(59, 130, 246, 0.55),
        transparent
      );
      opacity: 0;
      transition: opacity 120ms ease;
      pointer-events: none;
    }

    #dv-configurator .step-badge {
      width: 28px;
      height: 28px;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.14);
      background: rgba(255, 255, 255, 0.03);
      color: var(--dv-text2);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: 700;
      flex: 0 0 28px;
      transition: all 120ms ease;
    }

    #dv-configurator .step-copy {
      display: flex;
      flex-direction: column;
      min-width: 0;
      gap: 1px;
    }

    #dv-configurator .step-title {
      font-size: 12px;
      font-weight: 600;
      color: currentColor;
      line-height: 1.2;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    #dv-configurator .step-caption {
      font-size: 10px;
      color: var(--dv-muted2);
      line-height: 1.2;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    #dv-configurator .step-item.active {
      color: #fff;
    }

    #dv-configurator .step-item.completed {
      color: var(--dv-text);
    }

    #dv-configurator .step-item.upcoming {
      color: var(--dv-text2);
    }

    #dv-configurator .step-item.active .step-badge {
      border-color: rgba(139, 92, 246, 0.66);
      background: linear-gradient(
        140deg,
        rgba(139, 92, 246, 0.32),
        rgba(236, 72, 153, 0.24),
        rgba(59, 130, 246, 0.24)
      );
      color: #fff;
      box-shadow: 0 0 0 1px rgba(139, 92, 246, 0.22), 0 0 18px rgba(139, 92, 246, 0.22);
    }

    #dv-configurator .step-item.completed .step-badge {
      border-color: rgba(139, 92, 246, 0.45);
      background: rgba(139, 92, 246, 0.14);
      color: #fff;
    }

    #dv-configurator .step-item.active .step-title,
    #dv-configurator .step-item.completed .step-title {
      color: #eef2ff;
    }

    #dv-configurator .step-item.active .step-caption,
    #dv-configurator .step-item.completed .step-caption {
      color: rgba(226, 232, 240, 0.82);
    }

    #dv-configurator .step-item:hover {
      color: #e8edf8;
    }

    #dv-configurator .step-item:hover .step-badge {
      border-color: rgba(255, 255, 255, 0.28);
      background: rgba(255, 255, 255, 0.06);
    }

    #dv-configurator .step-item.active::before,
    #dv-configurator .step-item.completed::before {
      opacity: 1;
    }

    #dv-configurator .step-connector {
      flex: 0 0 clamp(22px, 2vw, 34px);
      height: 2px;
      border-radius: 2px;
      background: rgba(255, 255, 255, 0.06);
      position: relative;
      overflow: hidden;
      transition: all 120ms ease;
    }

    #dv-configurator .step-connector.completed::before {
      content: "";
      position: absolute;
      inset: 0;
      background: linear-gradient(
        90deg,
        rgba(139, 92, 246, 0.8),
        rgba(236, 72, 153, 0.8),
        rgba(59, 130, 246, 0.8)
      );
    }

    #dv-configurator .appearance-sidebar {
      grid-column: 1;
      grid-row: 3;
      width: 100% !important;
      min-width: 0 !important;
      max-width: none !important;
      height: 100vh;
      overflow-y: auto;
      overflow-x: hidden;
      border: none;
      padding-right: 6px;
      scrollbar-width: thin;
      scrollbar-color: rgba(255, 255, 255, 0.18) transparent;
    }

    #dv-configurator .appearance-sidebar::-webkit-scrollbar {
      width: 6px;
    }

    #dv-configurator .appearance-sidebar::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.16);
      border-radius: 999px;
    }

    #dv-configurator .appearance-sidebar .preset-bar {
      position: sticky;
      top: 0;
      z-index: 10;
      height: 40px;
      border: 1px solid rgba(255, 255, 255, 0.06);
      border-radius: 10px;
      background: #111217;
      padding: 4px;
      gap: 4px;
      margin: 0 0 14px;
    }

    #dv-configurator .appearance-sidebar .preset-segment {
      margin: 0;
      border: none;
      border-radius: 8px;
      height: 30px;
      font-size: 12px;
      font-weight: 600;
    }

    #dv-configurator .appearance-sidebar .preset-segment.active {
      background: rgba(139, 92, 246, 0.15);
      border: 1px solid rgba(139, 92, 246, 0.35);
      color: #fff;
    }

    #dv-configurator .step-content {
      margin-top: 0;
      padding-top: 0;
      padding-bottom: 40px;
    }

    #dv-configurator .appearance-sidebar .config-accordion {
      gap: 14px;
    }

    #dv-configurator .appearance-sidebar .setting-card {
      padding: 0;
      border-radius: 14px;
      border: 1px solid rgba(255, 255, 255, 0.07);
      background: #181a20;
      position: relative;
      overflow: hidden;
      box-shadow: 0 14px 30px rgba(0, 0, 0, 0.26);
      transition: all 120ms ease;
    }

    #dv-configurator .appearance-sidebar .setting-card::before {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 1px;
      background: linear-gradient(
        90deg,
        transparent,
        rgba(139, 92, 246, 0.5),
        rgba(236, 72, 153, 0.5),
        rgba(59, 130, 246, 0.5),
        transparent
      );
      pointer-events: none;
    }

    #dv-configurator .appearance-sidebar .setting-card:hover {
      border-color: rgba(255, 255, 255, 0.12);
      transform: translateY(-1px);
    }

    #dv-configurator .appearance-sidebar .setting-card[data-step-hidden="true"] {
      display: none !important;
    }

    #dv-configurator .appearance-sidebar .section-header {
      padding: 14px 16px;
      border-bottom: 1px solid transparent;
      transition: all 120ms ease;
    }

    #dv-configurator .appearance-sidebar .setting-card:hover .section-header {
      background: rgba(255, 255, 255, 0.02);
    }

    #dv-configurator .appearance-sidebar .setting-card.active .section-header {
      border-bottom-color: rgba(255, 255, 255, 0.08);
    }

    #dv-configurator .appearance-sidebar .section-icon {
      width: 28px;
      height: 28px;
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.04);
      border: 1px solid rgba(255, 255, 255, 0.06);
    }

    #dv-configurator .appearance-sidebar .section-icon i {
      color: #c7ccd8;
    }

    #dv-configurator .appearance-sidebar .section-content {
      padding: 12px 14px 14px;
    }

    #dv-configurator .appearance-sidebar .setting-card .section-title h3 {
      font-size: 14px;
      font-weight: 600;
    }

    #dv-configurator .appearance-sidebar .setting-card .section-title p {
      font-size: 12px;
      color: var(--dv-muted);
    }

    #dv-configurator .appearance-sidebar .option-group {
      margin-bottom: 12px;
    }

    #dv-configurator .appearance-sidebar .option-group h4 {
      margin-bottom: 8px;
      font-size: 11px;
    }

    #dv-configurator .appearance-sidebar .subsection-header {
      margin: 12px 0 8px;
      padding-left: 6px;
      border-left-width: 2px;
      font-size: 12px;
    }

    #dv-configurator .appearance-sidebar .option-tiles {
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 8px;
    }

    #dv-configurator .appearance-sidebar .option-tile {
      min-height: 44px;
      padding: 8px 10px;
      gap: 8px;
      flex-direction: row;
      justify-content: flex-start;
      align-items: center;
      border: 1px solid rgba(255, 255, 255, 0.08);
      background: rgba(255, 255, 255, 0.02);
    }

    #dv-configurator .appearance-sidebar .option-tile:hover {
      transform: translateY(-1px);
      background: rgba(255, 255, 255, 0.04);
      border-color: rgba(139, 92, 246, 0.3);
    }

    #dv-configurator .appearance-sidebar .option-tile.active {
      border-color: rgba(139, 92, 246, 0.45);
      background: rgba(139, 92, 246, 0.12);
      outline: none;
      box-shadow: inset 0 0 0 1px rgba(139, 92, 246, 0.24);
    }

    #dv-configurator .appearance-sidebar .tile-preview {
      width: 24px;
      height: 20px;
      border-radius: 6px;
      flex-shrink: 0;
    }

    #dv-configurator .appearance-sidebar .tile-label {
      font-size: 11px;
      line-height: 1.2;
      text-align: left;
    }

    #dv-configurator .appearance-sidebar .slider-container label {
      margin-bottom: 6px;
      font-size: 12px;
    }

    #dv-configurator .appearance-sidebar .slider-value {
      font-size: 11px;
      padding: 2px 8px;
    }

    #dv-configurator .appearance-sidebar .slider {
      height: 5px;
    }

    #dv-configurator .appearance-sidebar .color-tiles-grid {
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px;
      margin-bottom: 8px;
    }

    #dv-configurator .appearance-sidebar .color-tile {
      height: 38px;
      padding: 0 11px;
      flex-direction: row;
      align-items: center;
      justify-content: flex-start;
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 10px;
      background: #1a1e29;
      transform: none;
      box-shadow: none;
      overflow: hidden;
      position: relative;
      isolation: isolate;
    }

    #dv-configurator .appearance-sidebar .color-tile::before {
      content: "";
      position: absolute;
      inset: 1px;
      border-radius: 9px;
      background: linear-gradient(
        112deg,
        rgba(255, 255, 255, 0.02) 0 46%,
        var(--tile-color, #7C3AED) 53% 100%
      );
      z-index: 0;
      opacity: 0.95;
      pointer-events: none;
    }

    #dv-configurator .appearance-sidebar .color-tile::after {
      content: "";
      position: absolute;
      top: -4px;
      bottom: -4px;
      left: 49%;
      width: 1px;
      background: rgba(255, 255, 255, 0.42);
      transform: skewX(-28deg);
      z-index: 1;
      pointer-events: none;
    }

    #dv-configurator .appearance-sidebar .color-tile:hover {
      transform: none;
      outline: none;
      border-color: rgba(139, 92, 246, 0.35);
      background: #202637;
      box-shadow: none;
    }

    #dv-configurator .appearance-sidebar .color-tile.active {
      border-color: rgba(139, 92, 246, 0.45);
      box-shadow:
        inset 0 0 0 1px rgba(139, 92, 246, 0.24),
        0 0 0 1px rgba(139, 92, 246, 0.14);
    }

    #dv-configurator .appearance-sidebar .color-preview {
      display: none;
    }

    #dv-configurator .appearance-sidebar .color-label {
      font-size: 11px;
      text-align: left;
      color: #e1e7f5;
      order: 1;
      position: relative;
      z-index: 2;
      font-weight: 700;
      letter-spacing: 0.01em;
    }

    #dv-configurator .appearance-sidebar .bg-options {
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px;
      margin-bottom: 8px;
    }

    #dv-configurator .appearance-sidebar .bg-option {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 8px;
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      background: rgba(255, 255, 255, 0.02);
      overflow: visible;
      transition: all 120ms ease;
    }

    #dv-configurator .appearance-sidebar .bg-option:hover {
      border-color: rgba(139, 92, 246, 0.34);
      background: rgba(139, 92, 246, 0.08);
    }

    #dv-configurator .appearance-sidebar .bg-option.active {
      border-color: rgba(139, 92, 246, 0.45);
      box-shadow: inset 0 0 0 1px rgba(139, 92, 246, 0.24);
    }

    #dv-configurator .appearance-sidebar .bg-option-preview {
      width: 30px;
      height: 22px;
      border-radius: 6px;
      flex: 0 0 30px;
    }

    #dv-configurator .appearance-sidebar .bg-option-label {
      font-size: 11px;
      padding: 0;
      text-align: left;
      background: transparent;
      color: #dbe0ea;
      line-height: 1.2;
    }

    #dv-configurator .appearance-sidebar .bg-upload-container,
    #dv-configurator .appearance-sidebar .avatar-upload-container {
      padding: 10px;
      gap: 8px;
      border-radius: 10px;
    }

    #dv-configurator .appearance-sidebar .bg-preview {
      height: 56px;
      margin-top: 2px;
    }

    #dv-configurator .appearance-sidebar .bg-preview-overlay {
      font-size: 10px;
    }

    #dv-configurator .appearance-sidebar .quick-reply-row {
      margin-bottom: 6px;
    }

    #dv-configurator .appearance-sidebar .position-tiles {
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px;
      margin-top: 8px;
    }

    #dv-configurator .appearance-sidebar .position-tile {
      height: 52px;
      min-height: 52px;
      padding: 8px 10px;
      gap: 8px;
      flex-direction: row;
      align-items: center;
      justify-content: flex-start;
      border-width: 1px;
      border-color: rgba(255, 255, 255, 0.08);
      background: rgba(255, 255, 255, 0.02);
      box-shadow: none;
      transform: none;
    }

    #dv-configurator .appearance-sidebar .position-tile:hover {
      transform: none;
      border-color: rgba(139, 92, 246, 0.35);
      background: rgba(139, 92, 246, 0.08);
      box-shadow: none;
    }

    #dv-configurator .appearance-sidebar .position-tile.active {
      border-color: rgba(139, 92, 246, 0.45);
      box-shadow: inset 0 0 0 1px rgba(139, 92, 246, 0.24);
    }

    #dv-configurator .appearance-sidebar .position-preview {
      width: 32px;
      height: 20px;
      border-width: 1px;
      flex-shrink: 0;
    }

    #dv-configurator .appearance-sidebar .position-indicator {
      width: 8px;
      height: 8px;
      box-shadow: 0 0 6px rgba(168, 85, 237, 0.52);
    }

    #dv-configurator .appearance-sidebar .position-label {
      font-size: 11px;
      text-align: left;
    }

    #dv-configurator .preview-area.appearance-preview-grid {
      display: block;
      min-width: 0;
      min-height: 0;
      padding: 0;
      background: transparent;
    }

    #dv-configurator .preview-section {
      height: auto;
      min-height: 0;
    }

    #dv-configurator .live-preview-section > :not(.chat-preview-wrapper) {
      display: none !important;
    }

    #dv-configurator .chat-preview-wrapper {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 100%;
      height: var(--preview-block-height);
      min-height: 560px;
    }

    #dv-configurator .chat-live-preview {
      width: 340px !important;
      min-width: 340px;
      max-width: 340px;
      height: 520px;
      border-radius: 16px;
      border: none;
      background: transparent;
      box-shadow: none;
      padding: 0;
      display: flex;
      align-items: stretch;
      justify-content: center;
      position: relative;
      overflow: hidden;
    }

    #dv-configurator .chat-live-preview::before {
      display: none !important;
      content: none !important;
    }

    #dv-configurator .chat-live-preview .chat-scale {
      width: 100%;
      height: 100%;
      transform: none !important;
      display: flex;
      align-items: stretch;
      justify-content: center;
    }

    #dv-configurator .chat-live-preview #workChat {
      width: 100% !important;
      height: 100% !important;
      max-width: none !important;
      max-height: none !important;
      box-shadow: none !important;
      margin: 0 !important;
      background-size: cover !important;
      background-position: center !important;
    }

    #dv-configurator .chat-live-preview #workChat .chat-messages {
      background: transparent !important;
    }

    #dv-configurator .chat-live-preview #workChat .chat-input {
      background: transparent !important;
      border-top: 1px solid rgba(255, 255, 255, 0.08);
    }

    #dv-configurator .preview-device-column {
      display: flex;
      flex-direction: column;
      min-width: 0;
    }

    #dv-configurator .device-toggle {
      display: flex;
      gap: 2px;
      margin: 0 0 14px;
      align-items: center;
      justify-content: flex-start;
      padding: 3px;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      background: #151821;
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.04);
      width: fit-content;
    }

    #dv-configurator .device-toggle .device-button {
      height: 30px;
      padding: 0 14px;
      flex: 0 0 auto;
      border-radius: 999px;
      border: none;
      background: transparent;
      color: var(--dv-text2);
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 120ms ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    #dv-configurator .device-toggle .device-button.active {
      background: rgba(255, 255, 255, 0.14);
      color: #fff;
      box-shadow:
        0 1px 2px rgba(0, 0, 0, 0.35),
        inset 0 1px 0 rgba(255, 255, 255, 0.32);
    }

    #dv-configurator .device-toggle .device-button:hover {
      background: rgba(255, 255, 255, 0.07);
    }

    #dv-configurator .device-preview-stage {
      width: 100%;
      height: min(72vh, var(--preview-block-height));
      min-height: 560px;
      border-radius: 14px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      background: #181a20;
      padding: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: visible;
      position: relative;
      isolation: isolate;
    }

    #dv-configurator .device-preview-stage::before {
      content: "";
      position: absolute;
      inset: 0;
      border-radius: inherit;
      padding: 1px;
      background: linear-gradient(
        130deg,
        rgba(139, 92, 246, 0.64),
        rgba(236, 72, 153, 0.5),
        rgba(59, 130, 246, 0.62)
      );
      -webkit-mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
      -webkit-mask-composite: xor;
      mask-composite: exclude;
      pointer-events: none;
      opacity: 0.9;
    }

    #dv-configurator .device-preview-mode {
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    #dv-configurator .live-preview-section .section-label,
    #dv-configurator .device-preview-desktop .section-label,
    #dv-configurator .device-preview-mobile .section-label {
      display: none !important;
    }

    .is-desktop .preview-desktop { display: block; }
    .is-desktop .preview-mobile { display: none; }
    .is-mobile .preview-desktop { display: none; }
    .is-mobile .preview-mobile { display: block; }

    #dv-configurator[data-device-preview="desktop"] .preview-desktop,
    #dv-configurator[data-device-preview="mobile"] .preview-mobile {
      display: block !important;
    }

    #dv-configurator[data-device-preview="desktop"] .preview-mobile,
    #dv-configurator[data-device-preview="mobile"] .preview-desktop {
      display: none !important;
    }

    #dv-configurator .phone-frame {
      width: 360px;
      height: 640px;
      margin: 0 auto;
      border-radius: 28px;
      background: #0b0f19;
      border: 2px solid rgba(255, 255, 255, 0.15);
      box-shadow: 0 0 0 6px rgba(255, 255, 255, 0.03), 0 30px 80px rgba(0, 0, 0, 0.6);
      overflow: hidden;
      position: relative;
      max-width: 100%;
    }

    #dv-configurator .phone-frame #mobileChatRoot {
      width: 100%;
      height: 100%;
      border-radius: inherit;
      overflow: hidden;
    }

    #dv-configurator .device-preview-desktop .desktop-preview {
      width: 100%;
      max-width: 680px;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      overflow: hidden;
      padding: 0;
      min-width: 0;
    }

    #dv-configurator .device-preview-mobile .mobile-column {
      width: 320px;
      height: 640px;
      padding: 0;
      display: flex;
      align-items: stretch;
      justify-content: center;
    }

    #dv-configurator .device-preview-mobile .phone-scale {
      width: 100%;
      height: 100%;
      transform: none !important;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #dv-configurator .device-preview-mobile .mobile-preview {
      width: 320px;
      height: 640px;
      border-radius: 28px;
      border: none;
      background: #0e1116;
      position: relative;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    #dv-configurator .device-preview-mobile .iphone-frame {
      width: 100%;
      height: 100%;
      border-radius: 34px;
      border: 1px solid rgba(255, 255, 255, 0.14);
      background: linear-gradient(165deg, #1d212b 0%, #0e1016 74%);
      padding: 10px;
      box-shadow:
        0 24px 58px rgba(0, 0, 0, 0.48),
        inset 0 1px 0 rgba(255, 255, 255, 0.08);
      position: relative;
    }

    #dv-configurator .device-preview-mobile .iphone-frame::before {
      content: "";
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      width: 76px;
      height: 20px;
      border-radius: 12px;
      background: #090b10;
      z-index: 12;
    }

    #dv-configurator .device-preview-mobile .iphone-frame::after {
      content: "";
      position: absolute;
      left: 50%;
      bottom: 8px;
      transform: translateX(-50%);
      width: 92px;
      height: 4px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.16);
      z-index: 12;
    }

    #dv-configurator .device-preview-mobile .iphone-screen::before,
    #dv-configurator .device-preview-mobile .iphone-screen::after {
      display: none !important;
    }

    #dv-configurator .device-preview-mobile .iphone-screen {
      border-radius: 24px;
      overflow: hidden;
      height: 100%;
      width: 100%;
      background: #0f1118;
    }

    #dv-configurator .device-preview-mobile .mobile-chat-root {
      width: 100%;
      height: 100%;
      padding: 0;
      display: flex;
      flex-direction: column;
    }

    #dv-configurator .device-preview-mobile .mobile-header {
      height: 54px;
      padding: 0 14px;
    }

    #dv-configurator .device-preview-mobile .mobile-header-avatar {
      width: 26px;
      height: 26px;
      border-radius: 9px;
    }

    #dv-configurator .device-preview-mobile .mobile-messages {
      padding: 12px 10px;
      gap: 8px;
    }

    #dv-configurator .device-preview-mobile .mobile-message-content {
      font-size: 12px;
      line-height: 1.35;
    }

    #dv-configurator .device-preview-mobile .mobile-input-bar {
      height: 62px;
      padding: 8px 10px 12px;
    }

    #dv-configurator .device-preview-mobile .mobile-input {
      height: 34px;
      font-size: 12px;
      border-radius: 17px;
    }

    #dv-configurator .device-preview-mobile .mobile-send-button {
      width: 34px;
      height: 34px;
      font-size: 12px;
    }

    #dv-configurator .chat-watermark {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 5px 10px;
      font-size: 10px;
      color: #9aa4b5;
      line-height: 1;
    }

    #dv-configurator .chat-watermark .watermark-label {
      color: #8f99ab;
      font-weight: 500;
    }

    #dv-configurator .chat-watermark .watermark-brand {
      background: linear-gradient(90deg, #8b5cf6, #ec4899, #3b82f6);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      color: transparent;
      font-weight: 700;
      letter-spacing: 0.01em;
    }

    #dv-configurator .chat-watermark .watermark-icon {
      width: 13px;
      height: 13px;
      object-fit: contain;
      display: block;
      opacity: 0.94;
    }

    #dv-configurator .chat-preview-wrapper,
    #dv-configurator .device-preview-stage {
      height: auto;
      min-height: 0;
    }

    #dv-configurator .chat-live-preview {
      border: none;
      border-radius: 16px;
      background: transparent;
      box-shadow: none;
      padding: 0;
      overflow: hidden;
      display: flex;
      align-items: stretch;
      justify-content: center;
    }

    #dv-configurator .chat-live-preview::before {
      display: none !important;
    }

    #dv-configurator .chat-live-preview .chat-scale {
      width: 100%;
      height: 100%;
    }

    #dv-configurator .chat-live-preview #workChat {
      width: 100% !important;
      height: 100% !important;
      max-width: none !important;
      max-height: none !important;
      margin: 0 !important;
      box-shadow: none !important;
      border: 1px solid rgba(255, 255, 255, 0.08);
    }

    #dv-configurator .device-preview-stage {
      padding: 18px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 14px;
      background: #181a20;
      overflow: hidden;
      position: relative;
      isolation: isolate;
    }

    #dv-configurator .device-preview-stage::before {
      content: "";
      position: absolute;
      top: 0;
      left: 14px;
      right: 14px;
      height: 1px;
      background: linear-gradient(
        90deg,
        transparent,
        rgba(139, 92, 246, 0.6),
        rgba(236, 72, 153, 0.56),
        rgba(59, 130, 246, 0.6),
        transparent
      );
      pointer-events: none;
      opacity: 0.95;
    }

    #dv-configurator .device-preview-mode {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #dv-configurator .device-preview-desktop .desktop-preview {
      width: 100%;
      max-width: 680px;
      min-width: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      overflow: hidden;
      padding: 0;
    }

    #dv-configurator .device-preview-desktop .desktop-preview::before {
      display: none;
    }

    #dv-configurator .monitor-chat {
      position: absolute;
      right: 12px;
      bottom: 12px;
      width: 360px;
      height: 520px;
      max-width: calc(100% - 24px);
      max-height: calc(100% - 24px);
      border-radius: 16px;
      overflow: hidden;
      background: transparent;
      z-index: 2;
      box-shadow: none;
    }

    #dv-configurator .device-preview-mobile .mobile-column.mobile-preview {
      width: 320px;
      height: 640px;
      max-width: 100%;
      max-height: 100%;
      padding: 0;
      border-radius: 28px;
      overflow: hidden;
      background: #0e1116;
      position: relative;
    }

    #dv-configurator .device-preview-mobile .mobile-column.mobile-preview::before {
      display: none;
    }

    #dv-configurator .device-preview-mobile .iphone-frame {
      width: 100%;
      height: 100%;
      border-radius: 28px;
      border: none;
      background: transparent;
      padding: 0;
      box-shadow: none;
      position: relative;
    }

    #dv-configurator .device-preview-mobile .iphone-frame::before {
      display: none;
    }

    #dv-configurator .device-preview-mobile .iphone-frame::after {
      display: none;
    }

    #dv-configurator .device-preview-mobile .iphone-screen {
      width: 100%;
      height: 100%;
      border-radius: inherit;
      overflow: hidden;
      background: transparent;
      position: relative;
    }

    #dv-configurator .preview-chat-host {
      width: 100%;
      height: 100%;
      position: relative;
      display: flex;
      align-items: stretch;
      justify-content: stretch;
      background: transparent;
      padding: 0;
    }

    #dv-configurator .preview-chat-host.mobile-chat-root {
      padding: 0;
      background: transparent;
    }

    #dv-configurator #monitorChat,
    #dv-configurator #mobileChatRoot {
      background: transparent;
      border: none;
      box-shadow: none;
      padding: 0;
    }

    #dv-configurator .preview-chat {
      width: 100%;
      height: 100%;
      background: transparent;
      border-radius: inherit;
      display: flex;
      flex-direction: column;
      color: var(--text-primary, var(--dv-text));
      opacity: 1;
      visibility: visible;
    }

    #dv-configurator .preview-chat .chat-window {
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      background: transparent;
      color: var(--text-primary, var(--dv-text));
      opacity: 1;
      visibility: visible;
    }

    #dv-configurator .preview-chat .chat-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 14px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.06);
      background: rgba(255, 255, 255, 0.03);
      flex-shrink: 0;
    }

    #dv-configurator .preview-chat .chat-brand {
      display: flex;
      align-items: center;
      gap: 8px;
      min-width: 0;
    }

    #dv-configurator .preview-chat .chat-avatar {
      width: 28px;
      height: 28px;
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.08);
      border: 1px solid rgba(255, 255, 255, 0.12);
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      flex-shrink: 0;
    }

    #dv-configurator .preview-chat .chat-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    #dv-configurator .preview-chat .chat-info {
      min-width: 0;
      display: flex;
      flex-direction: column;
      gap: 1px;
    }

    #dv-configurator .preview-chat .chat-name {
      font-size: 13px;
      font-weight: 600;
      line-height: 1.2;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    #dv-configurator .preview-chat .chat-status {
      font-size: 11px;
      opacity: 0.68;
      line-height: 1.2;
    }

    #dv-configurator .preview-chat .chat-actions {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    #dv-configurator .preview-chat .close-btn {
      width: 32px;
      height: 32px;
      border-radius: 10px;
      background: rgba(255, 255, 255, 0.06);
      border: 1px solid rgba(255, 255, 255, 0.1);
      color: #c6cedc;
      font-size: 14px;
      transition: all 120ms ease;
    }

    #dv-configurator .preview-chat .close-btn:hover {
      background: rgba(255, 80, 80, 0.18);
      border-color: rgba(255, 80, 80, 0.28);
      color: #ff8e8e;
      transform: translateY(-1px);
    }

    #dv-configurator .preview-chat .chat-messages {
      display: flex;
      flex-direction: column;
      gap: 12px;
      padding: 16px;
      overflow-y: auto;
      flex: 1;
      min-height: 0;
      background: transparent;
      opacity: 1;
      visibility: visible;
    }

    #dv-configurator .preview-chat .message {
      display: flex;
      flex-direction: row;
      align-items: flex-end;
      gap: 8px;
      width: 100%;
      max-width: 100%;
      opacity: 1;
      visibility: visible;
    }

    #dv-configurator .preview-chat .message.message-user {
      justify-content: flex-end;
      align-self: flex-end;
    }

    #dv-configurator .preview-chat .message.message-bot {
      justify-content: flex-start;
      align-self: flex-start;
    }

    #dv-configurator .preview-chat .message-avatar {
      width: 28px;
      height: 28px;
      border-radius: 8px;
      border: 1px solid rgba(255, 255, 255, 0.12);
      background: rgba(255, 255, 255, 0.08);
      overflow: hidden;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #dv-configurator .preview-chat .message-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    #dv-configurator .preview-chat .message-bubble {
      display: inline-block;
      padding: 10px 14px;
      border-radius: 12px;
      font-size: 14px;
      line-height: 1.4;
      max-width: 75%;
      word-wrap: break-word;
      white-space: pre-wrap;
      color: var(--text-primary, #e7edf7);
      opacity: 1;
      visibility: visible;
      border: 1px solid transparent;
    }

    #dv-configurator .preview-chat .message.message-bot .message-bubble {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.06);
      border-radius: 14px 14px 14px 4px;
    }

    #dv-configurator .preview-chat .message.message-user .message-bubble {
      background: rgba(139, 92, 246, 0.18);
      border: 1px solid rgba(139, 92, 246, 0.35);
      border-radius: 14px 14px 4px 14px;
    }

    #dv-configurator .preview-chat .message-time {
      margin-top: 4px;
      font-size: 11px;
      opacity: 0.5;
      line-height: 1;
      color: #aab4c6;
    }

    #dv-configurator .preview-chat .chat-input {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 14px;
      border-top: 1px solid rgba(255, 255, 255, 0.08);
      background: rgba(0, 0, 0, 0.08);
      flex-shrink: 0;
    }

    #dv-configurator .preview-chat .chat-input input {
      flex: 1;
      height: 40px;
      border-radius: 20px;
      padding: 0 14px;
      border: 1px solid rgba(255, 255, 255, 0.12);
      background: rgba(255, 255, 255, 0.05);
      color: var(--text-primary, #e7edf7);
      opacity: 1;
      visibility: visible;
      font-size: 14px;
    }

    #dv-configurator .preview-chat .chat-input input:focus {
      outline: none;
      border-color: rgba(139, 92, 246, 0.42);
      box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.16);
    }

    #dv-configurator .preview-chat .send-btn {
      width: 40px;
      height: 40px;
      border-radius: 20px;
      border: none;
      background: #7c3aed;
      color: #fff;
      font-size: 14px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      transition: all 120ms ease;
      flex-shrink: 0;
    }

    #dv-configurator .preview-chat .send-btn:hover {
      transform: translateY(-1px);
      filter: brightness(1.06);
    }

    #dv-configurator .preview-chat .chat-watermark {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 6px 10px;
      border-top: 1px solid rgba(255, 255, 255, 0.04);
      background: rgba(0, 0, 0, 0.08);
      flex-shrink: 0;
    }

    #dv-configurator .preview-chat.preview-chat--mobile .chat-header {
      padding-top: 18px;
    }

    #dv-configurator .preview-chat.preview-chat--mobile .chat-messages {
      padding: 14px;
    }

    #dv-configurator .preview-chat.preview-chat--mobile .chat-input {
      padding-bottom: 16px;
    }

    #dv-configurator .bottom-actions {
      display: none !important;
    }

    #dv-configurator .steps-nav .step-item:focus-visible,
    #dv-configurator .device-toggle .device-button:focus-visible,
    #dv-configurator .appearance-sidebar .setting-card:focus-within {
      outline: none;
      box-shadow: 0 0 0 1px rgba(139, 92, 246, 0.42), 0 0 0 4px rgba(139, 92, 246, 0.18);
    }

    /* ===== Final Preview Stage Overrides ===== */
    #dv-configurator .live-preview-column,
    #dv-configurator .device-preview-column {
      min-width: 0;
      min-height: 0;
      overflow: auto;
    }

    #dv-configurator .preview-desktop .desktop-preview {
      width: 100%;
      height: 100%;
      min-height: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      background: transparent;
      border: none;
    }

    #dv-configurator #monitorFrame {
      width: min(100%, 396px);
      aspect-ratio: 16 / 10;
      border-radius: 14px;
      border: 1px solid rgba(255, 255, 255, 0.10);
      box-shadow: 0 24px 52px rgba(0, 0, 0, 0.52);
      background: #0c111b;
      overflow: hidden;
      margin: 0 auto;
      position: relative;
      isolation: isolate;
    }

    #dv-configurator #monitorScreen {
      position: relative;
      width: 100%;
      height: 100%;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      background:
        radial-gradient(88% 120% at 82% 88%, rgba(124, 58, 237, 0.24), rgba(124, 58, 237, 0) 62%),
        radial-gradient(66% 94% at 74% 84%, rgba(236, 72, 153, 0.16), rgba(236, 72, 153, 0) 64%),
        linear-gradient(160deg, #090d13 0%, #0e1320 52%, #131a2a 100%);
    }

    #dv-configurator #monitorViewport {
      position: absolute;
      left: 50%;
      top: 50%;
      width: 1440px;
      height: 900px;
      transform: translate(-50%, -50%) scale(1);
      transform-origin: top left;
      background: transparent;
      overflow: visible;
    }

    #dv-configurator #monitorChat {
      position: absolute;
      border-radius: 16px;
      overflow: hidden;
      background: transparent;
      z-index: 5;
    }

    #dv-configurator .preview-chat .chat-window {
      display: flex;
      flex-direction: column;
      min-height: 0;
    }

    #dv-configurator .preview-chat .chat-messages {
      flex: 1 1 auto;
      min-height: 0;
      overflow-y: auto;
      overflow-x: hidden;
    }

    #dv-configurator .preview-chat .quick-replies-top,
    #dv-configurator .preview-chat .quick-replies-bottom {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      padding: 10px 12px;
      background: rgba(12, 17, 26, 0.58);
      border-top: 1px solid rgba(255, 255, 255, 0.08);
      backdrop-filter: blur(10px);
      flex-shrink: 0;
      z-index: 3;
    }

    #dv-configurator .preview-chat .quick-reply-chip,
    #dv-configurator .preview-chat .quick-replies-top button,
    #dv-configurator .preview-chat .quick-replies-bottom button {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-height: 32px;
      padding: 7px 12px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 600;
      line-height: 1.1;
      border: 1px solid rgba(255, 255, 255, 0.12);
      transition: transform 120ms ease, filter 120ms ease, background 120ms ease;
      white-space: nowrap;
    }

    #dv-configurator .preview-chat .quick-reply-chip:hover,
    #dv-configurator .preview-chat .quick-replies-top button:hover,
    #dv-configurator .preview-chat .quick-replies-bottom button:hover {
      transform: translateY(-1px);
      filter: brightness(1.04);
    }

    #dv-configurator .preview-mobile .mobile-preview {
      width: 100%;
      height: 100%;
      min-height: 0;
      padding: 0;
      border: none;
      background: transparent;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }

    #dv-configurator .phone-frame {
      width: min(100%, 360px);
      aspect-ratio: 9 / 16;
      height: auto;
      max-height: calc(100vh - 220px);
      margin: 0 auto;
      border-radius: 30px;
      border: 2px solid rgba(255, 255, 255, 0.14);
      box-shadow: 0 0 0 6px rgba(255, 255, 255, 0.03), 0 34px 86px rgba(0, 0, 0, 0.62);
      background: #0b0f19;
      overflow: hidden;
      position: relative;
      display: flex;
    }

    #dv-configurator .phone-frame #mobileChatRoot {
      width: 100%;
      height: 100%;
      border-radius: inherit;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    #dv-configurator .preview-mobile .preview-chat--mobile,
    #dv-configurator .preview-mobile .preview-chat--mobile .chat-window {
      width: 100%;
      height: 100%;
      min-height: 0;
    }

    #dv-configurator .preview-mobile .preview-chat--mobile .chat-header {
      position: sticky;
      top: 0;
      z-index: 4;
    }

    #dv-configurator .preview-mobile .preview-chat--mobile .chat-messages {
      flex: 1 1 auto;
      min-height: 0;
      overflow-y: auto;
      padding: 14px 12px 10px;
    }

    #dv-configurator .preview-mobile .preview-chat--mobile .quick-replies-bottom {
      position: sticky;
      bottom: 68px;
      z-index: 4;
    }

    #dv-configurator .preview-mobile .preview-chat--mobile .chat-input {
      position: sticky;
      bottom: 0;
      z-index: 5;
      background: rgba(10, 14, 22, 0.88);
      backdrop-filter: blur(8px);
    }

    #dv-configurator .chat-icon {
      position: absolute;
      display: none;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 20;
      overflow: hidden;
    }

    #dv-configurator .chat-icon img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    #dv-configurator #workChatIcon {
      left: 24px;
      bottom: 24px;
    }

    #dv-configurator #monitorChatIcon {
      bottom: 16px;
      right: 16px;
    }

    #dv-configurator #mobileChatIcon {
      right: 16px;
      bottom: 24px;
    }

    @media (max-width: 1700px) {
      #dv-configurator .header-left {
        gap: 12px;
      }

      #dv-configurator .appearance-bot-picker,
      #dv-configurator .appearance-bot-select-shell {
        min-width: 200px;
      }
    }

    @media (max-width: 1200px) {
      #dv-configurator .appearance-layout {
        grid-template-columns: clamp(260px, 28vw, 340px) minmax(0, 1fr);
        grid-template-rows: auto auto minmax(0, 1fr);
      }

      #dv-configurator .layout-mobile-tabs {
        display: inline-flex;
      }

      #dv-configurator .appearance-sidebar {
        grid-column: 1;
      }

      #dv-configurator .live-preview-column,
      #dv-configurator .device-preview-column {
        grid-column: 2;
      }

      #dv-configurator .device-preview-column {
        display: none;
      }

      #dv-configurator .appearance-layout[data-active-panel="device"] .live-preview-column {
        display: none;
      }

      #dv-configurator .appearance-layout[data-active-panel="device"] .device-preview-column {
        display: block;
      }

      #dv-configurator .layout-tab-btn[data-panel="options"] {
        display: none;
      }
    }

    @media (max-width: 860px) {
      #dv-configurator .appearance-layout {
        grid-template-columns: minmax(0, 1fr);
        grid-template-rows: auto auto minmax(0, 1fr);
      }

      #dv-configurator .layout-tab-btn[data-panel="options"] {
        display: inline-flex;
      }

      #dv-configurator .appearance-sidebar,
      #dv-configurator .live-preview-column,
      #dv-configurator .device-preview-column {
        grid-column: 1;
        grid-row: 3;
        height: auto;
        max-height: none;
      }

      #dv-configurator .appearance-sidebar,
      #dv-configurator .live-preview-column,
      #dv-configurator .device-preview-column {
        display: none;
      }

      #dv-configurator .appearance-layout[data-active-panel="options"] .appearance-sidebar {
        display: block;
      }

      #dv-configurator .appearance-layout[data-active-panel="preview"] .live-preview-column {
        display: block;
      }

      #dv-configurator .appearance-layout[data-active-panel="device"] .device-preview-column {
        display: block;
      }

      #dv-configurator .chat-preview-wrapper,
      #dv-configurator .device-preview-stage {
        min-height: 0;
        height: auto;
      }
    }
  </style>
</head>

<body>
    <!-- Ambient Particles Background -->
    <canvas id="ambientParticles"></canvas>
    
    <!-- Page Wrapper for sidebar integration -->
    <div id="page-wrapper">
    <!-- Sidebar placeholder - space reserved for external sidebar -->
    <aside id="sidebar-spacer"></aside>
    <!-- Main Content -->
    <div id="main-content">
      <div id="appearance" hidden></div>
      <main id="dv-configurator" class="app-container" data-device-preview="desktop" data-builder-step="layout">
        <!-- Top Bar -->
        <header class="app-header">
          <div class="header-left">
            <div class="appearance-page-header">
              <div class="page-header-icon">
                <img src="/assets/icons/appearance.svg" alt="" />
              </div>
              <div class="page-header-text">
                <h1 data-i18n="appearance.page.title"></h1>
                <p>Build and preview your chatbot visuals step by step.</p>
              </div>
            </div>
            <div class="appearance-bot-picker" id="appearanceBotPicker">
              <label class="appearance-bot-label" for="appearanceBotSelect">Bot</label>
              <div class="appearance-bot-select-shell">
                <i class="fas fa-robot" aria-hidden="true"></i>
                <select id="appearanceBotSelect" aria-label="Select bot to edit"></select>
                <i class="fas fa-chevron-down" aria-hidden="true"></i>
              </div>
            </div>
          </div>
          <div class="header-right">
            <div class="control-group">
              <button class="btn btn-secondary" data-role="action-load">
                <i class="fas fa-folder-open"></i> <span data-i18n="appearance.actions.load"></span>
              </button>
              <button class="btn btn-primary" data-role="action-save">
                <i class="fas fa-save"></i> <span data-i18n="appearance.actions.save"></span>
              </button>
            </div>
          </div>
        </header>
        <!-- Main Content Area - FULL HEIGHT CONFIGURATOR LEFT -->
        <div class="content-area appearance-layout">
          <nav class="steps-nav steps-nav-top" aria-label="Appearance Builder Steps">
            <button type="button" class="step-item active" data-step="layout">
              <span class="step-badge">1</span>
              <span class="step-copy">
                <span class="step-title">Layout</span>
                <span class="step-caption">Ksztalt i typografia</span>
              </span>
            </button>
            <div class="step-connector" aria-hidden="true"></div>
            <button type="button" class="step-item" data-step="colors">
              <span class="step-badge">2</span>
              <span class="step-copy">
                <span class="step-title">Colors</span>
                <span class="step-caption">Babelki i tlo</span>
              </span>
            </button>
            <div class="step-connector" aria-hidden="true"></div>
            <button type="button" class="step-item" data-step="position">
              <span class="step-badge">3</span>
              <span class="step-copy">
                <span class="step-title">Position</span>
                <span class="step-caption">Osadzenie widgetu</span>
              </span>
            </button>
            <div class="step-connector" aria-hidden="true"></div>
            <button type="button" class="step-item" data-step="branding">
              <span class="step-badge">4</span>
              <span class="step-copy">
                <span class="step-title">Avatar &amp; Branding</span>
                <span class="step-caption">Marka i tozsamosc</span>
              </span>
            </button>
            <div class="step-connector" aria-hidden="true"></div>
            <button type="button" class="step-item" data-step="animations">
              <span class="step-badge">5</span>
              <span class="step-copy">
                <span class="step-title">Animations</span>
                <span class="step-caption">Ruch i zachowanie</span>
              </span>
            </button>
            <div class="step-connector" aria-hidden="true"></div>
            <button type="button" class="step-item" data-step="advanced">
              <span class="step-badge">6</span>
              <span class="step-copy">
                <span class="step-title">Advanced</span>
                <span class="step-caption">Quick replies i dodatki</span>
              </span>
            </button>
          </nav>
          <div class="layout-mobile-tabs" id="appearanceLayoutTabs" role="tablist" aria-label="Layout panels">
            <button type="button" class="layout-tab-btn active" data-panel="options" aria-selected="true">Options</button>
            <button type="button" class="layout-tab-btn" data-panel="preview" aria-selected="false">Preview</button>
            <button type="button" class="layout-tab-btn" data-panel="device" aria-selected="false">Device</button>
          </div>
          <!-- LEFT - Configurator Panel (FULL HEIGHT) -->
          <div class="config-column appearance-sidebar">
            <!-- Preset Bar inside configurator -->
            <div class="preset-bar">
              <div class="preset-segment" data-i18n="appearance.presets.label"></div>
              <div class="preset-segment active" data-preset="custom" data-i18n="appearance.presets.custom"></div>
              <div class="preset-segment" data-preset="sales" data-i18n="appearance.presets.sales"></div>
              <div class="preset-segment" data-preset="support" data-i18n="appearance.presets.support"></div>
            </div>
            <section class="config-panel step-content">
              <div class="config-accordion" data-role="accordion">
                <!-- 1️⃣ KSZTAŁT (okno + dymki) -->
                <div class="config-section setting-card active" data-role="acc-item" data-builder-step="layout">
                  <div class="section-header">
                    <div class="section-icon"><i class="fas fa-shapes"></i></div>
                    <div class="section-title">
                      <h3 data-i18n="appearance.sections.shape.title"></h3>
                      <p data-i18n="appearance.sections.shape.subtitle"></p>
                    </div>
                    <i class="fas fa-chevron-down arrow"></i>
                  </div>
                  <div class="section-content">
                    <!-- Podsekcja: Okno -->
                    <div class="subsection-header" data-i18n="appearance.sections.shape.window"></div>
                    <div class="option-group">
                      <h4 data-i18n="appearance.common.presets"></h4>
                      <div class="option-tiles">
                        <button class="option-tile active" data-group="work" data-key="windowPreset" data-value="soft">
                          <div class="tile-preview">
                            <div class="window-preview rounded-soft"></div>
                          </div>
                          <span class="tile-label" data-i18n="appearance.shape.window.soft"></span>
                        </button>
                        <button class="option-tile" data-group="work" data-key="windowPreset" data-value="medium">
                          <div class="tile-preview">
                            <div class="window-preview rounded-medium"></div>
                          </div>
                          <span class="tile-label" data-i18n="appearance.shape.window.medium"></span>
                        </button>
                        <button class="option-tile" data-group="work" data-key="windowPreset" data-value="hard">
                          <div class="tile-preview">
                            <div class="window-preview rounded-hard"></div>
                          </div>
                          <span class="tile-label" data-i18n="appearance.shape.window.hard"></span>
                        </button>
                      </div>
                    </div>
                    <div class="slider-container">
                      <label><span data-i18n="appearance.shape.window.radius"></span> <span class="slider-value"
                          data-for="work.windowRadius">12px</span></label>
                      <input type="range" min="0" max="32" value="12" class="slider" data-group="work"
                        data-key="windowRadius" data-role="range">
                    </div>

                    <!-- Podsekcja: Dymki -->
                    <div class="subsection-header" style="margin-top: 24px;" data-i18n="appearance.shape.bubbles.label"></div>
                    <div class="option-group">
                      <h4 data-i18n="appearance.common.presets"></h4>
                      <div class="option-tiles">
                        <button class="option-tile active" data-group="work" data-key="bubblePreset" data-value="pill">
                          <div class="tile-preview">
                            <div class="bubble-preview pill"></div>
                          </div>
                          <span class="tile-label" data-i18n="appearance.shape.bubbles.pill"></span>
                        </button>
                        <button class="option-tile" data-group="work" data-key="bubblePreset" data-value="rounded">
                          <div class="tile-preview">
                            <div class="bubble-preview rounded"></div>
                          </div>
                          <span class="tile-label" data-i18n="appearance.shape.bubbles.rounded"></span>
                        </button>
                        <button class="option-tile" data-group="work" data-key="bubblePreset" data-value="compact">
                          <div class="tile-preview">
                            <div class="bubble-preview compact"></div>
                          </div>
                          <span class="tile-label" data-i18n="appearance.shape.bubbles.compact"></span>
                        </button>
                      </div>
                    </div>
                    <div class="slider-container">
                      <label><span data-i18n="appearance.shape.bubbles.radius"></span> <span class="slider-value"
                          data-for="work.bubbleRadius">20px</span></label>
                      <input type="range" min="0" max="40" value="20" class="slider" data-group="work"
                        data-key="bubbleRadius" data-role="range">
                    </div>
                  </div>
                </div>

                <!-- 2️⃣ CZCIONKA -->
                <div class="config-section setting-card" data-role="acc-item" data-builder-step="layout">
                  <div class="section-header">
                    <div class="section-icon"><i class="fas fa-font"></i></div>
                    <div class="section-title">
                      <h3 data-i18n="appearance.sections.font.title"></h3>
                      <p data-i18n="appearance.sections.font.subtitle"></p>
                    </div>
                    <i class="fas fa-chevron-down arrow"></i>
                  </div>
                  <div class="section-content">
                    <div class="form-group">
                      <label data-i18n="appearance.font.family"></label>
                      <select class="font-select" data-group="work" data-key="fontFamily">
                        <option value="system" data-i18n="appearance.font.options.system"></option>
                        <option value="inter" data-i18n="appearance.font.options.inter"></option>
                        <option value="roboto" data-i18n="appearance.font.options.roboto"></option>
                        <option value="open-sans" data-i18n="appearance.font.options.openSans"></option>
                        <option value="montserrat" data-i18n="appearance.font.options.montserrat"></option>
                        <option value="poppins" data-i18n="appearance.font.options.poppins"></option>
                        <option value="sf-pro" data-i18n="appearance.font.options.sfPro"></option>
                        <option value="geist" data-i18n="appearance.font.options.geist"></option>
                      </select>
                    </div>
                    <div class="slider-container">
                      <label><span data-i18n="appearance.font.size"></span> <span class="slider-value" data-for="work.fontSize">14px</span></label>
                      <input type="range" min="12" max="20" value="14" class="slider" data-group="work"
                        data-key="fontSize" data-role="range">
                    </div>
                  </div>
                </div>

                <!-- 3️⃣ KOLORY I TŁO -->
                <!-- Chat (UI Colors) -->
                <div class="config-section setting-card" data-role="acc-item" data-builder-step="colors">
                  <div class="section-header">
                    <div class="section-icon"><i class="fas fa-comments"></i></div>
                    <div class="section-title">
                      <h3 data-i18n="appearance.sections.chatUi.title"></h3>
                      <p data-i18n="appearance.sections.chatUi.subtitle"></p>
                    </div>
                    <i class="fas fa-chevron-down arrow"></i>
                  </div>
                  <div class="section-content">
                    <div class="color-tiles-grid">
                      <button class="color-tile active" data-group="work" data-key="chatBackground"
                        data-value="#0F0F14">
                        <div class="color-preview" style="background-color: #0F0F14;"></div>
                        <span class="color-label" data-i18n="appearance.chatUi.background"></span>
                      </button>
                      <button class="color-tile" data-group="work" data-key="chatHeader" data-value="#1A1A20">
                        <div class="color-preview" style="background-color: #1A1A20;"></div>
                        <span class="color-label" data-i18n="appearance.chatUi.header"></span>
                      </button>
                      <button class="color-tile" data-group="work" data-key="chatInput" data-value="#1A1A20">
                        <div class="color-preview" style="background-color: #1A1A20;"></div>
                        <span class="color-label" data-i18n="appearance.chatUi.input"></span>
                      </button>
                      <button class="color-tile" data-group="work" data-key="chatAccent" data-value="#7C3AED">
                        <div class="color-preview" style="background-color: #7C3AED;"></div>
                        <span class="color-label" data-i18n="appearance.chatUi.accent"></span>
                      </button>
                    </div>
                    <div class="option-group">
                      <h4 data-i18n="appearance.chatUi.backgroundOptions"></h4>
                      <div class="bg-options">
                        <div class="bg-option active" data-bg-type="color">
                          <div class="bg-option-preview" style="background-color: #0F0F14;"></div>
                          <div class="bg-option-label" data-i18n="appearance.chatUi.backgroundSolid"></div>
                        </div>
                        <div class="bg-option" data-bg-type="image" data-bg-image="sales">
                          <div class="bg-option-preview"
                            style="background-image: url('https://d98a890ebc03293bc70c4f2e92e9e2e5.cdn.bubble.io/f1769988404088x184638242248941000/8k%20white%20opal%20liquid%20glass%20prisma%20%20background%20%281%29.jpg')">
                          </div>
                          <div class="bg-option-label" data-i18n="appearance.chatUi.backgroundOpalLight"></div>
                        </div>
                        <div class="bg-option" data-bg-type="image" data-bg-image="support">
                          <div class="bg-option-preview"
                            style="background-image: url('https://d98a890ebc03293bc70c4f2e92e9e2e5.cdn.bubble.io/f1769988406812x536571790714338370/Minimal%20dark%20background%20with%20subtle%20grain%20texture%2C%20modern%20SaaS%20UI%20style%2C%20%2Celegant%20and%20professional%2C%20soft%20lighting%2C%20abstract%2C%20premium%20software%20background%2C%20with%20red%20marmour%20lightnighs.jpg')">
                          </div>
                          <div class="bg-option-label" data-i18n="appearance.chatUi.backgroundMinimalDark"></div>
                        </div>
                        <div class="bg-option" data-bg-type="image" data-bg-image="custom">
                          <div class="bg-option-preview"
                            style="background-image: url('https://d98a890ebc03293bc70c4f2e92e9e2e5.cdn.bubble.io/f1769988400022x612783169203748500/8k%20dark%20green%20opal%20liquid%20glass%20background.jpg')">
                          </div>
                          <div class="bg-option-label" data-i18n="appearance.chatUi.backgroundGreenOpal"></div>
                        </div>
                      </div>
                      <div class="bg-upload-container">
                        <input type="file" accept="image/*" id="bgUpload" hidden />
                        <div class="bg-upload-buttons">
                          <button class="btn btn-secondary btn-sm" id="bgUploadBtn">
                            <i class="fas fa-image"></i> <span data-i18n="appearance.chatUi.uploadImage"></span>
                          </button>
                          <button class="btn btn-secondary btn-sm" id="bgRemoveBtn">
                            <i class="fas fa-trash"></i> <span data-i18n="appearance.chatUi.removeBackground"></span>
                          </button>
                        </div>
                        <div class="bg-preview" id="bgPreview">
                          <div class="bg-preview-overlay" data-i18n="appearance.chatUi.previewLabel"></div>
                        </div>
                      </div>
                    </div>
                    <div class="overlay-slider-container">
                      <label><span data-i18n="appearance.chatUi.overlay"></span> <span class="overlay-value" id="overlayValue">0%</span></label>
                      <input type="range" min="0" max="70" value="0" class="slider" id="bgOverlaySlider">
                    </div>
                  </div>
                </div>

                <!-- 4️⃣ KOLORY WIADOMOŚCI (user + bot) -->
                <div class="config-section setting-card" data-role="acc-item" data-builder-step="colors">
                  <div class="section-header">
                    <div class="section-icon"><i class="fas fa-comment-dots"></i></div>
                    <div class="section-title">
                      <h3 data-i18n="appearance.sections.messageColors.title"></h3>
                      <p data-i18n="appearance.sections.messageColors.subtitle"></p>
                    </div>
                    <i class="fas fa-chevron-down arrow"></i>
                  </div>
                  <div class="section-content">
                    <!-- Podsekcja: Użytkownik -->
                    <div class="subsection-header" data-i18n="appearance.messageColors.user"></div>
                    <div class="color-tiles-grid">
                      <button class="color-tile active" data-group="work" data-key="userBubble" data-value="#7C3AED">
                        <div class="color-preview" style="background-color: #7C3AED;"></div>
                        <span class="color-label" data-i18n="appearance.messageColors.bubble"></span>
                      </button>
                      <button class="color-tile" data-group="work" data-key="userText" data-value="#F8F9FB">
                        <div class="color-preview" style="background-color: #F8F9FB;"></div>
                        <span class="color-label" data-i18n="appearance.messageColors.text"></span>
                      </button>
                    </div>

                    <!-- Podsekcja: Bot -->
                    <div class="subsection-header" style="margin-top: 24px;" data-i18n="appearance.messageColors.bot"></div>
                    <div class="color-tiles-grid">
                      <button class="color-tile active" data-group="work" data-key="botBubble" data-value="#1E293B">
                        <div class="color-preview" style="background-color: #1E293B;"></div>
                        <span class="color-label" data-i18n="appearance.messageColors.bubble"></span>
                      </button>
                      <button class="color-tile" data-group="work" data-key="botText" data-value="#E2E8F0">
                        <div class="color-preview" style="background-color: #E2E8F0;"></div>
                        <span class="color-label" data-i18n="appearance.messageColors.text"></span>
                      </button>
                    </div>
                  </div>
                </div>

                <!-- 5️⃣ POZYCJA I WYMIARY -->
                <div class="config-section setting-card" data-role="acc-item" data-builder-step="position">
                  <div class="section-header">
                    <div class="section-icon"><i class="fas fa-ruler-combined"></i></div>
                    <div class="section-title">
                      <h3 data-i18n="appearance.sections.position.title"></h3>
                      <p data-i18n="appearance.sections.position.subtitle"></p>
                    </div>
                    <i class="fas fa-chevron-down arrow"></i>
                  </div>
                  <div class="section-content">
                    <!-- Pozycja -->
                    <div class="option-group">
                      <h4 data-i18n="appearance.position.onPage"></h4>
                      <div class="position-tiles">
                        <button class="position-tile position-bottom-left" data-group="device" data-key="position"
                          data-value="bottom-left">
                          <div class="position-preview">
                            <div class="position-indicator"></div>
                          </div>
                          <span class="position-label" data-i18n="appearance.position.bottomLeft"></span>
                        </button>
                        <button class="position-tile position-bottom-right active" data-group="device"
                          data-key="position" data-value="bottom-right">
                          <div class="position-preview">
                            <div class="position-indicator"></div>
                          </div>
                          <span class="position-label" data-i18n="appearance.position.bottomRight"></span>
                        </button>
                        <button class="position-tile position-top-left" data-group="device" data-key="position"
                          data-value="top-left">
                          <div class="position-preview">
                            <div class="position-indicator"></div>
                          </div>
                          <span class="position-label" data-i18n="appearance.position.topLeft"></span>
                        </button>
                        <button class="position-tile position-top-right" data-group="device" data-key="position"
                          data-value="top-right">
                          <div class="position-preview">
                            <div class="position-indicator"></div>
                          </div>
                          <span class="position-label" data-i18n="appearance.position.topRight"></span>
                        </button>
                      </div>
                    </div>

                    <div class="info-note"
                      style="margin-top: 14px; padding: 10px 12px; background: rgba(96,165,250,.1); border-radius: var(--dv-radius-sm); font-size: 11px; color: var(--dv-text);">
                      <i class="fas fa-info-circle" style="margin-right: 6px;"></i>
                      <span>Rozmiar widgetu jest ustawiany automatycznie dla Desktop i Mobile.</span>
                    </div>
                  </div>
                </div>

                <!-- 6️⃣ ANIMACJE -->
                <div class="config-section setting-card" data-role="acc-item" data-builder-step="animations">
                  <div class="section-header">
                    <div class="section-icon"><i class="fas fa-play-circle"></i></div>
                    <div class="section-title">
                      <h3 data-i18n="appearance.sections.animations.title"></h3>
                      <p data-i18n="appearance.sections.animations.subtitle"></p>
                    </div>
                    <i class="fas fa-chevron-down arrow"></i>
                  </div>
                  <div class="section-content">
                    <div class="option-group">
                      <h4 data-i18n="appearance.animations.style"></h4>
                      <div class="option-tiles">
                        <button class="option-tile active" data-group="work" data-key="animationPreset"
                          data-value="fade">
                          <div class="tile-preview">
                            <div class="animation-preview fade"></div>
                          </div>
                          <span class="tile-label" data-i18n="appearance.animations.fade"></span>
                        </button>
                        <button class="option-tile" data-group="work" data-key="animationPreset" data-value="slide">
                          <div class="tile-preview">
                            <div class="animation-preview slide"></div>
                          </div>
                          <span class="tile-label" data-i18n="appearance.animations.slide"></span>
                        </button>
                        <button class="option-tile" data-group="work" data-key="animationPreset" data-value="pop">
                          <div class="tile-preview">
                            <div
                              style="width:32px;height:24px;background:linear-gradient(90deg,rgba(168,85,247,.3),rgba(96,165,250,.3));border-radius:8px;">
                            </div>
                          </div>
                          <span class="tile-label" data-i18n="appearance.animations.pop"></span>
                        </button>
                      </div>
                    </div>
                    <div class="toggle-group">
                      <label class="toggle">
                        <input type="checkbox" checked data-group="work" data-key="animationEnabled">
                        <span class="toggle-slider"></span>
                        <span class="toggle-label" data-i18n="appearance.animations.enabled"></span>
                      </label>
                    </div>
                    <div class="form-group">
                      <button class="btn btn-secondary btn-sm" id="demoAnimationBtn">
                        <i class="fas fa-play"></i> <span data-i18n="appearance.animations.addDemo"></span>
                      </button>
                    </div>
                    <div class="info-note"
                      style="margin-top: 16px; padding: 12px; background: rgba(168,85,247,.1); border-radius: var(--dv-radius-sm); font-size: 11px; color: var(--dv-text);">
                      <i class="fas fa-info-circle" style="margin-right: 6px;"></i>
                      <span data-i18n="appearance.animations.note"></span>
                    </div>
                  </div>
                </div>

                <!-- 7️⃣ SZYBKIE ODPOWIEDZI -->
                <div class="config-section setting-card" data-role="acc-item" data-builder-step="advanced">
                  <div class="section-header">
                    <div class="section-icon"><i class="fas fa-bolt"></i></div>
                    <div class="section-title">
                      <h3 data-i18n="appearance.sections.quickReplies.title"></h3>
                      <p data-i18n="appearance.sections.quickReplies.subtitle"></p>
                    </div>
                    <i class="fas fa-chevron-down arrow"></i>
                  </div>
                  <div class="section-content">
                    <div id="quickRepliesEditor">
                      <!-- Rendered by JS -->
                    </div>
                    <button class="btn btn-secondary btn-sm" id="addQuickReply" style="margin-top: 12px;">
                      <i class="fas fa-plus"></i> <span data-i18n="appearance.quickReplies.add"></span>
                    </button>
                    <div class="toggle-group">
                      <label class="toggle">
                        <input type="checkbox" data-group="work" data-key="quickRepliesTop">
                        <span class="toggle-slider"></span>
                        <span class="toggle-label" data-i18n="appearance.quickReplies.showAbove"></span>
                      </label>
                    </div>
                    
                    <!-- Konfigurator wyglądu kafelków -->
                    <div class="subsection-header" style="margin-top: 24px;" data-i18n="appearance.quickReplies.tiles"></div>
                    <div class="option-group">
                      <h4 data-i18n="appearance.quickReplies.style"></h4>
                      <div class="option-tiles">
                        <button class="option-tile active" data-group="work" data-key="quickReplyStyle" data-value="filled">
                          <div class="tile-preview">
                            <div style="width:32px;height:16px;background:var(--dv-accent);border-radius:8px;"></div>
                          </div>
                          <span class="tile-label" data-i18n="appearance.quickReplies.filled"></span>
                        </button>
                        <button class="option-tile" data-group="work" data-key="quickReplyStyle" data-value="outline">
                          <div class="tile-preview">
                            <div style="width:32px;height:16px;background:transparent;border:2px solid var(--dv-accent);border-radius:8px;"></div>
                          </div>
                          <span class="tile-label" data-i18n="appearance.quickReplies.outline"></span>
                        </button>
                        <button class="option-tile" data-group="work" data-key="quickReplyStyle" data-value="ghost">
                          <div class="tile-preview">
                            <div style="width:32px;height:16px;background:rgba(139,92,246,.2);border-radius:8px;"></div>
                          </div>
                          <span class="tile-label" data-i18n="appearance.quickReplies.ghost"></span>
                        </button>
                      </div>
                    </div>
                    <div class="slider-group" style="margin-top: 16px;">
                      <div class="slider-container">
                        <label><span data-i18n="appearance.quickReplies.radius"></span> <span class="slider-value" data-for="work.quickReplyRadius">12px</span></label>
                        <input type="range" min="0" max="24" value="12" class="slider" data-group="work" data-key="quickReplyRadius" data-role="range">
                      </div>
                    </div>
                  </div>
                </div>

                <!-- 8️⃣ AVATAR CHATBOT (z watermark) -->
                <div class="config-section setting-card" data-role="acc-item" data-builder-step="branding">
                  <div class="section-header">
                    <div class="section-icon"><i class="fas fa-user-circle"></i></div>
                    <div class="section-title">
                      <h3 data-i18n="appearance.sections.avatar.title"></h3>
                      <p data-i18n="appearance.sections.avatar.subtitle"></p>
                    </div>
                    <i class="fas fa-chevron-down arrow"></i>
                  </div>
                  <div class="section-content">
                    <!-- Avatar -->
                    <div class="form-group">
                      <label data-i18n="appearance.avatar.botNameLabel"></label>
                      <input type="text" class="bot-name-input" id="botName" data-i18n-placeholder="appearance.avatar.botNamePlaceholder"
                        placeholder=""
                        value="">
                    </div>
                    <div class="option-group">
                      <h4 data-i18n="appearance.avatar.customAvatar"></h4>
                      <div class="avatar-upload-container">
                        <input type="file" accept="image/*" id="avatarUpload" hidden />
                        <div class="avatar-upload-buttons">
                          <button class="btn btn-secondary btn-sm" id="avatarUploadBtn">
                            <i class="fas fa-image"></i> <span data-i18n="appearance.avatar.upload"></span>
                          </button>
                          <button class="btn btn-secondary btn-sm" id="avatarRemoveBtn">
                            <i class="fas fa-trash"></i> <span data-i18n="appearance.avatar.remove"></span>
                          </button>
                        </div>
                        <div class="avatar-preview" id="avatarPreview">
                          <img src="/assets/logo.svg" alt="DaVeri logo">
                        </div>
                      </div>
                    </div>
                    <div class="toggle-group">
                      <label class="toggle">
                        <input type="checkbox" checked data-group="work" data-key="avatarEnabled">
                        <span class="toggle-slider"></span>
                        <span class="toggle-label" data-i18n="appearance.avatar.show"></span>
                      </label>
                    </div>

                    <!-- Watermark -->
                    <div class="subsection-header" style="margin-top: 24px;" data-i18n="appearance.avatar.watermark"></div>
                    <div class="toggle-group">
                      <label class="toggle">
                        <input type="checkbox" checked data-group="work" data-key="watermarkEnabled">
                        <span class="toggle-slider"></span>
                        <span class="toggle-label" data-i18n="appearance.avatar.showWatermark"></span>
                      </label>
                    </div>
                  </div>
                </div>

                <!-- 9️⃣ ZMINIMALIZOWANY CHAT -->
                <div class="config-section setting-card" data-role="acc-item" data-builder-step="advanced">
                  <div class="section-header">
                    <div class="section-icon"><i class="fas fa-window-minimize"></i></div>
                    <div class="section-title">
                      <h3 data-i18n="appearance.sections.minimized.title"></h3>
                      <p data-i18n="appearance.sections.minimized.subtitle"></p>
                    </div>
                    <i class="fas fa-chevron-down arrow"></i>
                  </div>
                  <div class="section-content">
                    <div class="toggle-group">
                      <label class="toggle">
                        <input type="checkbox" data-group="work" data-key="iconMode" id="iconModeToggle">
                        <span class="toggle-slider"></span>
                        <span class="toggle-label" data-i18n="appearance.minimized.enable"></span>
                      </label>
                    </div>
                    <p class="info-note"
                      style="margin: 16px 0; padding: 12px; background: rgba(168,85,247,.1); border-radius: var(--dv-radius-sm); font-size: 11px; color: var(--dv-text);">
                      <i class="fas fa-info-circle" style="margin-right: 6px;"></i>
                      <span data-i18n="appearance.minimized.note"></span>
                    </p>

                    <div class="option-group" style="margin-top: 16px;">
                      <h4 data-i18n="appearance.minimized.shape"></h4>
                      <div class="option-tiles">
                        <button class="option-tile active" data-group="work" data-key="iconShape" data-value="circle">
                          <div class="tile-preview">
                            <div
                              style="width: 32px; height: 32px; border-radius: 50%; background: var(--dv-grad); display: flex; align-items: center; justify-content: center;">
                              <i class="fas fa-comment" style="color: white; font-size: 14px;"></i>
                            </div>
                          </div>
                          <span class="tile-label" data-i18n="appearance.minimized.circle"></span>
                        </button>
                        <button class="option-tile" data-group="work" data-key="iconShape" data-value="rounded">
                          <div class="tile-preview">
                            <div
                              style="width: 32px; height: 32px; border-radius: 12px; background: var(--dv-grad); display: flex; align-items: center; justify-content: center;">
                              <i class="fas fa-comment" style="color: white; font-size: 14px;"></i>
                            </div>
                          </div>
                          <span class="tile-label" data-i18n="appearance.minimized.rounded"></span>
                        </button>
                        <button class="option-tile" data-group="work" data-key="iconShape" data-value="square">
                          <div class="tile-preview">
                            <div
                              style="width: 32px; height: 32px; border-radius: 6px; background: var(--dv-grad); display: flex; align-items: center; justify-content: center;">
                              <i class="fas fa-comment" style="color: white; font-size: 14px;"></i>
                            </div>
                          </div>
                          <span class="tile-label" data-i18n="appearance.minimized.square"></span>
                        </button>
                      </div>
                    </div>

                    <div class="option-group">
                      <h4 data-i18n="appearance.minimized.iconInner"></h4>
                      <div class="option-tiles">
                        <button class="option-tile active" data-group="work" data-key="iconType" data-value="robot">
                          <div class="tile-preview">
                            <i class="fas fa-robot" style="font-size: 20px; color: var(--dv-vio);"></i>
                          </div>
                          <span class="tile-label" data-i18n="appearance.minimized.icon.robot"></span>
                        </button>
                        <button class="option-tile" data-group="work" data-key="iconType" data-value="comment">
                          <div class="tile-preview">
                            <i class="fas fa-comment" style="font-size: 20px; color: var(--dv-vio);"></i>
                          </div>
                          <span class="tile-label" data-i18n="appearance.minimized.icon.bubble"></span>
                        </button>
                        <button class="option-tile" data-group="work" data-key="iconType" data-value="comments">
                          <div class="tile-preview">
                            <i class="fas fa-comments" style="font-size: 20px; color: var(--dv-vio);"></i>
                          </div>
                          <span class="tile-label" data-i18n="appearance.minimized.icon.bubbles"></span>
                        </button>
                        <button class="option-tile" data-group="work" data-key="iconType" data-value="headset">
                          <div class="tile-preview">
                            <i class="fas fa-headset" style="font-size: 20px; color: var(--dv-vio);"></i>
                          </div>
                          <span class="tile-label" data-i18n="appearance.minimized.icon.headset"></span>
                        </button>
                      </div>
                    </div>

                    <div class="slider-container" style="margin-top: 16px;">
                      <label>
                        <span data-i18n="appearance.minimized.iconSize"></span>
                        <span class="slider-value" id="iconSizeValue">56px</span>
                      </label>
                      <input type="range" class="slider" min="40" max="80" value="56" data-group="work"
                        data-key="iconSize" id="iconSizeSlider">
                    </div>

                    <div class="color-tiles-grid" style="margin-top: 16px;">
                      <button class="color-tile active" data-group="work" data-key="iconBackground"
                        data-value="#7C3AED">
                        <div class="color-preview" style="background-color: #7C3AED;"></div>
                        <span class="color-label" data-i18n="appearance.minimized.iconBackground"></span>
                      </button>
                      <button class="color-tile" data-group="work" data-key="iconColor" data-value="#FFFFFF">
                        <div class="color-preview" style="background-color: #FFFFFF;"></div>
                        <span class="color-label" data-i18n="appearance.minimized.iconColor"></span>
                      </button>
                    </div>

                    <div class="option-group" style="margin-top: 16px;">
                      <h4 data-i18n="appearance.minimized.customIcon"></h4>
                      <div class="avatar-upload-container">
                        <input type="file" accept="image/*" id="iconUpload" hidden />
                        <div class="avatar-upload-buttons">
                          <button class="btn btn-secondary btn-sm" id="iconUploadBtn">
                            <i class="fas fa-image"></i> <span data-i18n="appearance.minimized.uploadIcon"></span>
                          </button>
                          <button class="btn btn-secondary btn-sm" id="iconRemoveBtn">
                            <i class="fas fa-trash"></i> <span data-i18n="appearance.minimized.removeIcon"></span>
                          </button>
                        </div>
                        <div class="avatar-preview" id="iconPreview">
                          <i class="fas fa-image"></i>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </section>
          </div><!-- /config-column -->
          <div class="live-preview-column">
            <div class="preview-area appearance-preview-grid">
              <div class="preview-section live-preview-section">
                <div class="chat-preview-wrapper">
                  <div class="work-column chat-live-preview preview-chat-host">
                    <div class="preview-chat" id="workChat">
                      <div class="chat-window">
                        <div class="chat-header">
                          <div class="chat-brand">
                            <div class="chat-avatar" id="workChatAvatar"></div>
                            <div class="chat-info">
                              <div class="chat-name" id="workChatName" data-i18n="appearance.preview.botName"></div>
                              <div class="chat-status" data-i18n="appearance.preview.online"></div>
                            </div>
                          </div>
                          <div class="chat-actions">
                            <button class="close-btn" id="workChatCloseBtn" type="button">
                              <i class="fas fa-times"></i>
                            </button>
                          </div>
                        </div>
                        <div class="quick-replies-top" id="workQuickRepliesTop" style="display: none;"></div>
                        <div class="chat-messages" id="workChatMessages"></div>
                        <div class="quick-replies-bottom" id="workQuickRepliesBottom"></div>
                        <div class="chat-input">
                          <input type="text" data-i18n-placeholder="appearance.preview.inputPlaceholder" placeholder="" id="workChatInput">
                          <button class="send-btn" id="workSendBtn" type="button">
                            <i class="fas fa-paper-plane"></i>
                          </button>
                        </div>
                        <div class="chat-watermark" id="workChatWatermark">
                          <span class="watermark-label">Powered by</span>
                          <img class="watermark-icon" src="/assets/icons/logo.svg" alt="" />
                          <span class="watermark-brand">DaVeri</span>
                        </div>
                      </div>
                    </div>
                    <div class="chat-icon small" id="workChatIcon"
                      style="display: none; position: absolute; left: 32px; bottom: 32px;">
                      <img src="/assets/icons/logo.svg" alt="Chat launcher" />
                    </div>
                  </div>
                </div>
              </div>
            </div><!-- /preview-area -->
          </div><!-- /live-preview-column -->
          <div class="device-preview-column">
            <div class="preview-device-column">
              <div class="device-toggle" id="appearanceDeviceToggle">
                <button type="button" class="device-btn device-button device-toggle-btn active" data-device="desktop">Desktop</button>
                <button type="button" class="device-btn device-button device-toggle-btn" data-device="mobile">Mobile</button>
                <div id="monitorModeSwitch" hidden aria-hidden="true"></div>
              </div>
              <div class="device-preview-stage">
                <div class="preview-section device-preview-mode device-preview-mobile preview-mobile">
                  <div class="mobile-preview">
                    <div class="phone-frame">
                      <div class="mobile-chat-root preview-chat-host" id="mobileChatRoot"></div>
                    </div>
                    <div class="chat-icon small mobile-icon" id="mobileChatIcon" style="display: none;">
                      <img src="/assets/icons/logo.svg" alt="Chat launcher" />
                    </div>
                  </div>
                </div>
                <div class="preview-section device-preview-mode device-preview-desktop preview-desktop">
                  <div class="desktop-preview" id="desktopPreview">
                    <div class="monitor-frame" id="monitorFrame">
                      <div class="monitor-screen" id="monitorScreen">
                        <div class="monitor-viewport" id="monitorViewport">
                          <div class="monitor-chat preview-chat-host" id="monitorChat"></div>
                          <div class="chat-icon monitor-icon" id="monitorChatIcon" style="display: none;">
                            <img src="/assets/icons/logo.svg" alt="Chat launcher" />
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div><!-- /device-preview-column -->
        </div>
        <!-- Color Editor Modal -->
        <div class="color-editor-modal" id="colorEditor" hidden>
          <div class="modal-backdrop" data-role="editor-backdrop"></div>
          <div class="modal-content">
            <div class="modal-header">
              <h3 id="editorTitle" data-i18n="appearance.editor.title"></h3>
              <button class="modal-close" data-role="editor-close">
                <i class="fas fa-times"></i>
              </button>
            </div>
            <div class="modal-body">
              <div class="color-display">
                <div class="color-preview-large" data-role="editor-preview" style="background-color: #0F0F14;"></div>
                <div class="color-hex" data-role="editor-hex">#0F0F14</div>
              </div>
              <div class="color-controls">
                <label data-i18n="appearance.editor.pickColor"></label>
                <input type="color" class="color-input" data-role="editor-input" value="#0F0F14">
              </div>
              <div class="color-presets">
                <label data-i18n="appearance.editor.presets"></label>
                <div class="preset-grid" data-role="editor-presets">
                  <!-- Presets added by JS -->
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button class="btn btn-secondary" data-role="editor-close" data-i18n="appearance.editor.cancel"></button>
              <button class="btn btn-primary" data-role="editor-apply" data-i18n="appearance.editor.apply"></button>
            </div>
          </div>
        </div>
      </main>
    </div><!-- #main-content -->
  </div><!-- #page-wrapper -->
  <div id="appearance-i18n" style="display:none">
    <span id="i18n-appearance-default-bot-name" data-i18n="appearance.defaults.botName"></span>
    <span id="i18n-appearance-default-watermark" data-i18n="appearance.defaults.watermark"></span>
    <span id="i18n-appearance-default-avatar" data-i18n="appearance.defaults.avatar"></span>
    <span id="i18n-appearance-brand-name" data-i18n="appearance.defaults.brandName"></span>
    <span id="i18n-appearance-quick-default-1" data-i18n="appearance.defaults.quickReplyOne"></span>
    <span id="i18n-appearance-quick-default-2" data-i18n="appearance.defaults.quickReplyTwo"></span>
    <span id="i18n-appearance-quick-placeholder" data-i18n="appearance.quickReplies.placeholder"></span>
    <span id="i18n-appearance-quick-new" data-i18n="appearance.quickReplies.newMessage"></span>
    <span id="i18n-appearance-welcome-bot" data-i18n="appearance.defaults.welcomeBot"></span>
    <span id="i18n-appearance-welcome-user" data-i18n="appearance.defaults.welcomeUser"></span>
    <span id="i18n-appearance-auto-1" data-i18n="appearance.defaults.autoReplyOne"></span>
    <span id="i18n-appearance-auto-2" data-i18n="appearance.defaults.autoReplyTwo"></span>
    <span id="i18n-appearance-auto-3" data-i18n="appearance.defaults.autoReplyThree"></span>
    <span id="i18n-appearance-auto-4" data-i18n="appearance.defaults.autoReplyFour"></span>
    <span id="i18n-appearance-auto-5" data-i18n="appearance.defaults.autoReplyFive"></span>
    <span id="i18n-appearance-animation-prefix" data-i18n="appearance.animations.demoPrefix"></span>
    <span id="i18n-appearance-scale-chat" data-i18n="appearance.scale.chatLabel"></span>
    <span id="i18n-appearance-scale-scale" data-i18n="appearance.scale.scaleLabel"></span>
    <span id="i18n-appearance-scale-fullscreen" data-i18n="appearance.scale.fullscreen"></span>
    <span id="i18n-appearance-scale-mobile" data-i18n="appearance.scale.mobile"></span>
    <span id="i18n-appearance-scale-fullscreen-short" data-i18n="appearance.scale.fullscreenShort"></span>
    <span id="i18n-appearance-scale-fit" data-i18n="appearance.scale.fit"></span>
    <span id="i18n-appearance-alert-load-success" data-i18n="appearance.alerts.loadSuccess"></span>
    <span id="i18n-appearance-alert-load-error" data-i18n="appearance.alerts.loadError"></span>
    <span id="i18n-appearance-preset-custom-desc" data-i18n="appearance.presets.customDesc"></span>
    <span id="i18n-appearance-preset-sales-desc" data-i18n="appearance.presets.salesDesc"></span>
    <span id="i18n-appearance-preset-support-desc" data-i18n="appearance.presets.supportDesc"></span>
    <span id="i18n-appearance-editor-chat-bg" data-i18n="appearance.chatUi.background"></span>
    <span id="i18n-appearance-editor-chat-header" data-i18n="appearance.chatUi.header"></span>
    <span id="i18n-appearance-editor-chat-input" data-i18n="appearance.chatUi.input"></span>
    <span id="i18n-appearance-editor-chat-accent" data-i18n="appearance.chatUi.accent"></span>
    <span id="i18n-appearance-editor-user-bubble" data-i18n="appearance.messageColors.userBubble"></span>
    <span id="i18n-appearance-editor-user-text" data-i18n="appearance.messageColors.userText"></span>
    <span id="i18n-appearance-editor-bot-bubble" data-i18n="appearance.messageColors.botBubble"></span>
    <span id="i18n-appearance-editor-bot-text" data-i18n="appearance.messageColors.botText"></span>
    <span id="i18n-appearance-editor-icon-bg" data-i18n="appearance.minimized.iconBackground"></span>
    <span id="i18n-appearance-editor-icon-color" data-i18n="appearance.minimized.iconColor"></span>
    <span id="i18n-appearance-editor-prefix" data-i18n="appearance.editor.editPrefix"></span>
    <span id="i18n-appearance-sales-quick-1" data-i18n="appearance.presets.salesQuickOne"></span>
    <span id="i18n-appearance-sales-quick-2" data-i18n="appearance.presets.salesQuickTwo"></span>
    <span id="i18n-appearance-sales-quick-3" data-i18n="appearance.presets.salesQuickThree"></span>
    <span id="i18n-appearance-sales-quick-4" data-i18n="appearance.presets.salesQuickFour"></span>
    <span id="i18n-appearance-support-quick-1" data-i18n="appearance.presets.supportQuickOne"></span>
    <span id="i18n-appearance-support-quick-2" data-i18n="appearance.presets.supportQuickTwo"></span>
    <span id="i18n-appearance-support-quick-3" data-i18n="appearance.presets.supportQuickThree"></span>
    <span id="i18n-appearance-support-quick-4" data-i18n="appearance.presets.supportQuickFour"></span>
  </div>
  <script>
    /* ==========================================================================
    Chat UI Configurator - FINALNA WERSJA PRODUKCYJNA SAAS - NAPRAWIONA
    ========================================================================== */
    (() => {
      "use strict";
      const ROOT_ID = "dv-configurator";
      const root = document.getElementById(ROOT_ID);
      if (!root) {
        console.error("Root element not found:", ROOT_ID);
        return;
      }
      const i18nText = (idOrKey) => {
        const byId = document.getElementById(idOrKey);
        if (byId) return byId.textContent || "";
        const byKey = document.querySelector(`[data-i18n="${idOrKey}"]`);
        return byKey?.textContent || "";
      };
      const ACTIVE_BOT_KEY = "daveri_active_bot_id";
      const WATERMARK_BRAND = "DaVeri";
      const WATERMARK_ICON = "/assets/icons/logo.svg";
      const DEFAULT_BOT_AVATAR = "/assets/logo.svg";
      const FIXED_CHAT_DIMENSIONS = Object.freeze({ width: 360, height: 520 });
      const DESKTOP_STAGE_SIZE = Object.freeze({ width: 1440, height: 900 });
      const DEFAULT_LAUNCHER_ICON = "/assets/icons/logo.svg";
      const getDefaultStarterReplies = () => {
        const first = (i18nText("i18n-appearance-quick-default-1") || "Cennik / Pricing").trim();
        const second = (i18nText("i18n-appearance-quick-default-2") || "Kontakt / Contact").trim();
        return [first || "Cennik / Pricing", second || "Kontakt / Contact"];
      };
      const PREVIEW_DEMO_MESSAGES = Object.freeze([
        { type: "bot", text: "Hello! How can I help you today?", time: "12:00" },
        { type: "user", text: "Hi! I want to customize my chatbot.", time: "12:01" },
        { type: "bot", text: "Great! You can change colors, layout, and behavior in this panel.", time: "12:02" }
      ]);
      const escapeHtml = (value) =>
        String(value ?? "")
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#39;");
      const cloneDemoMessages = () => PREVIEW_DEMO_MESSAGES.map((msg) => ({ ...msg }));
      const getRenderableMessages = (messages) => {
        if (!Array.isArray(messages)) return cloneDemoMessages();
        const normalized = messages
          .map((entry) => ({
            type: entry?.type === "user" ? "user" : "bot",
            text: String(entry?.text || "").trim(),
            time: String(entry?.time || "").trim(),
          }))
          .filter((entry) => entry.text.length > 0);
        return normalized.length ? normalized : cloneDemoMessages();
      };
      const resolveAvatarUrl = (snapshot) => {
        const avatar = String(
          snapshot?.avatarImage ||
          snapshot?.avatar ||
          snapshot?.bot?.avatar ||
          ""
        ).trim();
        return avatar || DEFAULT_BOT_AVATAR;
      };
      const resolveApiOrigin = () => {
        if (typeof window.DaVeriApiOrigin === "string" && window.DaVeriApiOrigin.trim()) {
          return window.DaVeriApiOrigin.trim().replace(/\/$/, "");
        }
        const host = (window.location.hostname || "").toLowerCase();
        if (host === "api.daveri.io") return "";
        return "https://api.daveri.io";
      };
      const getApiUrl = (path) => {
        const normalized = path.startsWith("/") ? path : `/${path}`;
        const origin = resolveApiOrigin();
        return origin ? `${origin}${normalized}` : normalized;
      };
      const API_BOTS = getApiUrl("/api/bots");
      const extractBots = (payload) => {
        if (Array.isArray(payload)) return payload;
        if (Array.isArray(payload?.bots)) return payload.bots;
        if (Array.isArray(payload?.data)) return payload.data;
        return [];
      };
      const getBotDisplayName = (bot, index = 0) => {
        const fromName = String(bot?.name || "").trim();
        if (fromName) return fromName;
        const fromTitle = String(bot?.title || "").trim();
        if (fromTitle) return fromTitle;
        const fromBotName = String(bot?.bot_name || "").trim();
        if (fromBotName) return fromBotName;
        return `Bot ${bot?.id || index + 1}`;
      };
      const getStoredActiveBotId = () => {
        const raw = window.localStorage.getItem(ACTIVE_BOT_KEY);
        return raw && raw.trim() ? raw.trim() : null;
      };
      const setStoredActiveBotId = (botId) => {
        const value = typeof botId === "string" ? botId.trim() : "";
        if (!value) {
          window.localStorage.removeItem(ACTIVE_BOT_KEY);
          return;
        }
        window.localStorage.setItem(ACTIVE_BOT_KEY, value);
      };
      const fetchJson = async (url, options = {}) => {
        const method = String(options.method || "GET").toUpperCase();
        const headers = { ...(options.headers || {}) };
        if (method !== "GET" && method !== "HEAD" && !("Content-Type" in headers)) {
          headers["Content-Type"] = "application/json";
        }
        const response = await fetch(url, {
          credentials: "include",
          ...options,
          headers,
        });
        let payload = null;
        try {
          payload = await response.json();
        } catch {
          payload = null;
        }
        if (!response.ok) {
          throw new Error(payload?.error || `Request failed: ${response.status}`);
        }
        return payload;
      };
      const resolveActiveBotId = async () => {
        const stored = getStoredActiveBotId();
        const payload = await fetchJson(API_BOTS);
        const bots = extractBots(payload);
        if (!bots.length) {
          setStoredActiveBotId("");
          return null;
        }
        const hasStored = stored ? bots.some((bot) => String(bot?.id) === String(stored)) : false;
        const nextBotId = hasStored ? stored : String(bots[0]?.id || "");
        setStoredActiveBotId(nextBotId);
        return nextBotId || null;
      };

      async function initBotPicker() {
        const botSelect = document.getElementById("appearanceBotSelect");
        if (!botSelect) return;

        botSelect.disabled = true;
        botSelect.innerHTML = '<option value="">Loading bots...</option>';

        try {
          const payload = await fetchJson(API_BOTS);
          const bots = extractBots(payload);

          if (!bots.length) {
            setStoredActiveBotId("");
            botSelect.innerHTML = '<option value="">No bots</option>';
            botSelect.disabled = true;
            return;
          }

          const stored = getStoredActiveBotId();
          const hasStored = stored ? bots.some((bot) => String(bot?.id) === String(stored)) : false;
          const nextBotId = hasStored ? stored : String(bots[0]?.id || "");
          setStoredActiveBotId(nextBotId);

          botSelect.innerHTML = "";
          bots.forEach((bot, index) => {
            const option = document.createElement("option");
            option.value = String(bot?.id || "");
            option.textContent = getBotDisplayName(bot, index);
            botSelect.appendChild(option);
          });
          botSelect.value = nextBotId;
          botSelect.disabled = false;
        } catch (error) {
          console.error("[Appearance] bot picker init failed:", error);
          botSelect.innerHTML = '<option value="">Error loading bots</option>';
          botSelect.disabled = true;
        }

        if (!botSelect.__wired) {
          botSelect.__wired = true;
          botSelect.addEventListener("change", async () => {
            const nextBotId = String(botSelect.value || "").trim();
            if (!nextBotId) return;
            setStoredActiveBotId(nextBotId);
            await loadStateFromBackend();
          });
        }
      }

      function syncBotPickerSelection(botId) {
        const botSelect = document.getElementById("appearanceBotSelect");
        if (!botSelect) return;
        const value = String(botId || "").trim();
        if (!value) return;
        const optionExists = Array.from(botSelect.options).some((opt) => opt.value === value);
        if (optionExists) {
          botSelect.value = value;
        }
      }
      const waitForAuthReady = async () => {
        if (window.DaVeriAuth?.ready) {
          try {
            await window.DaVeriAuth.ready;
          } catch {}
          return;
        }
        await new Promise((resolve) => {
          let done = false;
          const finish = () => {
            if (done) return;
            done = true;
            resolve();
          };
          document.addEventListener("auth:ready", finish, { once: true });
          document.addEventListener("auth:failed", finish, { once: true });
          window.setTimeout(finish, 1800);
        });
      };
      /* ========== DANE PRESETÓW ========== */
      const PRESET_BACKGROUNDS = {
        sales: 'https://d98a890ebc03293bc70c4f2e92e9e2e5.cdn.bubble.io/f1769988404088x184638242248941000/8k%20white%20opal%20liquid%20glass%20prisma%20%20background%20%281%29.jpg',
        support: 'https://d98a890ebc03293bc70c4f2e92e9e2e5.cdn.bubble.io/f1769988406812x536571790714338370/Minimal%20dark%20background%20with%20subtle%20grain%20texture%2C%20modern%20SaaS%20UI%20style%2C%20%2Celegant%20and%20professional%2C%20soft%20lighting%2C%20abstract%2C%20premium%20software%20background%2C%20with%20red%20marmour%20lightnighs.jpg',
        custom: 'https://d98a890ebc03293bc70c4f2e92e9e2e5.cdn.bubble.io/f1769988400022x612783169203748500/8k%20dark%20green%20opal%20liquid%20glass%20background.jpg'
      };
      /* ========== JEDNO ŹRÓDŁO PRAWDY: workState ========== */
      const defaultWorkState = Object.freeze({
        // 1️⃣ WYGLĄD OGÓLNY
        windowPreset: "medium",
        windowRadius: 12,
        bubblePreset: "pill",
        bubbleRadius: 20,
        fontFamily: "system",
        fontSize: 14,
        // 2️⃣ KOLORY I TŁO
        colors: {
          chatBackground: "#0F0F14",
          chatHeader: "#1A1A20",
          chatInput: "#1A1A20",
          chatAccent: "#7C3AED",
          userBubble: "#7C3AED",
          userText: "#F8F9FB",
          botBubble: "#1E293B",
          botText: "#E2E8F0"
        },
        // Tło chatu
        backgroundType: "color", // "color", "image", "preset"
        backgroundImage: null,
        backgroundPreset: null,
        backgroundOverlay: 0, // 0-70%
        // 4️⃣ INTERAKCJE
        animationPreset: "fade",
        animationEnabled: true,
      quickReplies: {
        messages: getDefaultStarterReplies(),
        top: false
      },
      quickReplyStyle: "filled",
      quickReplyRadius: 12,
        // 5️⃣ BRANDING
        watermarkEnabled: true,
        watermarkText: i18nText("i18n-appearance-default-watermark"),
        avatarEnabled: true,
        avatarImage: null,
        botName: i18nText("i18n-appearance-default-bot-name"),
        // 6️⃣ IKONA (zwinięty chat)
        iconMode: false,
        iconShape: "circle", // circle, rounded, square
        iconType: "robot", // robot, comment, comments, headset
        iconSize: 56,
        iconBackground: "#7C3AED",
        iconColor: "#FFFFFF",
        iconImage: null,
        // Wiadomości w chat
        messages: []
      });
      const defaultDeviceState = Object.freeze({
        // 3️⃣ UKŁAD
        width: FIXED_CHAT_DIMENSIONS.width,
        height: FIXED_CHAT_DIMENSIONS.height,
        position: "bottom-right",
        deviceType: "desktop"
      });
      /* ========== PRESETY - KOMPLETNE ZESTAWY ========== */
      const presets = {
        custom: {
          name: i18nText("appearance.presets.custom"),
          description: i18nText("i18n-appearance-preset-custom-desc"),
          // Custom nie ustawia nic - użytkownik sam wszystko konfiguruje
        },
        sales: {
          name: i18nText("appearance.presets.sales"),
          description: i18nText("i18n-appearance-preset-sales-desc"),
          settings: {
            colors: {
              chatBackground: "#ffffff",
              chatHeader: "#f8fafc",
              chatInput: "#f8fafc",
              chatAccent: "#f59e0b",
              userBubble: "#3b82f6",
              userText: "#ffffff",
              botBubble: "#1e293b",
              botText: "#f1f5f9"
            },
            backgroundType: "preset",
            backgroundPreset: "sales",
            backgroundOverlay: 20,
            animationPreset: "pop",
            animationEnabled: true,
            quickReplies: {
              messages: [
                i18nText("i18n-appearance-sales-quick-1"),
                i18nText("i18n-appearance-sales-quick-2"),
                i18nText("i18n-appearance-sales-quick-3"),
                i18nText("i18n-appearance-sales-quick-4")
              ],
              top: false
            },
            watermarkEnabled: true,
            watermarkText: i18nText("i18n-appearance-default-watermark")
          }
        },
        support: {
          name: i18nText("appearance.presets.support"),
          description: i18nText("i18n-appearance-preset-support-desc"),
          settings: {
            colors: {
              chatBackground: "#0f172a",
              chatHeader: "#1e293b",
              chatInput: "#1e293b",
              chatAccent: "#06b6d4",
              userBubble: "#06b6d4",
              userText: "#ffffff",
              botBubble: "#334155",
              botText: "#e2e8f0"
            },
            backgroundType: "preset",
            backgroundPreset: "support",
            backgroundOverlay: 40,
            animationPreset: "fade",
            animationEnabled: false,
            quickReplies: {
              messages: [
                i18nText("i18n-appearance-support-quick-1"),
                i18nText("i18n-appearance-support-quick-2"),
                i18nText("i18n-appearance-support-quick-3"),
                i18nText("i18n-appearance-support-quick-4")
              ],
              top: true
            },
            watermarkEnabled: false,
            watermarkText: ""
          }
        }
      };
      const deepClone = (obj) => JSON.parse(JSON.stringify(obj));
      // STANY
      let workState = deepClone(defaultWorkState);
      let deviceState = deepClone(defaultDeviceState);
      // Inicjalizuj wiadomości demo widoczne zawsze w preview.
      workState.messages = cloneDemoMessages();
      const subscribers = new Set();
      let lockAccordion = false;
      let currentColorKey = null;
      let currentPreset = "custom";
      /* ========== PUBLICZNE API ========== */
      function notify() {
        const workSnapshot = deepClone(workState);
        const deviceSnapshot = deepClone(deviceState);
        syncUISelectionStates(workSnapshot, deviceSnapshot);
        updateWorkChat(workSnapshot);
        updateDeviceChat(workSnapshot, deviceSnapshot);
        renderQuickReplies(workSnapshot);
        renderQuickRepliesEditor(workSnapshot);
        renderChatIcon(workSnapshot);
        updateDeviceType();
        updateScaleInfo();
        updateScaleOverlay();
        updatePresetBar();
        // ZASTOSUJ POZYCJĘ CHATU
        applyChatPosition();
        // Sync device frame clones
        syncDeviceFrameClones(workSnapshot, deviceSnapshot);
        subscribers.forEach((cb) => {
          try {
            cb({ work: workSnapshot, device: deviceSnapshot });
          } catch (e) {
            console.error("[StateEngine] subscriber error:", e);
          }
        });
      }
      function setWorkOption(key, value) {
        // Setting work option
        const next = deepClone(workState);
        if (key === 'quickRepliesTop') {
          key = 'quickReplies.top';
        }
        // Obsługa zagnieżdżonych właściwości
        const keys = key.split('.');
        if (keys.length === 1) {
          next[key] = value;
        } else if (keys.length === 2) {
          if (keys[0] === 'colors') {
            if (!next.colors) next.colors = {};
            next.colors[keys[1]] = value;
          } else if (keys[0] === 'quickReplies') {
            if (!next.quickReplies) next.quickReplies = {};
            next.quickReplies[keys[1]] = value;
          }
        } else if (keys.length === 3) {
          if (keys[0] === 'quickReplies') {
            if (!next.quickReplies) next.quickReplies = {};
            if (!next.quickReplies[keys[1]]) next.quickReplies[keys[1]] = {};
            next.quickReplies[keys[1]][keys[2]] = value;
          }
        }
        if (key === 'quickReplies.messages') {
          const normalizedReplies = Array.isArray(value)
            ? value.map((entry) => String(entry || '').trim()).filter(Boolean)
            : [];
          next.quickReplies.messages = normalizedReplies.length
            ? normalizedReplies
            : getDefaultStarterReplies();
        }
        // Automatyczne przełączenie na preset "Custom" przy ręcznej zmianie
        if (currentPreset !== "custom") {
          const changedSetting = keys[keys.length - 1];
          const ignoreKeys = ['messages', 'avatarImage', 'botName'];
          if (!ignoreKeys.includes(changedSetting)) {
            setPreset("custom");
          }
        }
        // Presety dla kształtów
        if (key === "windowPreset") {
          const presetMap = { soft: 24, medium: 12, hard: 4 };
          next.windowRadius = presetMap[value] || 12;
        }
        if (key === "bubblePreset") {
          const presetMap = { pill: 40, rounded: 12, compact: 6 };
          next.bubbleRadius = presetMap[value] || 20;
        }
        // Obsługa tła
        if (key === "backgroundType" && value !== "image") {
          next.backgroundImage = null;
          const bgPreview = document.getElementById('bgPreview');
          if (bgPreview) {
            bgPreview.style.backgroundImage = 'none';
            bgPreview.querySelector('.bg-preview-overlay').textContent = i18nText("appearance.chatUi.previewLabel");
          }
        }
        // Obsługa avatara
        if (key === "avatarImage") {
          if (value) {
            applyAvatarToChats(value);
          } else {
            resetAvatarToDefault();
          }
        }
        // Obsługa nazwy bota
        if (key === "botName") {
          updateBotName(value);
        }
        // Obsługa watermark
        if (key === "watermarkText") {
          updateWatermarkText(value);
        }
        workState = next;
        notify();
      }
      function setDeviceOption(key, value) {
        // Setting device option
        const next = deepClone(deviceState);
        if (key === 'width' || key === 'height') {
          const numeric = Number(value);
          if (Number.isFinite(numeric)) {
            next[key] = Math.max(180, Math.round(numeric));
          }
        } else {
          next[key] = value;
        }
        deviceState = next;
        // Natychmiastowa aktualizacja
        if (key === 'width' || key === 'height') {
          updateDeviceChatSize();
        }
        if (key === 'position') {
          applyChatPosition();
        }
        if (key === 'deviceType') {
          updateDeviceType();
        }
        notify();
      }
      function setOption(group, key, value) {
        if (group === "work") {
          setWorkOption(key, value);
        } else if (group === "device") {
          setDeviceOption(key, value);
        }
      }
      function setPreset(presetId) {
        if (!presets[presetId] || presetId === "custom") {
          currentPreset = "custom";
          updatePresetBar();
          return;
        }
        currentPreset = presetId;
        const preset = presets[presetId];
        // Zastosuj wszystkie ustawienia z presetu
        if (preset.settings) {
          Object.keys(preset.settings).forEach(category => {
            if (category === 'colors') {
              Object.keys(preset.settings.colors).forEach(colorKey => {
                setWorkOption(`colors.${colorKey}`, preset.settings.colors[colorKey]);
              });
            } else if (category === 'quickReplies') {
              Object.keys(preset.settings.quickReplies).forEach(qrKey => {
                setWorkOption(`quickReplies.${qrKey}`, preset.settings.quickReplies[qrKey]);
              });
            } else {
              setWorkOption(category, preset.settings[category]);
            }
          });
        }
        updatePresetBar();
      }
      function exportState() {
        return JSON.stringify({
          work: workState,
          device: deviceState,
          preset: currentPreset
        });
      }
      function importState(json) {
        try {
          const parsed = typeof json === "string" ? JSON.parse(json) : json;
          if (!parsed || typeof parsed !== 'object') return false;
          if (parsed.work) {
            workState = deepClone(defaultWorkState);
            Object.keys(parsed.work).forEach(key => {
              if (workState[key] !== undefined && key !== 'messages') {
                workState[key] = parsed.work[key];
              }
            });
            // Przywróć wiadomości jeśli są
            if (parsed.work.messages && Array.isArray(parsed.work.messages)) {
              workState.messages = getRenderableMessages(parsed.work.messages);
            }
          }
          if (parsed.device) {
            deviceState = deepClone(defaultDeviceState);
            Object.keys(parsed.device).forEach(key => {
              if (deviceState[key] !== undefined) {
                deviceState[key] = parsed.device[key];
              }
            });
            deviceState.width = Number(deviceState.width) || FIXED_CHAT_DIMENSIONS.width;
            deviceState.height = Number(deviceState.height) || FIXED_CHAT_DIMENSIONS.height;
          }
          if (parsed.preset) {
            currentPreset = parsed.preset;
          }
          // Zastosuj wizualizacje
          applyAvatarToChats(workState.avatarImage);
          updateBotName(workState.botName);
          updateWatermarkText(workState.watermarkText);
          notify();
          return true;
        } catch (e) {
          console.error("Import error:", e);
          return false;
        }
      }
      /* ========== BINDOWANIE EVENTÓW ========== */
      function bindEvents() {
        root.addEventListener("click", (e) => {
          const target = e.target instanceof Element ? e.target : null;
          if (!target) return;
          // Toggle switches
          if (target.closest('.toggle-slider') || target.closest('.toggle-label')) {
            e.preventDefault();
            const toggle = target.closest('.toggle');
            if (!toggle) return;
            const checkbox = toggle.querySelector('input[type="checkbox"]');
            if (!checkbox) return;
            checkbox.checked = !checkbox.checked;
            checkbox.dispatchEvent(new Event('change', { bubbles: true }));
            return;
          }
          // Accordion
          const header = target.closest('.section-header');
          const content = target.closest('.section-content');
          if (header && !content && !lockAccordion) {
            const section = header.closest('.config-section');
            if (section) toggleStep(section);
            return;
          }
          // Option tiles
          const tile = target.closest("[data-group][data-key][data-value]");
          if (tile && root.contains(tile) && tile.tagName === "BUTTON") {
            e.preventDefault();
            const { group, key } = resolveGroupKeyFromEl(tile);
            const value = readValueFromEl(tile);
            if (group && key && value !== null) {
              setOption(group, key, value);
            }
            return;
          }
          // Color tiles - NAPRAWA: teraz działa poprawnie!
          const colorTile = target.closest(".color-tile");
          if (colorTile && root.contains(colorTile)) {
            e.preventDefault();
            const key = colorTile.getAttribute("data-key");
            if (key) {
              // NAPRAWA: otwieramy edytor kolorów
              openColorEditor(key);
            }
            return;
          }
          // Background options
          const bgOption = target.closest(".bg-option");
          if (bgOption) {
            e.preventDefault();
            const bgType = bgOption.getAttribute("data-bg-type");
            const bgImage = bgOption.getAttribute("data-bg-image");
            // Usuń aktywność z wszystkich opcji
            document.querySelectorAll('.bg-option').forEach(opt => {
              opt.classList.remove('active');
            });
            // Aktywuj wybraną opcję
            bgOption.classList.add('active');
            if (bgType === "color") {
              setWorkOption('backgroundType', 'color');
              setWorkOption('backgroundImage', null);
              setWorkOption('backgroundPreset', null);
            } else if (bgType === "image") {
              setWorkOption('backgroundType', 'preset');
              setWorkOption('backgroundPreset', bgImage);
              setWorkOption('backgroundImage', null);
            }
            return;
          }
          // Position tiles
          const positionTile = target.closest(".position-tile");
          if (positionTile && root.contains(positionTile)) {
            e.preventDefault();
            const { group, key } = resolveGroupKeyFromEl(positionTile);
            const value = readValueFromEl(positionTile);
            if (group && key && value !== null) {
              setOption(group, key, value);
            }
            return;
          }
          // Preset segments
          const presetSegment = target.closest('.preset-segment:not(:first-child)');
          if (presetSegment) {
            const presetId = presetSegment.getAttribute('data-preset');
            if (presetId) {
              setPreset(presetId);
              e.preventDefault();
            }
            return;
          }
          // Device buttons
          const deviceBtn = target.closest('.device-btn');
          if (deviceBtn) {
            const deviceType = deviceBtn.getAttribute('data-device');
            setDeviceOption('deviceType', deviceType);
            e.preventDefault();
            return;
          }
          // Demo animation button
          if (target.closest('#demoAnimationBtn')) {
            addAnimationDemoMessage();
            e.preventDefault();
            return;
          }
          // Send message button
          if (target.closest('#workSendBtn') || target.closest('#workSendBtn i')) {
            sendWorkMessage();
            e.preventDefault();
            return;
          }
          // Quick reply buttons
          const quickReplyBtn = target.closest('#workQuickRepliesTop button, #workQuickRepliesBottom button');
          if (quickReplyBtn) {
            const message = quickReplyBtn.textContent;
            simulateQuickReply(message);
            e.preventDefault();
            return;
          }
          // Close button
          if (target.closest('#workChatCloseBtn')) {
            e.preventDefault();
            setWorkOption('iconMode', true);
            return;
          }
        }, { passive: false });
        root.addEventListener("change", (e) => {
          const el = e.target;
          if (!(el instanceof Element) || !root.contains(el)) return;
          // Checkboxes
          if (el instanceof HTMLInputElement && el.type === "checkbox") {
            const group = el.getAttribute("data-group");
            const key = el.getAttribute("data-key");
            if (group && key) {
              setOption(group, key, el.checked);
            }
            return;
          }
          // Selects
          if (el instanceof HTMLSelectElement) {
            const group = el.getAttribute("data-group");
            const key = el.getAttribute("data-key");
            if (group && key) {
              setOption(group, key, el.value);
            }
            return;
          }
          // Bot name input
          if (el.id === "botName") {
            setWorkOption("botName", el.value);
            return;
          }
          // Watermark text input
          if (el.id === "watermarkText") {
            setWorkOption("watermarkText", el.value);
            return;
          }
          // Background overlay slider
          if (el.id === "bgOverlaySlider") {
            const value = parseInt(el.value, 10);
            setWorkOption("backgroundOverlay", value);
            document.getElementById('overlayValue').textContent = `${value}%`;
            return;
          }
        });
        root.addEventListener("input", (e) => {
          const el = e.target;
          if (!(el instanceof Element) || !root.contains(el)) return;
          // Range sliders
          if (el instanceof HTMLInputElement && el.type === "range") {
            const group = el.getAttribute("data-group");
            const key = el.getAttribute("data-key");
            if (group && key) {
              const value = parseInt(el.value, 10);
              setOption(group, key, value);
              const valueSpan = root.querySelector(
                `.slider-value[data-for="${group}.${key}"]`
              );
              if (valueSpan) valueSpan.textContent = `${value}px`;
            }
          }
          // Color input w edytorze
          if (el.type === "color" && el.hasAttribute('data-role')) {
            const preview = document.querySelector('[data-role="editor-preview"]');
            const hex = document.querySelector('[data-role="editor-hex"]');
            if (preview) preview.style.backgroundColor = el.value;
            if (hex) hex.textContent = el.value.toUpperCase();
          }
        });
        // Enter key in chat input
        const workChatInput = document.getElementById('workChatInput');
        if (workChatInput) {
          workChatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
              sendWorkMessage();
              e.preventDefault();
            }
          });
        }
        // NAPRAWA: inicjalizacja edytora kolorów
        initColorEditor();
        initBackgroundImage();
        initAvatarUpload();
        initQuickReplies();
        initSaveLoad();
      }
      function resolveGroupKeyFromEl(el) {
        const group = el.getAttribute("data-group");
        const key = el.getAttribute("data-key");
        return { group, key };
      }
      function readValueFromEl(el) {
        const dv = el.getAttribute("data-value");
        if (dv !== null) return dv;
        if (el instanceof HTMLInputElement) {
          if (el.type === "checkbox") return !!el.checked;
          if (el.type === "range" || el.type === "number") return parseInt(el.value, 10);
          if (el.type === "color") return el.value;
          return el.value;
        }
        if (el instanceof HTMLSelectElement) {
          return el.value;
        }
        return null;
      }
      /* ========== ACCORDION ========== */
      function getAllSteps() {
        return Array.from(root.querySelectorAll(".config-section"));
      }
      function toggleStep(stepEl) {
        if (!(stepEl instanceof Element)) return;
        const isActive = stepEl.classList.contains("active");
        if (isActive) {
          stepEl.classList.remove("active");
          const content = stepEl.querySelector(".section-content");
          if (content) content.style.maxHeight = "0";
        } else {
          getAllSteps().forEach((step) => {
            if (step !== stepEl) {
              step.classList.remove("active");
              const content = step.querySelector(".section-content");
              if (content) content.style.maxHeight = "0";
            }
          });
          stepEl.classList.add("active");
          const content = stepEl.querySelector(".section-content");
          if (content) content.style.maxHeight = content.scrollHeight + "px";
        }
      }
      function initAccordionDefault() {
        const steps = getAllSteps();
        if (!steps.length) return;
        if (steps[0]) {
          steps[0].classList.add("active");
          const content = steps[0].querySelector(".section-content");
          if (content) content.style.maxHeight = content.scrollHeight + "px";
        }
      }

      function setBuilderStep(stepKey) {
        const stepItems = Array.from(root.querySelectorAll('.step-item[data-step]'));
        const connectors = Array.from(root.querySelectorAll('.step-connector'));
        const sections = Array.from(root.querySelectorAll('.config-section[data-builder-step]'));
        if (!stepItems.length || !sections.length) return;

        const fallback = stepItems[0]?.getAttribute('data-step') || 'layout';
        const targetStep = stepItems.some((item) => item.getAttribute('data-step') === stepKey)
          ? stepKey
          : fallback;

        root.dataset.builderStep = targetStep;
        const activeIndex = stepItems.findIndex((item) => item.getAttribute('data-step') === targetStep);

        stepItems.forEach((item, index) => {
          const isActive = index === activeIndex;
          const isCompleted = index < activeIndex;
          item.classList.toggle('active', isActive);
          item.classList.toggle('completed', isCompleted);
          item.classList.toggle('upcoming', index > activeIndex);
          if (isActive) {
            item.setAttribute('aria-current', 'step');
          } else {
            item.removeAttribute('aria-current');
          }
        });

        connectors.forEach((connector, index) => {
          connector.classList.toggle('completed', index <= activeIndex);
        });

        const visibleSections = [];
        sections.forEach((section) => {
          const isVisible = section.getAttribute('data-builder-step') === targetStep;
          section.dataset.stepHidden = isVisible ? 'false' : 'true';
          section.hidden = !isVisible;

          if (isVisible) {
            visibleSections.push(section);
          } else {
            section.classList.remove('active');
            const content = section.querySelector('.section-content');
            if (content) content.style.maxHeight = '0';
          }
        });

        const existingActive = visibleSections.find((section) => section.classList.contains('active'));
        const sectionToOpen = existingActive || visibleSections[0] || null;

        visibleSections.forEach((section) => {
          if (section !== sectionToOpen) {
            section.classList.remove('active');
            const content = section.querySelector('.section-content');
            if (content) content.style.maxHeight = '0';
          }
        });

        if (sectionToOpen) {
          sectionToOpen.classList.add('active');
          const content = sectionToOpen.querySelector('.section-content');
          if (content) content.style.maxHeight = `${content.scrollHeight}px`;
        }
      }

      function initBuilderSteps() {
        const stepItems = Array.from(root.querySelectorAll('.step-item[data-step]'));
        if (!stepItems.length) return;

        stepItems.forEach((item) => {
          item.addEventListener('click', () => {
            setBuilderStep(item.getAttribute('data-step') || 'layout');
          });
        });

        const initialStep = root.dataset.builderStep || stepItems[0].getAttribute('data-step') || 'layout';
        setBuilderStep(initialStep);
      }

      function initDevicePreviewToggle() {
        const mode = deviceState.deviceType === 'mobile' ? 'mobile' : 'desktop';
        root.dataset.devicePreview = mode;
        root.classList.toggle('is-desktop', mode === 'desktop');
        root.classList.toggle('is-mobile', mode === 'mobile');
      }
      /* ========== SYNCHRONIZACJA UI ========== */
      function syncUISelectionStates(workSnapshot, deviceSnapshot) {
        // Option tiles
        const options = root.querySelectorAll("[data-group][data-key][data-value]");
        options.forEach((el) => {
          const group = el.getAttribute("data-group");
          const key = el.getAttribute("data-key");
          const raw = el.getAttribute("data-value");
          const val = raw;
          let current;
          if (group === "work") {
            // Obsługa zagnieżdżonych właściwości
            if (key.startsWith('colors.')) {
              const colorKey = key.replace('colors.', '');
              current = workSnapshot.colors?.[colorKey];
            } else {
              current = workSnapshot[key];
            }
          } else if (group === "device") {
            current = deviceSnapshot[key];
          }
          const selected = current === val;
          if (selected) {
            el.classList.add("active");
          } else {
            el.classList.remove("active");
          }
        });
        // Color tiles - synchronizacja aktywnego koloru i filla kafelka
        const colorTiles = root.querySelectorAll(".color-tile");
        colorTiles.forEach((tile) => {
          const key = tile.getAttribute("data-key");
          if (!key) return;

          let currentColor = null;
          if (workSnapshot.colors && Object.prototype.hasOwnProperty.call(workSnapshot.colors, key)) {
            currentColor = workSnapshot.colors[key];
          } else if (Object.prototype.hasOwnProperty.call(workSnapshot, key)) {
            currentColor = workSnapshot[key];
          } else {
            currentColor = tile.getAttribute("data-value");
          }

          if (!currentColor) return;
          tile.setAttribute("data-value", currentColor);
          tile.style.setProperty("--tile-color", currentColor);

          const preview = tile.querySelector(".color-preview");
          if (preview) {
            preview.style.backgroundColor = currentColor;
          }
        });
        // Checkboxes
        const checkboxes = root.querySelectorAll("input[type='checkbox'][data-group][data-key]");
        checkboxes.forEach((checkbox) => {
          const group = checkbox.getAttribute("data-group");
          const key = checkbox.getAttribute("data-key");
          let current;
          if (group === "work") {
            current = key === 'quickRepliesTop'
              ? !!workSnapshot.quickReplies?.top
              : workSnapshot[key];
          } else if (group === "device") {
            current = deviceSnapshot[key];
          }
          if (current !== undefined) {
            checkbox.checked = !!current;
          }
        });
        // Sliders
        const sliders = root.querySelectorAll("input[type='range'][data-group][data-key]");
        sliders.forEach((slider) => {
          const group = slider.getAttribute("data-group");
          const key = slider.getAttribute("data-key");
          let current;
          if (group === "work") {
            current = workSnapshot[key];
          } else if (group === "device") {
            current = deviceSnapshot[key];
          }
          if (current !== undefined) {
            slider.value = String(current);
            const valueSpan = root.querySelector(`.slider-value[data-for="${group}.${key}"]`);
            if (valueSpan) {
              valueSpan.textContent = `${current}px`;
            }
          }
        });
        // Selects
        const selects = root.querySelectorAll("select[data-group][data-key]");
        selects.forEach((select) => {
          const group = select.getAttribute("data-group");
          const key = select.getAttribute("data-key");
          let current;
          if (group === "work") {
            current = workSnapshot[key];
          } else if (group === "device") {
            current = deviceSnapshot[key];
          }
          if (current !== undefined) {
            select.value = String(current);
          }
        });
        // Background overlay slider
        const overlaySlider = document.getElementById('bgOverlaySlider');
        const overlayValue = document.getElementById('overlayValue');
        if (overlaySlider && overlayValue) {
          overlaySlider.value = workSnapshot.backgroundOverlay || 0;
          overlayValue.textContent = `${workSnapshot.backgroundOverlay || 0}%`;
        }
        // Bot name input
        const botNameInput = document.getElementById('botName');
        if (botNameInput) {
          botNameInput.value = workSnapshot.botName || i18nText("i18n-appearance-default-bot-name");
        }
        // Watermark text input
        const watermarkInput = document.getElementById('watermarkText');
        if (watermarkInput) {
          watermarkInput.value = workSnapshot.watermarkText || i18nText("i18n-appearance-default-watermark");
        }
        // Background options
        updateBackgroundOptions(workSnapshot);
      }
      function updateBackgroundOptions(snapshot) {
        const bgOptions = document.querySelectorAll('.bg-option');
        bgOptions.forEach(option => {
          option.classList.remove('active');
        });
        if (snapshot.backgroundType === 'color') {
          const colorOption = document.querySelector('.bg-option[data-bg-type="color"]');
          if (colorOption) colorOption.classList.add('active');
        } else if (snapshot.backgroundType === 'preset' && snapshot.backgroundPreset) {
          const presetOption = document.querySelector(`.bg-option[data-bg-image="${snapshot.backgroundPreset}"]`);
          if (presetOption) presetOption.classList.add('active');
        }
      }
      /* ========== AKTUALIZACJA WORK CHAT ========== */
      function updateWorkChat(snapshot) {
        const workChat = document.getElementById('workChat');
        if (!workChat) return;

        const chatWindow = workChat.querySelector('.chat-window');
        workChat.style.width = '100%';
        workChat.style.height = '100%';

        if (snapshot?.windowRadius !== undefined) {
          workChat.style.borderRadius = `${snapshot.windowRadius}px`;
          if (chatWindow) chatWindow.style.borderRadius = `${snapshot.windowRadius}px`;
        }

        if (snapshot?.fontFamily) {
          const fontFamilyMap = {
            'system': "system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif",
            'inter': "'Inter', system-ui, sans-serif",
            'roboto': "'Roboto', 'Segoe UI', sans-serif",
            'open-sans': "'Open Sans', sans-serif",
            'montserrat': "'Montserrat', sans-serif",
            'poppins': "'Poppins', sans-serif",
            'sf-pro': "'SF Pro Display', -apple-system, BlinkMacSystemFont, sans-serif",
            'geist': "'Geist', 'Segoe UI', system-ui, sans-serif"
          };
          workChat.style.fontFamily = fontFamilyMap[snapshot.fontFamily] || fontFamilyMap.system;
        }

        if (snapshot?.fontSize) {
          workChat.style.setProperty('--chat-font-size', `${snapshot.fontSize}px`);
        }

        renderWorkChatMessages();
        applyColorsToChat(workChat, snapshot);
        updateChatBackground(workChat, snapshot);
        updateChatOverlay(workChat, snapshot);

        const watermark = workChat.querySelector('.chat-watermark');
        if (watermark) {
          watermark.style.display = snapshot.watermarkEnabled ? 'flex' : 'none';
          const brandElement = watermark.querySelector('.watermark-brand');
          if (brandElement) {
            brandElement.textContent = WATERMARK_BRAND;
          }
        }

        const avatar = workChat.querySelector('.chat-avatar');
        if (avatar) {
          avatar.style.display = snapshot.avatarEnabled ? 'flex' : 'none';
          avatar.innerHTML = snapshot.avatarEnabled
            ? `<img src="${escapeHtml(resolveAvatarUrl(snapshot))}" alt="">`
            : '';
        }
      }

      function applyColorsToChat(chatElement, snapshot) {
        if (!chatElement || !snapshot?.colors) return;
        const colors = snapshot.colors || {};
        const textColor = colors.botText || '#E2E8F0';
        const bubbleRadius = Number(snapshot?.bubbleRadius ?? 14);
        const chatWindow = chatElement.querySelector('.chat-window') || chatElement;

        chatWindow.style.backgroundColor = colors.chatBackground || '#0F0F14';
        chatWindow.style.color = textColor;

        const header = chatElement.querySelector('.chat-header');
        if (header) {
          header.style.backgroundColor = colors.chatHeader || '#1A1A20';
          header.style.color = textColor;
        }

        const messagesArea = chatElement.querySelector('.chat-messages');
        if (messagesArea) {
          messagesArea.style.backgroundColor = 'transparent';
          messagesArea.style.opacity = '1';
          messagesArea.style.visibility = 'visible';
        }

        const inputArea = chatElement.querySelector('.chat-input');
        if (inputArea) {
          inputArea.style.backgroundColor = 'rgba(0,0,0,0.08)';
          inputArea.style.borderTop = '1px solid rgba(255,255,255,0.08)';
        }

        const inputField = chatElement.querySelector('.chat-input input');
        if (inputField) {
          inputField.style.color = textColor;
          inputField.style.backgroundColor = colors.chatInput || '#1A1A20';
          inputField.style.borderColor = 'rgba(255,255,255,0.12)';
          inputField.style.opacity = '1';
          inputField.style.visibility = 'visible';
        }

        const sendBtn = chatElement.querySelector('.send-btn');
        if (sendBtn) {
          sendBtn.style.backgroundColor = colors.chatAccent || '#7C3AED';
        }

        chatElement.querySelectorAll('.message.message-bot .message-bubble').forEach((bubble) => {
          bubble.style.backgroundColor = colors.botBubble || 'rgba(255,255,255,0.05)';
          bubble.style.borderColor = 'rgba(255,255,255,0.08)';
          bubble.style.color = colors.botText || '#E2E8F0';
          bubble.style.borderRadius = `${bubbleRadius}px ${bubbleRadius}px ${bubbleRadius}px 4px`;
          bubble.style.opacity = '1';
          bubble.style.visibility = 'visible';
        });

        chatElement.querySelectorAll('.message.message-user .message-bubble').forEach((bubble) => {
          bubble.style.backgroundColor = colors.userBubble || 'rgba(139,92,246,0.18)';
          bubble.style.borderColor = colors.userBubble || '#7C3AED';
          bubble.style.color = colors.userText || '#F8F9FB';
          bubble.style.borderRadius = `${bubbleRadius}px ${bubbleRadius}px 4px ${bubbleRadius}px`;
          bubble.style.opacity = '1';
          bubble.style.visibility = 'visible';
        });

        const avatarUrl = resolveAvatarUrl(snapshot);
        chatElement.querySelectorAll('.message-avatar img, .chat-avatar img').forEach((img) => {
          img.setAttribute('src', avatarUrl);
        });

        const qrStyle = snapshot.quickReplyStyle || 'filled';
        const qrRadius = snapshot.quickReplyRadius !== undefined ? snapshot.quickReplyRadius : 12;
        chatElement.querySelectorAll('.quick-replies-top button, .quick-replies-bottom button').forEach((btn) => {
          btn.style.borderRadius = `${qrRadius}px`;
          if (qrStyle === 'filled') {
            btn.style.backgroundColor = colors.chatAccent || '#7C3AED';
            btn.style.border = 'none';
            btn.style.color = '#fff';
          } else if (qrStyle === 'outline') {
            btn.style.backgroundColor = 'transparent';
            btn.style.border = `2px solid ${colors.chatAccent || '#7C3AED'}`;
            btn.style.color = colors.chatAccent || '#7C3AED';
          } else if (qrStyle === 'ghost') {
            btn.style.backgroundColor = `${colors.chatAccent || '#7C3AED'}20`;
            btn.style.border = 'none';
            btn.style.color = colors.chatAccent || '#7C3AED';
          }
        });
      }

      function updateChatBackground(chatElement, snapshot) {
        if (!chatElement) return;
        const target = chatElement.querySelector('.chat-window') || chatElement;
        if (snapshot.backgroundType === 'preset' && snapshot.backgroundPreset) {
          const bgUrl = PRESET_BACKGROUNDS[snapshot.backgroundPreset];
          if (bgUrl) {
            target.style.backgroundImage = `url(${bgUrl})`;
            target.style.backgroundSize = 'cover';
            target.style.backgroundPosition = 'center';
          }
        } else if (snapshot.backgroundType === 'image' && snapshot.backgroundImage) {
          target.style.backgroundImage = `url(${snapshot.backgroundImage})`;
          target.style.backgroundSize = 'cover';
          target.style.backgroundPosition = 'center';
        } else {
          target.style.backgroundImage = 'none';
        }
      }

      function updateChatOverlay(chatElement, snapshot) {
        const chatWindow = chatElement?.querySelector('.chat-window');
        if (chatWindow) {
          const overlayAlpha = Math.max(0, Math.min(70, Number(snapshot?.backgroundOverlay || 0))) / 100;
          chatWindow.style.boxShadow = overlayAlpha > 0
            ? `inset 0 0 0 999px rgba(0, 0, 0, ${overlayAlpha})`
            : 'none';
        }
      }

      function applyPreviewTypography(chatElement, snapshot) {
        if (!chatElement || !snapshot) return;
        if (snapshot?.fontFamily) {
          const fontFamilyMap = {
            'system': "system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif",
            'inter': "'Inter', system-ui, sans-serif",
            'roboto': "'Roboto', 'Segoe UI', sans-serif",
            'open-sans': "'Open Sans', sans-serif",
            'montserrat': "'Montserrat', sans-serif",
            'poppins': "'Poppins', sans-serif",
            'sf-pro': "'SF Pro Display', -apple-system, BlinkMacSystemFont, sans-serif",
            'geist': "'Geist', 'Segoe UI', system-ui, sans-serif"
          };
          chatElement.style.fontFamily = fontFamilyMap[snapshot.fontFamily] || fontFamilyMap.system;
        }

        if (snapshot?.fontSize) {
          chatElement.style.setProperty('--chat-font-size', `${snapshot.fontSize}px`);
        }
      }

      function clonePreviewChatShell({ mobile } = {}) {
        const workChat = document.getElementById('workChat');
        if (!workChat) return null;
        const clone = workChat.cloneNode(true);
        clone.removeAttribute('id');
        clone.classList.remove('work-chat');
        clone.classList.add('preview-chat');
        if (mobile) {
          clone.classList.add('preview-chat--mobile');
        } else {
          clone.classList.remove('preview-chat--mobile');
        }
        clone.style.width = '100%';
        clone.style.height = '100%';
        clone.style.maxWidth = '100%';
        clone.style.maxHeight = '100%';
        clone.style.margin = '0';
        clone.querySelectorAll('[id]').forEach((node) => node.removeAttribute('id'));
        return clone;
      }

      function createPreviewMessageElement(message, snapshot, options = {}) {
        const type = message?.type === 'user' ? 'user' : 'bot';
        const text = String(message?.text || '').trim();
        const time = String(message?.time || '').trim();
        const row = document.createElement('div');
        row.className = `message message-${type}`;
        row.style.opacity = '1';
        row.style.visibility = 'visible';

        if (options.animateLast && workState.animationEnabled) {
          if (workState.animationPreset === 'fade') {
            row.classList.add('fade-animated');
          } else if (workState.animationPreset === 'slide') {
            row.classList.add('slide-animated');
          } else if (workState.animationPreset === 'pop') {
            row.classList.add('pop-animated');
          }
        }

        if (type === 'bot') {
          const avatar = document.createElement('div');
          avatar.className = 'message-avatar';
          avatar.innerHTML = `<img src="${escapeHtml(resolveAvatarUrl(snapshot))}" alt="">`;
          row.appendChild(avatar);
        }

        const bubble = document.createElement('div');
        bubble.className = 'message-bubble';
        bubble.textContent = text;
        bubble.style.opacity = '1';
        bubble.style.visibility = 'visible';
        row.appendChild(bubble);
        return row;
      }

      function renderWorkChatMessages() {
        const messagesContainer = document.getElementById('workChatMessages');
        if (!messagesContainer) return;
        messagesContainer.innerHTML = '';
        const renderable = getRenderableMessages(workState.messages);

        renderable.forEach((msg, index) => {
          const isLastMessage = index === renderable.length - 1;
          const node = createPreviewMessageElement(msg, workState, { animateLast: isLastMessage });
          messagesContainer.appendChild(node);
        });

        requestAnimationFrame(() => {
          messagesContainer.scrollTop = messagesContainer.scrollHeight;
        });
      }
      /* ========== AKTUALIZACJA DEVICE CHAT ========== */
      function updateDeviceChatSize() {
        const monitorChat = document.getElementById('monitorChat');
        if (monitorChat) {
          applyMonitorChatDimensions(monitorChat, deviceState);
          applyMonitorChatPosition(monitorChat, deviceState);
        }
        updateMonitorScale();
      }
      function updateDeviceType() {
        const monitorFrame = document.getElementById('monitorFrame');
        const deviceBtns = document.querySelectorAll('.device-btn');
        const activeDevice = deviceState.deviceType === 'mobile' ? 'mobile' : 'desktop';

        root.dataset.devicePreview = activeDevice;
        root.classList.toggle('is-desktop', activeDevice === 'desktop');
        root.classList.toggle('is-mobile', activeDevice === 'mobile');

        if (monitorFrame) {
          monitorFrame.classList.remove('desktop', 'mobile', 'active');
          monitorFrame.classList.add(activeDevice, 'active');
        }
        deviceBtns.forEach(btn => {
          if (btn.getAttribute('data-device') === activeDevice) {
            btn.classList.add('active');
          } else {
            btn.classList.remove('active');
          }
        });
        updateMonitorScale();
      }
      /* ========== SYNC ALL PREVIEW CLONES ========== */
      function syncDeviceFrameClones(snapshot, deviceSnapshot) {
        const mobileRoot = document.getElementById('mobileChatRoot');
        const monitorChat = document.getElementById('monitorChat');
        deviceSnapshot = deviceSnapshot || deviceState;

        if (mobileRoot) {
          mobileRoot.innerHTML = '';
          const mobileClone = clonePreviewChatShell({ mobile: true });
          if (mobileClone) {
            mobileRoot.appendChild(mobileClone);
            applyColorsToChat(mobileClone, snapshot);
            updateChatBackground(mobileClone, snapshot);
            updateChatOverlay(mobileClone, snapshot);
            applyPreviewTypography(mobileClone, snapshot);
            const messagesContainer = mobileClone.querySelector('.chat-messages');
            if (messagesContainer) {
              messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }
          }
        }

        if (monitorChat) {
          monitorChat.innerHTML = '';
          const desktopClone = clonePreviewChatShell({ mobile: false });
          if (desktopClone) {
            monitorChat.appendChild(desktopClone);
            applyColorsToChat(desktopClone, snapshot);
            updateChatBackground(desktopClone, snapshot);
            updateChatOverlay(desktopClone, snapshot);
            applyPreviewTypography(desktopClone, snapshot);
            const messagesContainer = desktopClone.querySelector('.chat-messages');
            if (messagesContainer) {
              messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }
          }

          applyMonitorChatPosition(monitorChat, deviceSnapshot);
          applyMonitorChatDimensions(monitorChat, deviceSnapshot);
        }
      }
      
      // Apply position to monitor chat (mirroring device position)
      function applyMonitorChatPosition(monitorChat, deviceSnapshot) {
        if (!monitorChat) return;
        const position = (deviceSnapshot && deviceSnapshot.position) || deviceState.position || 'bottom-right';
        const widgetWidth = Number(deviceSnapshot?.width) || FIXED_CHAT_DIMENSIONS.width;
        const widgetHeight = Number(deviceSnapshot?.height) || FIXED_CHAT_DIMENSIONS.height;
        const edgeX = Math.max(12, Number(deviceSnapshot?.offsetX ?? deviceSnapshot?.x ?? 32));
        const edgeY = Math.max(12, Number(deviceSnapshot?.offsetY ?? deviceSnapshot?.y ?? 32));
        const customX = Number(deviceSnapshot?.customX);
        const customY = Number(deviceSnapshot?.customY);
        const maxLeft = Math.max(12, DESKTOP_STAGE_SIZE.width - widgetWidth - 12);
        const maxTop = Math.max(12, DESKTOP_STAGE_SIZE.height - widgetHeight - 12);
        const normalizedLeft = Number.isFinite(customX) ? Math.max(12, Math.min(maxLeft, customX)) : null;
        const normalizedTop = Number.isFinite(customY) ? Math.max(12, Math.min(maxTop, customY)) : null;
        // Reset all positions
        monitorChat.style.left = 'auto';
        monitorChat.style.right = 'auto';
        monitorChat.style.top = 'auto';
        monitorChat.style.bottom = 'auto';
        
        switch(position) {
          case 'bottom-left':
            monitorChat.style.left = `${edgeX}px`;
            monitorChat.style.bottom = `${edgeY}px`;
            break;
          case 'bottom-right':
            monitorChat.style.right = `${edgeX}px`;
            monitorChat.style.bottom = `${edgeY}px`;
            break;
          case 'top-left':
            monitorChat.style.left = `${edgeX}px`;
            monitorChat.style.top = `${edgeY}px`;
            break;
          case 'top-right':
            monitorChat.style.right = `${edgeX}px`;
            monitorChat.style.top = `${edgeY}px`;
            break;
          case 'custom':
            if (normalizedLeft !== null) monitorChat.style.left = `${normalizedLeft}px`;
            if (normalizedTop !== null) monitorChat.style.top = `${normalizedTop}px`;
            break;
        }
        
        // Also update minimized icon position in monitor
        const monitorIcon = document.getElementById('monitorChatIcon');
        if (monitorIcon) {
          monitorIcon.style.left = 'auto';
          monitorIcon.style.right = 'auto';
          monitorIcon.style.top = 'auto';
          monitorIcon.style.bottom = 'auto';
          switch(position) {
            case 'bottom-left':
              monitorIcon.style.left = `${edgeX}px`;
              monitorIcon.style.bottom = `${edgeY}px`;
              break;
            case 'bottom-right':
              monitorIcon.style.right = `${edgeX}px`;
              monitorIcon.style.bottom = `${edgeY}px`;
              break;
            case 'top-left':
              monitorIcon.style.left = `${edgeX}px`;
              monitorIcon.style.top = `${edgeY}px`;
              break;
            case 'top-right':
              monitorIcon.style.right = `${edgeX}px`;
              monitorIcon.style.top = `${edgeY}px`;
              break;
            case 'custom':
              if (normalizedLeft !== null) monitorIcon.style.left = `${normalizedLeft}px`;
              if (normalizedTop !== null) monitorIcon.style.top = `${normalizedTop}px`;
              break;
          }
        }
      }
      
      // Apply dimensions to monitor chat based on device state
      function applyMonitorChatDimensions(monitorChat, deviceSnapshot) {
        if (!monitorChat) return;
        // Desktop preview uses stage-space px; the whole stage is scaled uniformly.
        const width = Math.max(240, Number(deviceSnapshot?.width) || FIXED_CHAT_DIMENSIONS.width);
        const height = Math.max(320, Number(deviceSnapshot?.height) || FIXED_CHAT_DIMENSIONS.height);
        monitorChat.style.width = `${width}px`;
        monitorChat.style.height = `${height}px`;
      }

      function applyMobileChatColors(mobileRoot, snapshot) {
        if (!mobileRoot || !snapshot?.colors) return;

        // Background - apply the same background handling as work chat
        mobileRoot.style.backgroundColor = snapshot.colors.chatBackground;
        
        // Apply background image if set
        if (snapshot.backgroundType === 'image' && snapshot.backgroundImage) {
          mobileRoot.style.backgroundImage = `url(${snapshot.backgroundImage})`;
          mobileRoot.style.backgroundSize = 'cover';
          mobileRoot.style.backgroundPosition = 'center';
        } else if (snapshot.backgroundType === 'gradient' && snapshot.backgroundGradient) {
          mobileRoot.style.backgroundImage = snapshot.backgroundGradient;
        } else {
          mobileRoot.style.backgroundImage = 'none';
        }
        
        // Header
        const header = mobileRoot.querySelector('.mobile-header');
        if (header) {
          header.style.backgroundColor = snapshot.colors.chatHeader;
          header.style.color = snapshot.colors.botText || '#E2E8F0';
        }

        // Message bubbles
        mobileRoot.querySelectorAll('.mobile-message.bot .mobile-message-content').forEach(msg => {
          msg.style.backgroundColor = snapshot.colors.botBubble;
          msg.style.color = snapshot.colors.botText;
        });

        mobileRoot.querySelectorAll('.mobile-message.user .mobile-message-content').forEach(msg => {
          msg.style.backgroundColor = snapshot.colors.userBubble;
          msg.style.color = snapshot.colors.userText;
        });

        // Input bar
        const inputBar = mobileRoot.querySelector('.mobile-input-bar');
        if (inputBar) {
          inputBar.style.backgroundColor = snapshot.colors.chatInput;
        }
        
        // Input text
        const inputField = mobileRoot.querySelector('.mobile-input');
        if (inputField) {
          inputField.style.color = snapshot.colors.botText || '#E2E8F0';
        }

        // Send button
        const sendBtn = mobileRoot.querySelector('.mobile-send-button');
        if (sendBtn) {
          sendBtn.style.backgroundColor = snapshot.colors.chatAccent;
        }

        // Quick reply buttons with style options
        const qrStyle = snapshot.quickReplyStyle || 'filled';
        const qrRadius = snapshot.quickReplyRadius !== undefined ? snapshot.quickReplyRadius : 12;
        mobileRoot.querySelectorAll('.mobile-quick-replies button').forEach(btn => {
          btn.style.borderRadius = `${qrRadius}px`;
          if (qrStyle === 'filled') {
            btn.style.backgroundColor = snapshot.colors.chatAccent;
            btn.style.border = 'none';
            btn.style.color = '#fff';
          } else if (qrStyle === 'outline') {
            btn.style.backgroundColor = 'transparent';
            btn.style.border = `2px solid ${snapshot.colors.chatAccent}`;
            btn.style.color = snapshot.colors.chatAccent;
          } else if (qrStyle === 'ghost') {
            btn.style.backgroundColor = `${snapshot.colors.chatAccent}20`;
            btn.style.border = 'none';
            btn.style.color = snapshot.colors.chatAccent;
          }
        });
      }

      function applyChatPosition() {
        applyMonitorChatPosition(document.getElementById('monitorChat'), deviceState);
        applyMobileIconPosition();
      }
      
      function applyMobileIconPosition() {
        const mobileIcon = document.getElementById('mobileChatIcon');
        const monitorIcon = document.getElementById('monitorChatIcon');
        const position = deviceState.position || 'bottom-right';

        if (mobileIcon) {
          mobileIcon.style.left = 'auto';
          mobileIcon.style.right = '16px';
          mobileIcon.style.top = 'auto';
          mobileIcon.style.bottom = '24px';
        }

        if (monitorIcon) {
          monitorIcon.style.left = 'auto';
          monitorIcon.style.right = 'auto';
          monitorIcon.style.top = 'auto';
          monitorIcon.style.bottom = 'auto';
          switch(position) {
            case 'bottom-left':
              monitorIcon.style.left = '16px';
              monitorIcon.style.bottom = '16px';
              break;
            case 'bottom-right':
              monitorIcon.style.right = '16px';
              monitorIcon.style.bottom = '16px';
              break;
            case 'top-left':
              monitorIcon.style.left = '16px';
              monitorIcon.style.top = '16px';
              break;
            case 'top-right':
              monitorIcon.style.right = '16px';
              monitorIcon.style.top = '16px';
              break;
          }
        }
      }
      function updateDeviceChat(workSnapshot, deviceSnapshot) {
        // cloning is handled in syncDeviceFrameClones inside notify
        applyMobileIconPosition();
      }
      function updateDeviceChatContent() {
        syncDeviceFrameClones(workState, deviceState);
      }
      function getInitialsFromName(name) {
        if (!name || typeof name !== 'string') return i18nText("i18n-appearance-default-avatar");
        const parts = name.trim().split(' ');
        if (parts.length === 1) {
          return parts[0].substring(0, 2).toUpperCase();
        } else {
          return (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();
        }
      }
      /* ========== SKALOWANIE VIRTUAL DESKTOP ========== */
      function calculateAndApplyScale() {
        // Virtual desktop jest teraz 100% viewport, nie potrzebujemy skalowania
        return 1;
      }
      function updateScaleInfo() {
        const info = document.getElementById('scaleInfo');
        if (!info) return;
        if (deviceState.deviceType === 'desktop') {
          const scale = calculateAndApplyScale() || 1;
          info.innerHTML = `
<i class="fas fa-ruler-combined"></i>
<span>${i18nText("i18n-appearance-scale-chat")}: ${deviceState.width}×${deviceState.height}px | ${i18nText("i18n-appearance-scale-scale")}: ${(scale * 100).toFixed(0)}%</span>
`;
          info.style.display = 'flex';
        } else {
          info.innerHTML = `
<i class="fas fa-mobile-alt"></i>
<span>${i18nText("i18n-appearance-scale-fullscreen")}</span>
`;
          info.style.display = 'flex';
        }
      }
      function updateScaleOverlay() {
        const overlay = document.getElementById('scaleOverlay');
        if (!overlay) return;
        if (deviceState.deviceType === 'desktop') {
          const scale = calculateAndApplyScale() || 1;
          overlay.innerHTML = `
<div class="scale-dimensions">
<span class="dimension">${deviceState.width}px</span>
<span class="separator">×</span>
<span class="dimension">${deviceState.height}px</span>
</div>
<div class="scale-percent">
${i18nText("i18n-appearance-scale-scale")}: ${(scale * 100).toFixed(0)}%
</div>
`;
          overlay.style.display = 'block';
        } else {
          overlay.innerHTML = `
<div class="scale-dimensions">
<span class="dimension">${i18nText("i18n-appearance-scale-mobile")}</span>
<span class="separator">•</span>
<span class="dimension">${i18nText("i18n-appearance-scale-fullscreen-short")}</span>
</div>
<div class="scale-percent">
${i18nText("i18n-appearance-scale-fit")}
</div>
`;
          overlay.style.display = 'block';
        }
      }
      /* ========== PRESET BAR ========== */
      function updatePresetBar() {
        const presetSegments = document.querySelectorAll('.preset-segment:not(:first-child)');
        presetSegments.forEach(segment => {
          if (segment.getAttribute('data-preset') === currentPreset) {
            segment.classList.add('active');
          } else {
            segment.classList.remove('active');
          }
        });
      }
      /* ========== COLOR EDITOR - NAPRAWA ========== */
      const colorPresetsList = {
        chatBackground: ["#0F0F14", "#1a1a20", "#111827", "#0f172a", "#1e293b", "#27272a"],
        chatHeader: ["#1A1A20", "#2d2d2d", "#0B0D10", "#1e293b", "#111827", "#27272a"],
        chatInput: ["#1A1A20", "#2d2d2d", "#0B0D10", "#1e293b", "#111827", "#27272a"],
        chatAccent: ["#7C3AED", "#8b5cf6", "#a855f7", "#60a5fa", "#3b82f6", "#06b6d4"],
        userBubble: ["#7C3AED", "#8b5cf6", "#a855f7", "#60a5fa", "#3b82f6", "#06b6d4"],
        userText: ["#F8F9FB", "#f1f5f9", "#e2e8f0", "#cbd5e1", "#FFFFFF", "#e5e7eb"],
        botBubble: ["#1E293B", "#1a1f2e", "#111827", "#0f172a", "#27272a", "#3f3f46"],
        botText: ["#E2E8F0", "#F4F4F5", "#e5e7eb", "#d1d5db", "#cbd5e1", "#FFFFFF"],
        iconBackground: ["#7C3AED", "#8b5cf6", "#3b82f6", "#06b6d4", "#10b981", "#f59e0b", "#ef4444", "#1e293b"],
        iconColor: ["#FFFFFF", "#F8F9FB", "#0F0F14", "#000000", "#e2e8f0", "#fef3c7"]
      };
      function openColorEditor(key) {
        const editor = document.getElementById('colorEditor');
        if (!editor) return;
        lockAccordion = true;
        currentColorKey = key;
        // Aktualizuj tytuł
        const title = document.getElementById('editorTitle');
        if (title) {
          const labelMap = {
            chatBackground: i18nText("i18n-appearance-editor-chat-bg"),
            chatHeader: i18nText("i18n-appearance-editor-chat-header"),
            chatInput: i18nText("i18n-appearance-editor-chat-input"),
            chatAccent: i18nText("i18n-appearance-editor-chat-accent"),
            userBubble: i18nText("i18n-appearance-editor-user-bubble"),
            userText: i18nText("i18n-appearance-editor-user-text"),
            botBubble: i18nText("i18n-appearance-editor-bot-bubble"),
            botText: i18nText("i18n-appearance-editor-bot-text"),
            iconBackground: i18nText("i18n-appearance-editor-icon-bg"),
            iconColor: i18nText("i18n-appearance-editor-icon-color")
          };
          title.textContent = `${i18nText("i18n-appearance-editor-prefix")} ${labelMap[key] || key}`;
        }
        // Wypełnij presety kolorów
        const presetContainer = editor.querySelector('[data-role="editor-presets"]');
        if (presetContainer) {
          presetContainer.innerHTML = "";
          const presets = colorPresetsList[key] || [];
          presets.forEach((hex) => {
            const btn = document.createElement("button");
            btn.type = "button";
            btn.className = "preset-grid-btn";
            btn.style.backgroundColor = hex;
            btn.style.width = "36px";
            btn.style.height = "36px";
            btn.style.borderRadius = "8px";
            btn.style.border = "2px solid transparent";
            btn.style.cursor = "pointer";
            btn.style.margin = "4px";
            btn.style.transition = "all 0.2s ease";
            btn.title = hex;
            // Sprawdź czy to aktualny kolor
            const currentColor = workState.colors?.[key];
            if (currentColor && currentColor.toLowerCase() === hex.toLowerCase()) {
              btn.style.borderColor = "#ffffff";
              btn.style.boxShadow = "0 0 0 2px #7C3AED, 0 0 12px rgba(124, 58, 237, 0.5)";
            }
            btn.addEventListener('click', function (e) {
              e.preventDefault();
              e.stopPropagation();
              const preview = editor.querySelector('[data-role="editor-preview"]');
              const hexDisplay = editor.querySelector('[data-role="editor-hex"]');
              const input = editor.querySelector('[data-role="editor-input"]');
              if (preview) preview.style.backgroundColor = hex;
              if (hexDisplay) hexDisplay.textContent = hex.toUpperCase();
              if (input) input.value = hex;
              // Zaznacz aktywny preset
              presetContainer.querySelectorAll('.preset-grid-btn').forEach(b => {
                b.style.borderColor = "transparent";
                b.style.boxShadow = "none";
              });
              this.style.borderColor = "#ffffff";
              this.style.boxShadow = "0 0 0 2px #7C3AED, 0 0 12px rgba(124, 58, 237, 0.5)";
            });
            presetContainer.appendChild(btn);
          });
        }
        // Ustaw bieżący kolor
        const input = editor.querySelector('[data-role="editor-input"]');
        const preview = editor.querySelector('[data-role="editor-preview"]');
        const hexDisplay = editor.querySelector('[data-role="editor-hex"]');
        // Kolory ikony są na głównym poziomie, reszta w colors
        const iconColorKeys = ['iconBackground', 'iconColor'];
        const currentColor = iconColorKeys.includes(key)
          ? (workState[key] || "#7C3AED")
          : (workState.colors?.[key] || "#000000");
        if (input) input.value = currentColor;
        if (preview) preview.style.backgroundColor = currentColor;
        if (hexDisplay) hexDisplay.textContent = currentColor.toUpperCase();
        // Pokaż edytor
        editor.removeAttribute("hidden");
        requestAnimationFrame(() => {
          editor.classList.add("show");
        });
      }
      function closeColorEditor() {
        const editor = document.getElementById('colorEditor');
        if (editor) {
          editor.classList.remove("show");
          setTimeout(() => {
            editor.setAttribute("hidden", "true");
          }, 250);
        }
        lockAccordion = false;
        currentColorKey = null;
      }
      function initColorEditor() {
        // NAPRAWA: Dodaj event listener do wszystkich color-tile
        const colorTiles = document.querySelectorAll('.color-tile');
        colorTiles.forEach(tile => {
          tile.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            const key = tile.getAttribute('data-key');
            if (key) {
              openColorEditor(key);
            }
          });
        });
        const closeBtns = document.querySelectorAll('[data-role="editor-close"]');
        closeBtns.forEach(btn => {
          btn.addEventListener('click', (e) => {
            e.preventDefault();
            closeColorEditor();
          });
        });
        const applyBtn = document.querySelector('[data-role="editor-apply"]');
        if (applyBtn) {
          applyBtn.addEventListener('click', (e) => {
            e.preventDefault();
            const editor = document.getElementById('colorEditor');
            const input = editor.querySelector('[data-role="editor-input"]');
            if (currentColorKey && input) {
              // Kolory ikony są na głównym poziomie, reszta w colors
              const iconColorKeys = ['iconBackground', 'iconColor'];
              if (iconColorKeys.includes(currentColorKey)) {
                setWorkOption(currentColorKey, input.value);
              } else {
                setWorkOption(`colors.${currentColorKey}`, input.value);
              }
              // Zaktualizuj preview w kafelku
              const tile = document.querySelector(`.color-tile[data-key="${currentColorKey}"]`);
              if (tile) {
                tile.setAttribute("data-value", input.value);
                tile.style.setProperty("--tile-color", input.value);
                const preview = tile.querySelector('.color-preview');
                if (preview) preview.style.backgroundColor = input.value;
              }
            }
            closeColorEditor();
          });
        }
        const backdrop = document.querySelector('[data-role="editor-backdrop"]');
        if (backdrop) {
          backdrop.addEventListener('click', (e) => {
            e.preventDefault();
            closeColorEditor();
          });
        }
        const colorInput = document.querySelector('[data-role="editor-input"]');
        if (colorInput) {
          colorInput.addEventListener('input', function () {
            const preview = document.querySelector('[data-role="editor-preview"]');
            const hex = document.querySelector('[data-role="editor-hex"]');
            if (preview) preview.style.backgroundColor = this.value;
            if (hex) hex.textContent = this.value.toUpperCase();
          });
        }
        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape') {
            const editor = document.getElementById('colorEditor');
            if (editor && editor.classList.contains("show")) {
              closeColorEditor();
            }
          }
        });
      }
      /* ========== BACKGROUND IMAGE ========== */
      function initBackgroundImage() {
        const bgUpload = document.getElementById('bgUpload');
        const bgUploadBtn = document.getElementById('bgUploadBtn');
        const bgRemoveBtn = document.getElementById('bgRemoveBtn');
        const bgPreview = document.getElementById('bgPreview');
        if (bgUploadBtn && bgUpload) {
          bgUploadBtn.addEventListener('click', () => bgUpload.click());
        }
        if (bgUpload) {
          bgUpload.addEventListener('change', function (e) {
            const file = e.target.files?.[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function (event) {
              setWorkOption('backgroundType', 'image');
              setWorkOption('backgroundImage', event.target.result);
              // Aktualizuj podgląd
              if (bgPreview) {
                bgPreview.style.backgroundImage = `url(${event.target.result})`;
                bgPreview.querySelector('.bg-preview-overlay').textContent = 'Własne tło';
              }
              // Zaznacz opcję "własne tło"
              document.querySelectorAll('.bg-option').forEach(opt => {
                opt.classList.remove('active');
              });
            };
            reader.readAsDataURL(file);
          });
        }
        if (bgRemoveBtn) {
          bgRemoveBtn.addEventListener('click', function () {
            setWorkOption('backgroundType', 'color');
            setWorkOption('backgroundImage', null);
            setWorkOption('backgroundPreset', null);
            if (bgPreview) {
              bgPreview.style.backgroundImage = 'none';
            bgPreview.querySelector('.bg-preview-overlay').textContent = i18nText("appearance.chatUi.previewLabel");
            }
            if (bgUpload) bgUpload.value = '';
            // Zaznacz opcję "kolor"
            document.querySelectorAll('.bg-option').forEach(opt => {
              opt.classList.remove('active');
            });
            const colorOption = document.querySelector('.bg-option[data-bg-type="color"]');
            if (colorOption) colorOption.classList.add('active');
          });
        }
      }
      /* ========== AVATAR ========== */
      function initAvatarUpload() {
        const avatarUpload = document.getElementById('avatarUpload');
        const avatarUploadBtn = document.getElementById('avatarUploadBtn');
        const avatarRemoveBtn = document.getElementById('avatarRemoveBtn');
        const avatarPreview = document.getElementById('avatarPreview');
        if (avatarPreview && !workState.avatarImage) {
          avatarPreview.style.backgroundImage = 'none';
          avatarPreview.classList.remove('has-image');
          avatarPreview.innerHTML = `<img src="${escapeHtml(DEFAULT_BOT_AVATAR)}" alt="DaVeri logo">`;
        }
        if (avatarUploadBtn && avatarUpload) {
          avatarUploadBtn.addEventListener('click', () => avatarUpload.click());
        }
        if (avatarUpload) {
          avatarUpload.addEventListener('change', function (e) {
            const file = e.target.files?.[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function (event) {
              setWorkOption('avatarImage', event.target.result);
              if (avatarPreview) {
                avatarPreview.style.backgroundImage = `url(${event.target.result})`;
                avatarPreview.classList.add('has-image');
                avatarPreview.innerHTML = '';
              }
            };
            reader.readAsDataURL(file);
          });
        }
        if (avatarRemoveBtn) {
          avatarRemoveBtn.addEventListener('click', function () {
            setWorkOption('avatarImage', null);
            if (avatarPreview) {
              avatarPreview.style.backgroundImage = 'none';
              avatarPreview.classList.remove('has-image');
              avatarPreview.innerHTML = `<img src="${escapeHtml(DEFAULT_BOT_AVATAR)}" alt="DaVeri logo">`;
            }
            if (avatarUpload) avatarUpload.value = '';
          });
        }
      }
      function applyAvatarToChats(avatarUrl) {
        const src = escapeHtml(avatarUrl || DEFAULT_BOT_AVATAR);
        const targets = [
          document.querySelector('#workChat .chat-avatar'),
          document.querySelector('#monitorChat .chat-avatar'),
          document.querySelector('#mobileChatRoot .chat-avatar')
        ].filter(Boolean);
        targets.forEach((avatar) => {
          avatar.style.backgroundImage = 'none';
          avatar.innerHTML = `<img src="${src}" alt="">`;
        });
      }
      function resetAvatarToDefault() {
        const workAvatar = document.querySelector('#workChat .chat-avatar');
        if (workAvatar) {
          workAvatar.style.backgroundImage = 'none';
          workAvatar.innerHTML = `<img src="${escapeHtml(DEFAULT_BOT_AVATAR)}" alt="">`;
        }
        const deviceTargets = [
          document.querySelector('#monitorChat .chat-avatar'),
          document.querySelector('#mobileChatRoot .chat-avatar')
        ].filter(Boolean);
        deviceTargets.forEach((avatar) => {
          avatar.style.backgroundImage = 'none';
          avatar.innerHTML = `<img src="${escapeHtml(DEFAULT_BOT_AVATAR)}" alt="">`;
        });
      }
      function updateBotName(name) {
        // LEWY CHAT
        const workName = document.querySelector('#workChat .chat-name');
        if (workName) {
          workName.textContent = name || i18nText("i18n-appearance-default-bot-name");
        }
        const deviceNames = [
          document.querySelector('#monitorChat .chat-name'),
          document.querySelector('#mobileChatRoot .chat-name')
        ].filter(Boolean);
        deviceNames.forEach((node) => {
          node.textContent = name || i18nText("i18n-appearance-default-bot-name");
        });
        // Aktualizuj avatar jeśli nie ma obrazka
        if (!workState.avatarImage) {
          applyAvatarToChats(null);
        }
      }
      function updateWatermarkText(text) {
        const brandText = WATERMARK_BRAND;
        // LEWY CHAT
        const workWatermark = document.querySelector('#workChat .chat-watermark .watermark-brand');
        if (workWatermark) {
          workWatermark.textContent = brandText;
        }
        const deviceWatermarks = [
          document.querySelector('#monitorChat .chat-watermark .watermark-brand'),
          document.querySelector('#mobileChatRoot .chat-watermark .watermark-brand')
        ].filter(Boolean);
        deviceWatermarks.forEach((node) => {
          node.textContent = brandText;
        });
      }
      /* ========== QUICK REPLIES ========== */
      function renderQuickReplies(snapshot) {
        const baseMessages = Array.isArray(snapshot?.quickReplies?.messages)
          ? snapshot.quickReplies.messages.map((entry) => String(entry || '').trim()).filter(Boolean)
          : [];
        const messages = baseMessages.length ? baseMessages : getDefaultStarterReplies();
        const isTop = snapshot?.quickReplies?.top || false;
        const workTopContainer = document.getElementById('workQuickRepliesTop');
        const workBottomContainer = document.getElementById('workQuickRepliesBottom');
        if (workTopContainer) {
          workTopContainer.innerHTML = '';
          workTopContainer.style.display = isTop ? 'flex' : 'none';
          if (isTop) {
            messages.forEach(text => {
              const btn = createQuickReplyButton(text, 'work');
              workTopContainer.appendChild(btn);
            });
          }
        }
        if (workBottomContainer) {
          workBottomContainer.innerHTML = '';
          workBottomContainer.style.display = isTop ? 'none' : 'flex';
          if (!isTop) {
            messages.forEach(text => {
              const btn = createQuickReplyButton(text, 'work');
              workBottomContainer.appendChild(btn);
            });
          }
        }
      }
      function createQuickReplyButton(text, chatType) {
        const btn = document.createElement('button');
        btn.className = 'quick-reply-chip';
        btn.textContent = text;
        btn.addEventListener('click', () => {
          simulateQuickReply(text);
        });
        return btn;
      }
      function simulateQuickReply(text) {
        const workChatInput = document.getElementById('workChatInput');
        if (workChatInput) {
          workChatInput.value = text;
          setTimeout(() => {
            sendWorkMessage();
          }, 300);
        }
      }
      function renderQuickRepliesEditor(snapshot, forceRender = false) {
        const box = document.getElementById('quickRepliesEditor');
        if (!box) return;
        const baseMessages = Array.isArray(snapshot?.quickReplies?.messages)
          ? snapshot.quickReplies.messages
          : [];
        const messages = baseMessages.length ? baseMessages : getDefaultStarterReplies();
        // Nie renderuj jeśli input jest aktywny (chyba że wymuszone)
        const activeEl = document.activeElement;
        const isInputActive = activeEl && activeEl.closest('#quickRepliesEditor input');
        if (isInputActive && !forceRender) {
          // Tylko aktualizuj wartości bez rerendera
          return;
        }
        // Sprawdź czy liczba wiadomości się zmieniła
        const existingInputs = box.querySelectorAll('input');
        if (existingInputs.length === messages.length && !forceRender) {
          // Tylko zaktualizuj wartości bez pełnego rerendera
          existingInputs.forEach((input, index) => {
            if (document.activeElement !== input) {
              input.value = messages[index] || '';
            }
          });
          return;
        }
        box.innerHTML = '';
        messages.forEach((text, index) => {
          const row = document.createElement('div');
          row.className = 'quick-reply-row';
          const input = document.createElement('input');
          input.type = 'text';
          input.value = text;
          input.placeholder = i18nText("i18n-appearance-quick-placeholder");
          input.setAttribute('data-index', index);
          // Zmiana na blur zamiast input - aktualizuj dopiero po opuszczeniu pola
          input.addEventListener('blur', (e) => {
            const newValue = e.target.value;
            const idx = parseInt(e.target.getAttribute('data-index'), 10);
            const current = workState.quickReplies?.messages || [];
            if (current[idx] !== newValue) {
              const next = [...current];
              next[idx] = newValue;
              setWorkOption('quickReplies.messages', next);
            }
          });
          // Opcjonalnie: aktualizuj na Enter
          input.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
              e.target.blur();
            }
          });
          const del = document.createElement('button');
          del.innerHTML = '✕';
          del.addEventListener('click', () => {
            const next = messages.filter((_, i) => i !== index);
            setWorkOption('quickReplies.messages', next);
          });
          row.appendChild(input);
          row.appendChild(del);
          box.appendChild(row);
        });
      }
      function initQuickReplies() {
        const addBtn = document.getElementById('addQuickReply');
        if (addBtn) {
          addBtn.addEventListener('click', () => {
            const current = workState.quickReplies.messages;
            const next = [...current, i18nText("i18n-appearance-quick-new")];
            setWorkOption('quickReplies.messages', next);
          });
        }
      }
      /* ========== INTERAKCJA Z CHAT ========== */
      function sendWorkMessage() {
        const workChatInput = document.getElementById('workChatInput');
        if (!workChatInput) return;
        const message = workChatInput.value.trim();
        if (!message) return;
        const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        workState.messages.push({
          type: 'user',
          text: message,
          time: time
        });
        workChatInput.value = '';
        renderWorkChatMessages();
        updateDeviceChatContent();
        // Automatyczna odpowiedź bota
        setTimeout(() => {
          const responses = [
            i18nText("i18n-appearance-auto-1"),
            i18nText("i18n-appearance-auto-2"),
            i18nText("i18n-appearance-auto-3"),
            i18nText("i18n-appearance-auto-4"),
            i18nText("i18n-appearance-auto-5")
          ];
          const botTime = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
          workState.messages.push({
            type: 'bot',
            text: responses[Math.floor(Math.random() * responses.length)],
            time: botTime
          });
          renderWorkChatMessages();
          updateDeviceChatContent();
        }, 1000);
      }
      function addAnimationDemoMessage() {
        const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        workState.messages.push({
          type: 'bot',
          text: `${i18nText("i18n-appearance-animation-prefix")} ${workState.animationPreset}`,
          time: time
        });
        renderWorkChatMessages();
        updateDeviceChatContent();
      }
      /* ========== ZMINIMALIZOWANY CHAT ========== */
      function initIconSection() {
        const iconUpload = document.getElementById('iconUpload');
        const iconUploadBtn = document.getElementById('iconUploadBtn');
        const iconRemoveBtn = document.getElementById('iconRemoveBtn');
        const iconPreview = document.getElementById('iconPreview');
        const iconSizeSlider = document.getElementById('iconSizeSlider');
        const iconModeToggle = document.getElementById('iconModeToggle');
        const renderIconPreview = (src) => {
          if (!iconPreview) return;
          iconPreview.innerHTML = `<img src="${escapeHtml(src)}" alt="Icon" style="width:100%;height:100%;object-fit:cover;border-radius:8px;">`;
        };
        renderIconPreview(workState.iconImage || DEFAULT_LAUNCHER_ICON);
        if (iconUploadBtn && iconUpload) {
          iconUploadBtn.addEventListener('click', () => iconUpload.click());
        }
        if (iconUpload) {
          iconUpload.addEventListener('change', function (e) {
            const file = e.target.files?.[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function (event) {
              setWorkOption('iconImage', event.target.result);
              renderIconPreview(event.target.result);
            };
            reader.readAsDataURL(file);
          });
        }
        if (iconRemoveBtn) {
          iconRemoveBtn.addEventListener('click', function () {
            setWorkOption('iconImage', null);
            renderIconPreview(DEFAULT_LAUNCHER_ICON);
            if (iconUpload) iconUpload.value = '';
          });
        }
        if (iconSizeSlider) {
          iconSizeSlider.addEventListener('input', function () {
            const val = this.value;
            document.getElementById('iconSizeValue').textContent = val + 'px';
            setWorkOption('iconSize', parseInt(val, 10));
          });
        }
        if (iconModeToggle) {
          iconModeToggle.addEventListener('change', function () {
            // Aktywacja/deaktywacja trybu ikony
            setWorkOption('iconMode', this.checked);
          });
        }
      }
      function renderChatIcon(snapshot) {
        // Elements
        const workChat = document.getElementById('workChat');
        const workChatIcon = document.getElementById('workChatIcon');
        const mobileChatRoot = document.getElementById('mobileChatRoot');
        const mobileChatIcon = document.getElementById('mobileChatIcon');
        const monitorChat = document.getElementById('monitorChat');
        const monitorChatIcon = document.getElementById('monitorChatIcon');

        const iconMode = snapshot?.iconMode || false;
        const shape = snapshot?.iconShape || 'circle';
        const iconType = snapshot?.iconType || 'robot';
        const size = snapshot?.iconSize || 56;
        const bgColor = snapshot?.iconBackground || '#7C3AED';
        const iconColor = snapshot?.iconColor || '#FFFFFF';
        const customImage = snapshot?.iconImage;

        // Icon shape class
        const shapeRadius = shape === 'circle' ? '50%' : shape === 'rounded' ? '16px' : '8px';

        // Generate icon HTML
        const launcherSrc = customImage || DEFAULT_LAUNCHER_ICON;
        const iconHTML = `<img src="${escapeHtml(launcherSrc)}" alt="Chat icon" style="width:100%;height:100%;object-fit:cover;border-radius:inherit;">`;

        // Apply icon styles
        function styleIcon(iconEl, sizeOverride) {
          if (!iconEl) return;
          const s = sizeOverride || size;
          iconEl.style.width = s + 'px';
          iconEl.style.height = s + 'px';
          iconEl.style.borderRadius = shapeRadius;
          iconEl.style.background = bgColor;
          iconEl.style.color = iconColor;
          iconEl.style.fontSize = Math.round(s * 0.4) + 'px';
          iconEl.style.boxShadow = '0 12px 30px rgba(0,0,0,0.45), 0 0 0 1px rgba(255,255,255,0.14)';
          iconEl.style.zIndex = '20';
          iconEl.innerHTML = iconHTML;
        }

        if (iconMode) {
          // === MINIMIZED STATE ===
          // Work chat: keep open preview and show launcher simultaneously
          if (workChat) workChat.style.display = 'flex';
          if (workChatIcon) {
            styleIcon(workChatIcon, 48);
            workChatIcon.style.display = 'flex';
            workChatIcon.onclick = () => setWorkOption('iconMode', false);
          }
          // Mobile: hide full-screen chat and show launcher bubble
          if (mobileChatRoot) mobileChatRoot.style.display = 'none';
          if (mobileChatIcon) {
            styleIcon(mobileChatIcon, 44);
            mobileChatIcon.style.display = 'flex';
            mobileChatIcon.onclick = () => setWorkOption('iconMode', false);
          }
          // Desktop monitor: keep chat visible and add launcher preview
          if (monitorChat) monitorChat.style.display = 'flex';
          if (monitorChatIcon) {
            styleIcon(monitorChatIcon, size);
            monitorChatIcon.style.display = 'flex';
            monitorChatIcon.onclick = () => setWorkOption('iconMode', false);
          }
        } else {
          // === EXPANDED STATE ===
          // Work chat: show chat, hide icon
          if (workChat) workChat.style.display = 'flex';
          if (workChatIcon) workChatIcon.style.display = 'none';
          // Mobile: show chat, hide icon
          if (mobileChatRoot) mobileChatRoot.style.display = 'flex';
          if (mobileChatIcon) mobileChatIcon.style.display = 'none';
          // Monitor: show chat, hide icon
          if (monitorChat) monitorChat.style.display = 'flex';
          if (monitorChatIcon) monitorChatIcon.style.display = 'none';
        }

        // Update iconMode toggle in UI
        const iconModeToggle = document.getElementById('iconModeToggle');
        if (iconModeToggle && iconModeToggle.checked !== iconMode) {
          iconModeToggle.checked = iconMode;
        }
      }
      /* ========== ZAPIS/WCZYTYWANIE ========== */
      async function loadStateFromBackend() {
        try {
          const botId = await resolveActiveBotId();
          if (!botId) return false;
          const bot = await fetchJson(`${API_BOTS}/${encodeURIComponent(botId)}`);
          const candidate = bot?.appearance || bot?.config?.ready_config || null;
          if (!candidate) return false;
          const enriched = {
            ...candidate,
            work: {
              ...(candidate.work || {}),
            },
          };
          if (!enriched.work.avatarImage && bot?.avatar) {
            enriched.work.avatarImage = bot.avatar;
          }
          return importState(enriched);
        } catch (error) {
          console.error("[Appearance] load from API failed:", error);
          return false;
        }
      }

      async function saveStateToBackend() {
        const botId = await resolveActiveBotId();
        if (!botId) {
          throw new Error("No active bot selected");
        }
        const parsed = JSON.parse(exportState());
        await fetchJson(`${API_BOTS}/${encodeURIComponent(botId)}`, {
          method: "PATCH",
          body: JSON.stringify({
            appearance: parsed,
            ready_config: parsed,
          }),
        });
      }

      function initSaveLoad() {
        const saveBtn = document.querySelector('[data-role="action-save"]');
        const loadBtn = document.querySelector('[data-role="action-load"]');

        if (saveBtn) {
          saveBtn.addEventListener('click', async () => {
            const originalHtml = saveBtn.innerHTML;
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
            try {
              await saveStateToBackend();
              saveBtn.innerHTML = '<i class="fas fa-check"></i> Saved';
            } catch (error) {
              console.error("[Appearance] save failed:", error);
              saveBtn.innerHTML = '<i class="fas fa-triangle-exclamation"></i> Error';
            }
            window.setTimeout(() => {
              saveBtn.innerHTML = originalHtml;
              saveBtn.disabled = false;
            }, 1400);
          });
        }

        if (loadBtn) {
          loadBtn.addEventListener('click', () => {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.addEventListener('change', (e) => {
              const file = e.target.files?.[0];
              if (!file) return;
              const reader = new FileReader();
              reader.onload = (event) => {
                const result = importState(event.target.result);
                if (result) {
                  alert(i18nText("i18n-appearance-alert-load-success"));
                } else {
                  alert(i18nText("i18n-appearance-alert-load-error"));
                }
              };
              reader.readAsText(file);
            });
            input.click();
          });
        }

      }

      /* ========== INICJALIZACJA ========== */
      async function init() {
        // Inicjalizacja konfiguratora
        bindEvents();
        initAccordionDefault();
        initBuilderSteps();
        initDevicePreviewToggle();
        // NAPRAWA: inicjalizuj edytor kolorów!
        initColorEditor();
        initQuickReplies();
        initBackgroundImage();
        initAvatarUpload();
        initSaveLoad();
        initIconSection();
        // NAPRAWA: renderuj wiadomości przy starcie
        renderWorkChatMessages();
        await waitForAuthReady();
        await initBotPicker();
        await loadStateFromBackend();
        // Wywołaj notify aby zsynchronizować UI
        notify();
        // Aktualizuj skalę
        window.addEventListener('resize', () => {
          calculateAndApplyScale();
          updateScaleInfo();
          updateScaleOverlay();
          updateMonitorScale();
        });

        // Calculate and apply monitor viewport scale
        updateMonitorScale();
      }

      function updateMonitorScale() {
        const monitorScreen = document.getElementById('monitorScreen');
        const viewport = document.getElementById('monitorViewport');
        if (!monitorScreen || !viewport) return;

        const screenWidth = monitorScreen.clientWidth;
        const screenHeight = monitorScreen.clientHeight;

        if (screenWidth > 0 && screenHeight > 0) {
          viewport.style.width = `${DESKTOP_STAGE_SIZE.width}px`;
          viewport.style.height = `${DESKTOP_STAGE_SIZE.height}px`;
          // Scale monitor stage from base desktop coordinates (1440x900) to fit preview container.
          const scale = Math.min(
            screenWidth / DESKTOP_STAGE_SIZE.width,
            screenHeight / DESKTOP_STAGE_SIZE.height
          );
          viewport.style.transformOrigin = 'top left';
          viewport.style.transform = `translate(-50%, -50%) scale(${scale})`;
          viewport.dataset.scale = String(scale);
        }
      }
      
      // Expose globally for sidebar sync
      window.updateMonitorScale = updateMonitorScale;
      window.addEventListener("daveri:active-bot-changed", async (event) => {
        const botId = event?.detail?.botId || getStoredActiveBotId();
        syncBotPickerSelection(botId);
        await loadStateFromBackend();
      });

      // Run on load and resize
      setTimeout(updateMonitorScale, 50);
      setTimeout(updateMonitorScale, 200);
      setTimeout(updateMonitorScale, 500);

      // Start aplikacji po załadowaniu DOM
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
      } else {
        init();
      }

    })();
  </script>

  <!-- Sidebar Sync Script -->
  <script>
    (function () {
      'use strict';

      // Sidebar widths
      const SIDEBAR_EXPANDED = 272;
      const SIDEBAR_COLLAPSED = 76;

      // Update CSS variable for sidebar width
      function updateSidebarWidth(width) {
        document.documentElement.style.setProperty('--dv-sidebar-w', width + 'px');
        // Recalculate monitor scale after sidebar changes
        setTimeout(function() {
          if (typeof window.updateMonitorScale === 'function') {
            window.updateMonitorScale();
          }
        }, 250);
      }

      // Check sidebar state from external sidebar (chatekai_root)
      function checkSidebarState() {
        const sidebar = document.querySelector('#chatekai_root .sidebar');
        if (!sidebar) {
          // No sidebar found, set to 0
          updateSidebarWidth(0);
          return;
        }

        if (sidebar.classList.contains('hidden')) {
          updateSidebarWidth(0);
        } else if (sidebar.classList.contains('collapsed')) {
          updateSidebarWidth(SIDEBAR_COLLAPSED);
        } else {
          updateSidebarWidth(SIDEBAR_EXPANDED);
        }
      }

      // Listen for sidebar changes via MutationObserver
      function observeSidebar() {
        const chatekaiRoot = document.getElementById('chatekai_root');
        if (!chatekaiRoot) {
          // Try again later if sidebar not loaded yet
          setTimeout(observeSidebar, 500);
          return;
        }

        const sidebar = chatekaiRoot.querySelector('.sidebar');
        if (!sidebar) {
          setTimeout(observeSidebar, 500);
          return;
        }

        // Initial check
        checkSidebarState();

        // Observe class changes on sidebar
        const observer = new MutationObserver(function (mutations) {
          mutations.forEach(function (mutation) {
            if (mutation.attributeName === 'class') {
              checkSidebarState();
            }
          });
        });

        observer.observe(sidebar, { attributes: true });
      }

      // Listen for custom events from sidebar
      window.addEventListener('sidebar-toggle', function (e) {
        if (e.detail && typeof e.detail.width === 'number') {
          updateSidebarWidth(e.detail.width);
        } else {
          checkSidebarState();
        }
      });

      // Start observing when DOM is ready
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', observeSidebar);
      } else {
    observeSidebar();
    }
    })();
    </script>

    <script>
    (function() {
      const layout = document.querySelector('#dv-configurator .appearance-layout');
      const tabsRoot = document.getElementById('appearanceLayoutTabs');
      if (!layout || !tabsRoot) return;

      const tabs = Array.from(tabsRoot.querySelectorAll('.layout-tab-btn[data-panel]'));
      const applyPanel = (panel) => {
        layout.dataset.activePanel = panel;
        tabs.forEach((tab) => {
          const isActive = tab.dataset.panel === panel;
          tab.classList.toggle('active', isActive);
          tab.setAttribute('aria-selected', isActive ? 'true' : 'false');
        });
      };

      tabs.forEach((tab) => {
        tab.addEventListener('click', () => applyPanel(tab.dataset.panel));
      });

      const setDefaultPanel = () => {
        if (window.innerWidth < 860) {
          applyPanel(layout.dataset.activePanel || 'options');
          return;
        }
        if (window.innerWidth < 1200) {
          applyPanel(layout.dataset.activePanel === 'device' ? 'device' : 'preview');
          return;
        }
        applyPanel('preview');
      };

      setDefaultPanel();
      window.addEventListener('resize', setDefaultPanel);
    })();
    </script>

    <!-- Ambient Particles Animation -->
    <script>
    (function() {
      'use strict';
      
      const canvas = document.getElementById('ambientParticles');
      if (!canvas) return;
      
      const ctx = canvas.getContext('2d');
      let particles = [];
      const particleCount = 60;
      let animationId;
      
      function resize() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
      }
      
      function createParticle() {
        return {
          x: Math.random() * canvas.width,
          y: Math.random() * canvas.height,
          size: Math.random() * 1 + 1,
          speedX: (Math.random() - 0.5) * 0.15,
          speedY: (Math.random() - 0.5) * 0.15,
          opacity: Math.random() * 0.1 + 0.05,
          opacityDirection: Math.random() > 0.5 ? 1 : -1,
          opacitySpeed: Math.random() * 0.001 + 0.0005
        };
      }
      
      function initParticles() {
        particles = [];
        for (let i = 0; i < particleCount; i++) {
          particles.push(createParticle());
        }
      }
      
      function animate() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        particles.forEach(p => {
          // Move particle
          p.x += p.speedX;
          p.y += p.speedY;
          
          // Wrap around edges
          if (p.x < 0) p.x = canvas.width;
          if (p.x > canvas.width) p.x = 0;
          if (p.y < 0) p.y = canvas.height;
          if (p.y > canvas.height) p.y = 0;
          
          // Animate opacity
          p.opacity += p.opacityDirection * p.opacitySpeed;
          if (p.opacity >= 0.15) {
            p.opacity = 0.15;
            p.opacityDirection = -1;
          } else if (p.opacity <= 0.05) {
            p.opacity = 0.05;
            p.opacityDirection = 1;
          }
          
          // Draw particle
          ctx.beginPath();
          ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
          ctx.fillStyle = `rgba(255, 255, 255, ${p.opacity})`;
          ctx.fill();
        });
        
        animationId = requestAnimationFrame(animate);
      }
      
      // Initialize
      resize();
      initParticles();
      animate();
      
      // Handle resize
      window.addEventListener('resize', () => {
        resize();
        initParticles();
      });
      
      // Cleanup on page unload
      window.addEventListener('unload', () => {
        if (animationId) cancelAnimationFrame(animationId);
      });
    })();
    </script>

    <script type="module" src="../js/language.js"></script>
    <script type="module" src="../js/auth-bootstrap.js"></script>
    <script type="module" src="../js/sidebar-loader.js"></script>
    
    <script type="module" src="../js/i18n.js"></script>
</body>

</html>



