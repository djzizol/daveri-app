<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title data-i18n="history.page.title"></title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root {
      --dv-bg: #0d0e13; --dv-bg2: #0f1114;
      --dv-surface: rgba(255,255,255,.03); --dv-surface2: rgba(255,255,255,.05);
      --dv-stroke: rgba(255,255,255,.08); --dv-stroke2: rgba(255,255,255,.12);
      --dv-text: rgba(255,255,255,.92); --dv-text2: rgba(255,255,255,.65);
      --dv-muted: rgba(255,255,255,.55); --dv-muted2: rgba(255,255,255,.35);
      --dv-burg: #fb7185; --dv-vio: #a855f7; --dv-blue: #60a5fa;
      --dv-grad: linear-gradient(135deg, var(--dv-burg) 0%, var(--dv-vio) 48%, var(--dv-blue) 100%);
      --dv-gradGlow: 0 0 18px rgba(168,85,247,.22), 0 0 22px rgba(96,165,250,.14), 0 0 18px rgba(251,113,133,.14);
      --dv-radius-xl: 16px; --dv-radius-lg: 14px; --dv-radius-md: 10px; --dv-radius-sm: 8px;
      --dv-ease: cubic-bezier(.22,.61,.36,1);
      --page-max: 1280px; --page-pad: 24px;
      --dv-sidebar-w: 0px;
    }
    [data-theme="light"] {
      --dv-bg: #f8f9fc; --dv-bg2: #ffffff;
      --dv-surface: rgba(0,0,0,.03); --dv-surface2: rgba(0,0,0,.05);
      --dv-stroke: rgba(0,0,0,.08); --dv-stroke2: rgba(0,0,0,.12);
      --dv-text: rgba(0,0,0,.88); --dv-text2: rgba(0,0,0,.65);
      --dv-muted: rgba(0,0,0,.55); --dv-muted2: rgba(0,0,0,.35);
    }
    [data-theme="light"] body::before, [data-theme="light"] body::after { display: none; }
    [data-theme="light"] #ambientParticles { opacity: 0.15; }
    [data-theme="light"] .msg.user { background: rgba(168,85,247,0.08); }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      -webkit-font-smoothing: antialiased; color: var(--dv-text);
      background: var(--dv-bg); min-height: 100vh; line-height: 1.5;
      letter-spacing: -0.01em; position: relative;
    }
    body::before {
      content: ""; position: fixed; inset: 0; pointer-events: none; z-index: 0;
      background: radial-gradient(circle at 20% 30%, rgba(255,255,255,0.05), transparent 40%),
        radial-gradient(circle at 80% 60%, rgba(255,255,255,0.04), transparent 45%),
        radial-gradient(circle at 50% 80%, rgba(255,255,255,0.03), transparent 40%);
      animation: ambientDrift 30s ease-in-out infinite;
    }
    @keyframes ambientDrift { 0%, 100% { opacity: 1; } 50% { opacity: 0.85; } }
    body::after {
      content: ""; position: fixed; width: 500px; height: 500px;
      background: radial-gradient(circle, rgba(255,255,255,0.05), transparent 60%);
      filter: blur(100px); opacity: 0.3; pointer-events: none; z-index: 0;
      top: 20%; left: 40%; animation: floatLight 40s ease-in-out infinite;
    }
    @keyframes floatLight { 0%, 100% { transform: translate(0,0); } 50% { transform: translate(15%,10%); } }
    #ambientParticles { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 0; opacity: 0.6; }
    #page-wrapper { display: flex; min-height: 100vh; width: 100%; position: relative; z-index: 1; }
    #sidebar-spacer { width: var(--dv-sidebar-w, 0px); flex-shrink: 0; transition: width .22s var(--dv-ease); }
    #main-content { flex: 1; min-width: 0; max-width: 100%; transition: all .22s var(--dv-ease); overflow-x: hidden; }
    .page { max-width: var(--page-max); margin: 0 auto; padding: var(--page-pad); min-height: 100vh; position: relative; }

    .page-header { margin-bottom: 32px; }
    .page-title { font-size: 28px; font-weight: 800; letter-spacing: -0.03em; color: var(--dv-text); }
    .page-subtitle { font-size: 14px; color: var(--dv-muted); margin-top: 4px; }

    /* Conversation Layout */
    .conv-layout { display: grid; grid-template-columns: 340px 1fr; gap: 20px; min-height: calc(100vh - 140px); }
    @media (max-width: 900px) { .conv-layout { grid-template-columns: 1fr; } }

    /* Conversation List */
    .conv-list {
      background: var(--dv-surface); border: 1px solid var(--dv-stroke);
      border-radius: var(--dv-radius-xl); overflow: hidden; display: flex; flex-direction: column;
    }
    .conv-list-header {
      padding: 16px 20px; border-bottom: 1px solid var(--dv-stroke);
      display: flex; justify-content: space-between; align-items: center;
    }
    .conv-list-header span { font-size: 13px; color: var(--dv-muted); font-weight: 600; }
    .conv-count {
      background: rgba(168,85,247,.15); color: #fff; padding: 4px 10px;
      border-radius: 999px; font-size: 11px; font-weight: 700;
    }
    .conv-items { flex: 1; overflow-y: auto; padding: 8px; }
    .conv-items::-webkit-scrollbar { width: 4px; }
    .conv-items::-webkit-scrollbar-thumb { background: var(--dv-stroke2); border-radius: 4px; }

    .conv-item {
      width: 100%; padding: 14px; background: transparent; border: 1px solid transparent;
      border-radius: var(--dv-radius-md); text-align: left; cursor: pointer;
      margin-bottom: 4px; transition: all 0.15s var(--dv-ease); position: relative;
    }
    .conv-item:hover { background: var(--dv-surface2); border-color: var(--dv-stroke); }
    .conv-item.active { background: var(--dv-surface2); border-color: rgba(168,85,247,.3); }
    .conv-item.active::before {
      content: ""; position: absolute; left: 0; top: 50%; transform: translateY(-50%);
      width: 3px; height: 24px; background: var(--dv-grad); border-radius: 999px; box-shadow: var(--dv-gradGlow);
    }
    .conv-visitor { font-size: 13px; font-weight: 600; color: var(--dv-text); margin-bottom: 2px; }
    .conv-preview { font-size: 12px; color: var(--dv-muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 4px; }
    .conv-date { font-size: 11px; color: var(--dv-muted2); }

    /* Conversation Detail */
    .conv-detail {
      background: var(--dv-surface); border: 1px solid var(--dv-stroke);
      border-radius: var(--dv-radius-xl); overflow: hidden; display: flex; flex-direction: column;
    }
    .conv-meta {
      padding: 16px 20px; border-bottom: 1px solid var(--dv-stroke);
      display: flex; justify-content: space-between; align-items: center;
    }
    .conv-meta-title { font-size: 14px; font-weight: 700; color: var(--dv-text); }
    .conv-meta-visitor { font-size: 12px; color: var(--dv-muted); }

    .messages-container {
      flex: 1; overflow-y: auto; padding: 20px;
      display: flex; flex-direction: column; gap: 12px;
    }
    .messages-container::-webkit-scrollbar { width: 4px; }
    .messages-container::-webkit-scrollbar-thumb { background: var(--dv-stroke2); border-radius: 4px; }

    .msg {
      max-width: 80%; padding: 12px 16px; border-radius: var(--dv-radius-md);
      font-size: 13px; line-height: 1.6; position: relative;
    }
    .msg.user {
      align-self: flex-end; background: rgba(168,85,247,0.12);
      color: var(--dv-text); border: 1px solid rgba(168,85,247,.18);
    }
    .msg.bot {
      align-self: flex-start; background: var(--dv-surface2);
      color: var(--dv-text); border: 1px solid var(--dv-stroke);
    }
    .msg-time { font-size: 10px; color: var(--dv-muted2); margin-top: 4px; }

    /* Empty State */
    .empty-state {
      flex: 1; display: flex; flex-direction: column; align-items: center;
      justify-content: center; gap: 12px; padding: 40px;
    }
    .empty-state-icon {
      width: 56px; height: 56px; border-radius: 16px;
      background: var(--dv-surface); border: 1px solid var(--dv-stroke);
      display: flex; align-items: center; justify-content: center;
    }
    .empty-state-icon svg { width: 24px; height: 24px; color: var(--dv-muted); stroke-width: 1.5; }
    .empty-state-text { font-size: 13px; color: var(--dv-muted); text-align: center; }
  </style>
</head>
<body>
  <canvas id="ambientParticles"></canvas>
  <div id="page-wrapper">
    <div id="sidebar-spacer"></div>
    <div id="main-content">
      <div class="page" id="historia_root" data-user-id="CURRENT USER" data-bot-id="">
        <div class="page-header">
          <div class="page-title" data-i18n="history.page.heading"></div>
          <div class="page-subtitle" data-i18n="history.page.subtitle"></div>
        </div>

        <div class="conv-layout">
          <div class="conv-list">
            <div class="conv-list-header">
              <span data-i18n="history.list.title"></span>
              <span class="conv-count" id="convCount">0</span>
            </div>
            <div class="conv-items" id="convItems">
              <div class="empty-state">
                <div class="empty-state-icon">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M8.625 12a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0H8.25m4.125 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0H12m4.125 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0h-.375M21 12c0 4.556-4.03 8.25-9 8.25a9.764 9.764 0 01-2.555-.337A5.972 5.972 0 015.41 20.97a5.969 5.969 0 01-.474-.065 4.48 4.48 0 00.978-2.025c.09-.457-.133-.901-.467-1.226C3.93 16.178 3 14.189 3 12c0-4.556 4.03-8.25 9-8.25s9 3.694 9 8.25z" />
                  </svg>
                </div>
                <div class="empty-state-text" data-i18n="history.list.empty"></div>
              </div>
            </div>
          </div>

          <div class="conv-detail">
            <div class="conv-meta" id="convMeta">
              <div class="conv-meta-title" data-i18n="history.details.title"></div>
              <div class="conv-meta-visitor" id="convMetaVisitor" data-i18n="history.details.selectHint"></div>
            </div>
            <div class="messages-container" id="convMessages">
              <div class="empty-state">
                <div class="empty-state-icon">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M7.5 8.25h9m-9 3H12m-9.75 1.51c0 1.6 1.123 2.994 2.707 3.227 1.129.166 2.27.293 3.423.379.35.026.67.21.865.501L12 21l2.755-4.133a1.14 1.14 0 01.865-.501 48.172 48.172 0 003.423-.379c1.584-.233 2.707-1.626 2.707-3.228V6.741c0-1.602-1.123-2.995-2.707-3.228A48.394 48.394 0 0012 3c-2.392 0-4.744.175-7.043.513C3.373 3.746 2.25 5.14 2.25 6.741v6.018z" />
                  </svg>
                </div>
                <div class="empty-state-text" data-i18n="history.details.selectLeftHint"></div>
              </div>
            </div>
          </div>
        </div>
  </div>
  </div>
  </div>

  <div id="history-i18n" style="display:none">
    <span id="i18n-history-visitor" data-i18n="history.conversation.visitorFallback"></span>
    <span id="i18n-history-preview" data-i18n="history.conversation.previewFallback"></span>
  </div>

  <script type="module">
    const API_CONVERSATIONS = "/api/conversations";
    const API_MESSAGES = "/api/messages";

    const root = document.getElementById('historia_root');
    const convItems = document.getElementById('convItems');
    const convCount = document.getElementById('convCount');
    const convMessages = document.getElementById('convMessages');
    const convMetaVisitor = document.getElementById('convMetaVisitor');
    const i18nText = (id) => document.getElementById(id)?.textContent || "";

    function translateDynamicContent() {
      if (window.DaVeriI18n?.translatePage) {
        window.DaVeriI18n.translatePage();
      }
    }

    async function fetchJson(url, options = {}) {
      const response = await fetch(url, {
        credentials: "include",
        ...options
      });
      let payload = null;
      try {
        payload = await response.json();
      } catch {
        payload = null;
      }
      if (!response.ok) {
        throw new Error(payload?.error || `Request failed: ${response.status}`);
      }
      return payload;
    }

    function fmtDate(d) {
      if (!d) return '';
      const dt = new Date(d);
      return dt.toLocaleDateString('pl-PL', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
    }

    async function loadConversations() {
      const botId = root?.dataset?.botId;
      let endpoint = `${API_CONVERSATIONS}?limit=50`;
      if (botId) endpoint += `&bot_id=${encodeURIComponent(botId)}`;

      let convs = [];
      try {
        const payload = await fetchJson(endpoint);
        convs = Array.isArray(payload?.conversations) ? payload.conversations : [];
      } catch (error) {
        console.error("[History] conversations load failed:", error);
        convs = [];
      }
      convCount.textContent = convs.length;
      convItems.innerHTML = '';
      if (!convs.length) {
        convItems.innerHTML = '<div class="empty-state"><div class="empty-state-text" data-i18n="history.list.empty"></div></div>';
        translateDynamicContent();
        return;
      }
      convs.forEach(conv => {
        const el = document.createElement('div');
        el.className = 'conv-item';
        el.innerHTML = `
          <div class="conv-visitor">${conv.visitor_id || conv.visitor_name || i18nText("i18n-history-visitor")}</div>
          <div class="conv-preview">${conv.last_message_preview || conv.last_message || i18nText("i18n-history-preview")}</div>
          <div class="conv-date">${fmtDate(conv.created_at)}</div>
        `;
        el.onclick = () => {
          document.querySelectorAll('.conv-item').forEach(i => i.classList.remove('active'));
          el.classList.add('active');
          loadMessages(conv.id, conv.visitor_id || conv.visitor_name);
        };
        convItems.appendChild(el);
      });
    }

    async function loadMessages(convId, visitorName) {
      convMetaVisitor.textContent = visitorName || i18nText("i18n-history-visitor");
      let msgs = [];
      try {
        const payload = await fetchJson(`${API_MESSAGES}?conversation_id=${encodeURIComponent(convId)}`);
        msgs = Array.isArray(payload?.messages) ? payload.messages : [];
      } catch (error) {
        console.error("[History] messages load failed:", error);
        msgs = [];
      }

      convMessages.innerHTML = '';
      if (!msgs?.length) {
        convMessages.innerHTML = '<div class="empty-state"><div class="empty-state-text" data-i18n="history.messages.empty"></div></div>';
        translateDynamicContent();
        return;
      }
      msgs.forEach(msg => {
        const el = document.createElement('div');
        el.className = `msg ${msg.role === 'user' ? 'user' : 'bot'}`;
        el.innerHTML = `<div>${msg.content || ''}</div><div class="msg-time">${fmtDate(msg.created_at)}</div>`;
        convMessages.appendChild(el);
      });
      convMessages.scrollTop = convMessages.scrollHeight;
    }

    loadConversations();
  </script>

  <script type="module" src="../js/language.js"></script>
  <script type="module" src="../js/auth-bootstrap.js"></script>
  <script type="module" src="../js/sidebar-loader.js"></script>

  <!-- Particles -->
  <script>
  (function() {
    const canvas = document.getElementById('ambientParticles');
    if (!canvas) return;
    const ctx = canvas.getContext('2d'); let particles = []; const count = 50; let aId;
    function resize() { canvas.width = innerWidth; canvas.height = innerHeight; }
    function create() { return { x: Math.random()*canvas.width, y: Math.random()*canvas.height, s: Math.random()+0.8, sx: (Math.random()-0.5)*0.12, sy: (Math.random()-0.5)*0.12, o: Math.random()*0.08+0.04, od: Math.random()>0.5?1:-1, os: Math.random()*0.0008+0.0004 }; }
    function init() { particles = []; for (let i=0; i<count; i++) particles.push(create()); }
    function animate() {
      ctx.clearRect(0,0,canvas.width,canvas.height);
      const light = document.documentElement.getAttribute('data-theme') === 'light';
      particles.forEach(p => {
        p.x += p.sx; p.y += p.sy;
        if (p.x<0) p.x=canvas.width; if (p.x>canvas.width) p.x=0;
        if (p.y<0) p.y=canvas.height; if (p.y>canvas.height) p.y=0;
        p.o += p.od*p.os;
        if (p.o>=0.12) { p.o=0.12; p.od=-1; } else if (p.o<=0.04) { p.o=0.04; p.od=1; }
        ctx.beginPath(); ctx.arc(p.x,p.y,p.s,0,Math.PI*2);
        ctx.fillStyle = light ? `rgba(0,0,0,${p.o})` : `rgba(255,255,255,${p.o})`;
        ctx.fill();
      });
      aId = requestAnimationFrame(animate);
    }
    resize(); init(); animate();
    addEventListener('resize', () => { resize(); init(); });
  })();
  </script>
  <script type="module" src="../js/i18n.js"></script>
</body>
</html>
