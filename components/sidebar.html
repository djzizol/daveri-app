<!doctype html>
<html lang="pl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>DaVeri Sidebar - Synchronizowany</title>
<style>
/* ========== PODSTAWOWE STYLE ========== */
#chatekai_root,
#chatekai_root *{ box-sizing:border-box; }

#chatekai_root{
  font-family: ui-sans-serif, -apple-system, BlinkMacSystemFont, "SF Pro Display", Inter, "Segoe UI", sans-serif;
  -webkit-font-smoothing: antialiased;
  letter-spacing:-0.01em;
  color:#e5e7eb;

  /* ===== CHATGPT STYLE - DARK SIDEBAR ===== */
  --sb-bg:#171717;
  --sb-bg2:#1e1e1e;
  --sb-panel:#262626;
  --sb-surface:#2a2a2a;
  --sb-surface2:#3a3a3a;
  --sb-stroke:#333333;
  --sb-stroke2:#444444;
  --sb-text:#ececec;
  --sb-muted:#9a9a9a;
  --sb-muted2:#6a6a6a;
  
  /* ===== BRAND GRADIENTS ===== */
  --sb-grad:linear-gradient(135deg, #fb7185 0%, #a855f7 48%, #60a5fa 100%);
  --sb-gradGlow:0 0 12px rgba(168,85,247,.3);
  
  /* ===== ACCENT ===== */
  --sb-accent:#8b5cf6;
  --sb-accent-hover:#a78bfa;

  --sb-radius:8px;
  --sb-radius-md:6px;
  --sb-ease:cubic-bezier(.22,.61,.36,1);

  --dv-liquidA: rgba(251, 113, 133, .95);
  --dv-liquidB: rgba(168, 85, 247, .85);
  --dv-liquidC: rgba(96, 165, 250, .75);
}

/* Light mode - clean, readable */
[data-theme="light"] #chatekai_root {
  --sb-bg:#f5f5f5;
  --sb-bg2:#ffffff;
  --sb-panel:#ffffff;
  --sb-surface:#e8e8e8;
  --sb-surface2:#dcdcdc;
  --sb-stroke:#e0e0e0;
  --sb-stroke2:#d0d0d0;
  --sb-text:#1a1a1a;
  --sb-muted:#5a5a5a;
  --sb-muted2:#8a8a8a;
  color:#1a1a1a;
}
/* Light mode - specific element overrides */
[data-theme="light"] #chatekai_root .nav-group-label{color:var(--sb-muted);}
[data-theme="light"] #chatekai_root .nav-item{color:var(--sb-text);}
[data-theme="light"] #chatekai_root .nav-item:hover{background:var(--sb-surface);color:var(--sb-text);}
[data-theme="light"] #chatekai_root .nav-item.active{background:var(--sb-surface);color:var(--sb-text);}
[data-theme="light"] #chatekai_root .icon-btn{background:var(--sb-surface);border-color:var(--sb-stroke);}
[data-theme="light"] #chatekai_root .icon-btn:hover{background:var(--sb-surface2);border-color:var(--sb-stroke2);}
[data-theme="light"] #chatekai_root .icon-btn svg{color:var(--sb-muted);}
[data-theme="light"] #chatekai_root .mark .mark-ham{background:var(--sb-surface);border-color:var(--sb-stroke);}
[data-theme="light"] #chatekai_root .mark .mark-ham svg{color:var(--sb-muted);}
[data-theme="light"] #chatekai_root .user{border-top-color:var(--sb-stroke);}
[data-theme="light"] #chatekai_root .user-btn{border-color:var(--sb-stroke);color:var(--sb-text);background:var(--sb-surface);}
[data-theme="light"] #chatekai_root .user-btn:hover{background:var(--sb-surface2);}
[data-theme="light"] #chatekai_root .badge{background:var(--sb-surface);color:var(--sb-muted);border-color:var(--sb-stroke);}
[data-theme="light"] #chatekai_root .plan-card{background:var(--sb-surface);border-color:var(--sb-stroke);}
[data-theme="light"] #chatekai_root .plan-tag{background:var(--sb-surface2);color:var(--sb-text);border-color:var(--sb-stroke);}
[data-theme="light"] #chatekai_root .tooltip{background:var(--sb-panel);color:var(--sb-text);border-color:var(--sb-stroke);}

/* ========== SIDEBAR - CLEAN ========== */
#chatekai_root .sidebar{
  position:fixed;
  inset:0 auto 0 0;
  width:260px;
  height:100vh;
  background: var(--sb-bg);
  border-right:1px solid var(--sb-stroke);
  display:flex;
  flex-direction:column;
  transition:width .2s var(--sb-ease), transform .2s var(--sb-ease);
  z-index:1000;
  overflow:hidden;
  color:var(--sb-text);
}
#chatekai_root .sidebar.collapsed{width:72px;}
#chatekai_root .sidebar.hidden{transform:translateX(-100%);}

/* HEADER */
#chatekai_root .header{
  position:relative;
  padding:12px 12px 8px;
}
#chatekai_root .brand{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:8px;
  padding:8px;
  border-radius:var(--sb-radius);
  background:transparent;
}
#chatekai_root .brand-left{
  display:flex;
  align-items:center;
  gap:10px;
  min-width:0;
}
#chatekai_root .brand-right{
  display:flex;
  align-items:center;
  gap:8px;
}

/* LOGO - zmniejszone */
#chatekai_root .mark{
  width:40px;
  height:40px;
  display:flex;
  align-items:center;
  justify-content:center;
  background:transparent;
  border-radius:12px;
  position:relative;
}
#chatekai_root .mark img{
  width:40px;
  height:40px;
  object-fit:contain;
  display:block;
  border-radius:12px;
}

/* hamburger overlay w collapsed */
#chatekai_root .mark .mark-ham{
  position:absolute;
  inset:0;
  display:grid;
  place-items:center;
  border-radius:16px;
  background:rgba(255,255,255,.03);
  border:1px solid rgba(255,255,255,.10);
  opacity:0;
  transform:scale(.98);
  transition:opacity .14s var(--sb-ease), transform .14s var(--sb-ease), background .14s var(--sb-ease);
  cursor:pointer;
}
#chatekai_root .mark .mark-ham svg{
  width:20px;height:20px;
  display:block;
  color:rgba(244,244,245,.92);
}
#chatekai_root .sidebar.collapsed .mark:hover .mark-ham{
  opacity:1;
  transform:scale(1);
  background:rgba(255,255,255,.05);
}
/* W zwiniętym sidebarze przy hover na logo – chowaj logo, pokazuj ikonę rozwiń */
#chatekai_root .sidebar.collapsed .mark:hover img{
  opacity:0;
  pointer-events:none;
}
#chatekai_root .sidebar.collapsed .mark img{
  transition:opacity .14s var(--sb-ease);
}
#chatekai_root .sidebar:not(.collapsed) .mark .mark-ham{ display:none; }

/* icon button - zmniejszony */
#chatekai_root .icon-btn{
  height:30px;
  width:30px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.10);
  background:rgba(255,255,255,.03);
  cursor:pointer;
  display:grid;
  place-items:center;
  color:var(--sb-text);
  transition:transform .14s var(--sb-ease), background .14s var(--sb-ease), border-color .14s var(--sb-ease);
}
#chatekai_root .icon-btn:hover{
  background:rgba(255,255,255,.05);
  border-color:rgba(255,255,255,.14);
}
#chatekai_root .icon-btn:active{transform:scale(.98);}
#chatekai_root .icon-btn:focus{
  outline:none;
  box-shadow:0 0 0 3px rgba(96,165,250,.18);
}
#chatekai_root .sidebar-toggle-icon{width:20px;height:20px;display:block;}

#chatekai_root .sidebar.collapsed .header{padding:12px 10px 10px;}
#chatekai_root .sidebar.collapsed .brand{padding:8px; justify-content:flex-end;}
#chatekai_root .sidebar.collapsed .brand-right{display:none;}

/* NAVIGATION */
#chatekai_root .nav{
  position:relative;
  flex:1;
  padding:14px 12px 16px;
  overflow-y:auto;
  scrollbar-width:none;
}
#chatekai_root .nav::-webkit-scrollbar{width:0;height:0;}
#chatekai_root .section{margin-top:2px;}
#chatekai_root .section:first-child{margin-top:0;}
/* Section headers – Microsoft 365 style */
#chatekai_root .nav-label{
  font-size:10px;
  font-weight:500;
  letter-spacing:.12em;
  color:rgba(255,255,255,0.45);
  margin:16px 12px 8px;
  text-transform:uppercase;
}
#chatekai_root .sidebar.collapsed .nav-label{display:none;}

/* NAV ITEM – typography, spacing, no transform */
#chatekai_root .nav-item{
  position:relative;
  display:flex;
  align-items:center;
  gap:12px;
  padding:12px 14px;
  border-radius:var(--sb-radius-md);
  cursor:pointer;
  user-select:none;
  border:none;
  background:transparent;
  color:rgba(255,255,255,0.80);
  font-size:14px;
  font-weight:500;
  letter-spacing:0.2px;
  transition:background 120ms ease;
}
#chatekai_root .nav-item:hover{ 
  background:rgba(255,255,255,0.04);
  color:rgba(255,255,255,0.80);
}
#chatekai_root .nav-item:active {
  background:rgba(255,255,255,0.04);
}
#chatekai_root .nav-item.active {
  background:rgba(255,255,255,0.04);
  color:#ffffff;
}

/* Icons – vector SVG, aligned with text */
#chatekai_root .nav-ico{
  width:24px;
  height:24px;
  flex:0 0 24px;
  display:block;
  object-fit:contain;
  opacity:0.7;
  transition:opacity 120ms ease;
  vertical-align:middle;
}
#chatekai_root .nav-ico img{
  width:100%; height:100%; object-fit:contain; display:block;
}
#chatekai_root svg.nav-ico{
  stroke:currentColor;
  fill:none;
  stroke-width:2;
  stroke-linecap:round;
  stroke-linejoin:round;
}
#chatekai_root .nav-item:hover .nav-ico{
  opacity:0.85;
}
#chatekai_root .nav-item.active .nav-ico{
  opacity:1;
}

/* label */
#chatekai_root .nav-item .label{
  flex:1;
  min-width:0;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}

/* badge NEW – reduced weight */
#chatekai_root .badge{
  font-size:10px;
  font-weight:600;
  letter-spacing:.08em;
  text-transform:uppercase;
  color:rgba(255,255,255,0.65);
  background:rgba(255,255,255,0.06);
  border:1px solid rgba(255,255,255,0.08);
  padding:3px 8px;
  border-radius:999px;
}

/* ACTIVE STATE – subtle 2px left accent, no gradient */
#chatekai_root .nav-item.active{ opacity:1; }
#chatekai_root .nav-item.active .label{
  color:#ffffff;
  font-weight:600;
}
#chatekai_root .nav-item.active::before{
  content:"";
  position:absolute;
  left:0;
  top:50%;
  transform:translateY(-50%);
  width:2px;
  height:20px;
  border-radius:999px;
  background:#ffffff;
  opacity:0.9;
}

/* TOOLTIP (tylko w collapsed) */
#chatekai_root .tip{
  position:absolute;
  left:76px;
  top:50%;
  transform:translateY(-50%) scale(.96);
  background:rgba(20,22,26,.98);
  color:var(--sb-text);
  font-size:12px;
  padding:8px 12px;
  border-radius:12px;
  white-space:nowrap;
  opacity:0;
  pointer-events:none;
  border:1px solid rgba(255,255,255,.10);
  box-shadow:0 18px 40px rgba(0,0,0,.55);
  transition:opacity .14s var(--sb-ease), transform .14s var(--sb-ease);
}
#chatekai_root .sidebar.collapsed .nav-item:hover .tip{
  opacity:1;
  transform:translateY(-50%) scale(1);
}
#chatekai_root .sidebar:not(.collapsed) .tip{display:none;}

/* COLLAPSED NAV - tylko ikony, bez boxow */
#chatekai_root .sidebar.collapsed .nav{
  padding:8px 6px;
  overflow-y:hidden;
}
#chatekai_root .sidebar.collapsed .nav-item{
  width:52px;
  min-height:44px;
  margin:2px auto;
  padding:12px 0;
  justify-content:center;
  border-radius:var(--sb-radius);
  background:transparent;
  border:none;
}
#chatekai_root .sidebar.collapsed .nav-item:hover{
  background:rgba(255,255,255,0.04);
}
#chatekai_root .sidebar.collapsed .nav-item.active{
  background:rgba(255,255,255,0.04);
}
#chatekai_root .sidebar.collapsed .nav-ico{
  width:24px;
  height:24px;
}
#chatekai_root .sidebar.collapsed .nav-item .label,
#chatekai_root .sidebar.collapsed .nav-item .badge{display:none;}
#chatekai_root .sidebar.collapsed .nav-item.active::before{
  height:18px;
  left:0;
}

/* ===== THEME TOGGLE - SINGLE DARK BAR ===== */
#chatekai_root .theme-toggle-section{
  margin:8px 12px;
  padding:0;
  border-radius:var(--sb-radius);
  background:transparent;
}
#chatekai_root .theme-toggle-label{
  display:none;
}
#chatekai_root .theme-toggle-buttons{
  display:flex;
  gap:2px;
  background:var(--sb-surface);
  padding:4px;
  border-radius:var(--sb-radius);
  border:1px solid var(--sb-stroke);
  }
#chatekai_root .theme-btn{
  flex:1;
  display:flex;
  align-items:center;
  justify-content:center;
  padding:10px 12px;
  border:none;
  border-radius:calc(var(--sb-radius) - 2px);
  background:transparent;
  color:var(--sb-muted);
  cursor:pointer;
  transition:all .2s cubic-bezier(.4,0,.2,1), transform .15s ease;
}
#chatekai_root .theme-btn svg{
  width:16px;
  height:16px;
}
#chatekai_root .theme-btn:hover{
  color:var(--sb-text);
  background:var(--sb-surface2);
  }
#chatekai_root .theme-btn:active{
  transform:scale(0.95);
}
#chatekai_root .theme-btn.active{
  background:var(--sb-grad);
  color:#fff;
  box-shadow:0 2px 8px rgba(168,85,247,.3);
  }
  [data-theme="light"] #chatekai_root .theme-btn.active{
  background:var(--sb-text);
  color:#fff;
  box-shadow:0 2px 6px rgba(0,0,0,.15);
  }
#chatekai_root .sidebar.collapsed .theme-toggle-section{
  padding:0;
  margin:8px 10px;
}
#chatekai_root .sidebar.collapsed .theme-toggle-buttons{
  flex-direction:column;
  gap:2px;
}
#chatekai_root .sidebar.collapsed .theme-btn{
  padding:10px;
}

/* ===== PLAN CARD - CLEAN ===== */
#chatekai_root .plan-card{
  margin:8px 12px;
  padding:12px;
  border-radius:var(--sb-radius);
  border:1px solid var(--sb-stroke);
  background:var(--sb-surface);
  display:flex;
  flex-direction:column;
  gap:10px;
  position:relative;
  color:var(--sb-text);
  margin-top:auto;
}

#chatekai_root .plan-card-header,
#chatekai_root .plan-card-body{
  position:relative;
  z-index:1;
}

#chatekai_root .plan-card-header{
  display:flex;
  align-items:flex-start;
  justify-content:space-between;
  gap:10px;
}
#chatekai_root .plan-label{
  font-size:10px;
  text-transform:uppercase;
  letter-spacing:.12em;
  color:rgba(244,244,245,.82);
}
#chatekai_root .plan-name{
  font-size:14px;
  font-weight:800;
  color:#fff;
  margin-top:2px;
}
#chatekai_root .plan-pill{
  padding:3px 8px;
  border-radius:999px;
  font-size:10px;
  font-weight:800;
  letter-spacing:.10em;
  text-transform:uppercase;
  background:rgba(255,255,255,.06);
  color:#fff;
  border:1px solid rgba(255,255,255,.14);
  white-space:nowrap;
}

/* BODY – orb + tekst */
#chatekai_root .plan-card-body{
  display:flex;
  align-items:center;
  gap:14px;
  margin-top:2px;
}

#chatekai_root .plan-credits-box{min-width:0;}
#chatekai_root .plan-credits-main{
  font-size:12px;
  font-weight:900;
  color:#fff;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}
#chatekai_root .plan-credits-sub{
  margin-top:2px;
  font-size:11px;
  line-height:1.25;
  color:rgba(244,244,245,.72);
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}

/* ===== USER / FOOTER – reduced visual weight ===== */
#chatekai_root .user{
  position:relative;
  padding:10px 12px 12px;
  border-top:1px solid rgba(255,255,255,0.06);
  margin-top:8px;
}
#chatekai_root .user-btn{
  width:100%;
  border-radius:var(--sb-radius);
  padding:10px;
  cursor:pointer;
  display:flex;
  align-items:center;
  gap:10px;
  border:1px solid rgba(255,255,255,0.06);
  color:rgba(255,255,255,0.75);
  background:rgba(255,255,255,0.02);
  transition:background 120ms ease;
}
#chatekai_root .user-btn:hover{
  background:rgba(255,255,255,0.04);
  border-color:rgba(255,255,255,0.08);
}
#chatekai_root .user-btn:active{
  background:rgba(255,255,255,0.04);
}
/* User card text – lower contrast */
#chatekai_root .user-meta .name{
  color:rgba(255,255,255,0.78);
  font-weight:500;
}
#chatekai_root .user-meta .email{
  color:rgba(255,255,255,0.45);
}

#chatekai_root .user-btn > *{
  position:relative;
  z-index:1;
}

#chatekai_root .avatar{
  width:36px;height:36px;border-radius:50%;
  overflow:hidden;border:1px solid rgba(255,255,255,0.08);
  background:rgba(255,255,255,0.04);
  display:grid;place-items:center;flex:0 0 auto;
}
#chatekai_root .avatar img{ width:100%; height:100%; object-fit:cover; display:block; }
#chatekai_root .user-meta strong{display:block;font-size:13px;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
#chatekai_root .user-meta span{display:block;font-size:12px;color:rgba(255,255,255,0.45);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
#chatekai_root .chev{width:18px;height:18px;opacity:0.5;flex:0 0 auto;color:rgba(255,255,255,0.5);}

/* Collapsed user - elegancka ikona */
#chatekai_root .sidebar.collapsed .user{padding:8px;}
#chatekai_root .sidebar.collapsed .user-btn{
  width:52px;
  height:52px;
  margin:0 auto;
  padding:0;
  justify-content:center;
  border-radius:12px;
  background:rgba(255,255,255,0.03);
}
#chatekai_root .sidebar.collapsed .user-btn .avatar{width:32px;height:32px;}
#chatekai_root .sidebar.collapsed .user-meta,
#chatekai_root .sidebar.collapsed .chev{display:none;}

/* Collapsed plan card - kompaktowa ikona */
#chatekai_root .sidebar.collapsed .plan-card{
  width:52px;
  height:52px;
  margin:8px auto;
  padding:0;
  border-radius:12px;
  display:grid;
  place-items:center;
}
#chatekai_root .sidebar.collapsed .plan-card-header,
#chatekai_root .sidebar.collapsed .plan-credits-box{display:none;}
#chatekai_root .sidebar.collapsed .plan-card-body{
  margin:0;
  gap:0;
}
#chatekai_root .sidebar.collapsed .plan-liquid-shell{
  width:36px;
  height:36px;
}
#chatekai_root .sidebar.collapsed .plan-liquid-percent{font-size:10px;}
#chatekai_root .sidebar.collapsed .plan-liquid-sub{display:none;}

/* ===== DROPDOWN ===== */
.ck-dropdown.dv-dd{
  background:rgba(15,17,20,.98);
  border:1px solid rgba(255,255,255,.10);
  border-radius:16px;
  box-shadow:0 18px 55px rgba(0,0,0,.65);
  padding:6px;
  transform-origin:bottom center;
  transform:translateY(6px) scale(.98);
  opacity:0;
  pointer-events:none;
  transition:transform .18s var(--sb-ease), opacity .18s var(--sb-ease);
  visibility:hidden;
  z-index:5000;
}
.ck-dropdown.dv-dd.open{
  transform:translateY(0) scale(1);
  opacity:1;
  pointer-events:auto;
  visibility:visible;
}
.ck-dropdown.dv-dd .dd-item{
  width:100%;
  border:none;
  background:transparent;
  padding:10px 12px;
  border-radius:12px;
  cursor:pointer;
  display:flex;
  align-items:center;
  gap:10px;
  color:var(--sb-text);
  font-weight:650;
  white-space:nowrap;
}
.ck-dropdown.dv-dd .dd-item:hover{background:rgba(255,255,255,.05);}
.ck-dropdown.dv-dd .dd-item svg{
  width:18px;height:18px;
  stroke:rgba(244,244,245,.70);
  fill:none;stroke-width:2;
  stroke-linecap:round;stroke-linejoin:round;
}
.ck-dropdown.dv-dd .dd-item.danger{color:#f97373;}
.ck-dropdown.dv-dd .dd-item.danger svg{stroke:#f97373;}
.ck-dropdown.dv-dd:not(.open){
  left:-9999px !important;
  bottom:-9999px !important;
}

/* ===== PLAN LIQUID (CANVAS) ===== */
#chatekai_root .plan-liquid{ flex:0 0 auto; }
#chatekai_root .plan-liquid-shell{
  width:60px;
  height:60px;
  border-radius:999px;
  position:relative;
  overflow:hidden;
  border:1px solid rgba(255,255,255,.18);
  background:
    radial-gradient(circle at 30% 20%, rgba(255,255,255,.12), transparent 60%),
    radial-gradient(circle at 70% 80%, rgba(255,255,255,.06), transparent 60%),
    linear-gradient(180deg, #050608, #0b0d12);
  box-shadow:
    inset 0 0 12px rgba(255,255,255,.04),
    inset 0 -8px 16px rgba(0,0,0,.55),
    0 12px 32px rgba(0,0,0,.6);
}
#chatekai_root .plan-liquid-shell::after{
  content:"";
  position:absolute;
  inset:-2px;
  border-radius:999px;
  background:conic-gradient(
    from 0deg,
    #fb7185,
    #a855f7,
    #60a5fa,
    #fb7185
  );
  filter: blur(8px);
  opacity:.22;
  animation: dvPearlSpin 6s linear infinite;
  pointer-events:none;
}

@keyframes dvPearlSpin{
  from{ transform:rotate(0deg); }
  to{ transform:rotate(360deg); }
}

#chatekai_root #planLiquidCanvas{
  width:100%;
  height:100%;
  display:block;
}
#chatekai_root .plan-liquid-shell::before{
  content:"";
  position:absolute; inset:0;
  pointer-events:none;
  background:
    radial-gradient(70% 55% at 30% 22%, rgba(255,255,255,.22), rgba(255,255,255,0) 60%),
    radial-gradient(60% 60% at 78% 18%, rgba(255,255,255,.12), rgba(255,255,255,0) 55%),
    linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,0) 46%, rgba(0,0,0,.20));
  opacity:.9;
}

/* UI centered */
#chatekai_root .plan-liquid-ui{
  position:absolute;
  inset:0;
  display:grid;
  place-items:center;
  text-align:center;
  pointer-events:none;
}
#chatekai_root .plan-liquid-percent{
  font-weight:900;
  font-size:14px;
  letter-spacing:-0.02em;
  color:#fff;
  text-shadow:0 6px 14px rgba(0,0,0,.55);
}
#chatekai_root .plan-liquid-sub{
  margin-top:-2px;
  font-size:8px;
  font-weight:800;
  letter-spacing:.10em;
  text-transform:uppercase;
  color:rgba(244,244,245,.70);
}
</style>
</head>

<body>
<!-- holders bubble -->
<div id="b_provider" style="display:none;">gogleauthprov</div>
<div id="b_name" style="display:none;">CURENTUSERGOOGLE FIRSTNAME</div>
<div id="b_email" style="display:none;">CURENTUSEREMIAL</div>
<div id="b_avatar" style="display:none;">CurentGoglePRofilePictru</div>

<div id="chatekai_root" data-user-id="XXXXXXXXXXXXXXX">
  <aside class="sidebar chat-sidebar" id="sidebar">
    <div class="header">
      <div class="brand">
        <div class="brand-left">
          <div class="mark" id="logoToggle">
            <!-- ZAKTUALIZOWANE LOGO -->
            <img src="https://d98a890ebc03293bc70c4f2e92e9e2e5.cdn.bubble.io/f1768755240414x775862930699997600/logo64.png?_gl=1*1xuqcq7*_gcl_aw*R0NMLjE3NjQ4ODcxODcuQ2owS0NRaUFfOFRKQmhETkFSSXNBUFg1cXhSS2s1aWxkS2hydXJydnNXVm9IUGFvT1NTZ3VvTWVFM0NhZmd4WnJqU0t5SG51ZFAtS0FUc2FBaHRkRUFMd193Y0I.*_gcl_au*MTg4MzA5OTI1OC4xNzY0Nzg5MjY0*_ga*OTczNDY5ODUzLjE3NjQ2MDc2MTI.*_ga_BFPVR2DEE2*czE3NzAyMzI2MjgkbzUwJGcxJHQxNzcwMjM5MTY1JGo2MCRsMCRoMA.." alt="DaVeri logo" />

            <!-- Ikona rozwiń – zaokrąglony kwadrat z paskiem po lewej (styl ChatGPT/Copilot) -->
            <div class="mark-ham" role="button" aria-label="Rozwiń sidebar">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect x="5" y="6" width="14" height="12" rx="3"/>
                <line x1="9" y1="8" x2="9" y2="16"/>
              </svg>
            </div>
          </div>
        </div>

        <div class="brand-right">
          <button class="icon-btn" id="collapseBtn" aria-label="Zwiń/rozwiń sidebar" type="button">
            <svg class="sidebar-toggle-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <rect x="5" y="6" width="14" height="12" rx="3"/>
              <line x1="9" y1="8" x2="9" y2="16"/>
            </svg>
          </button>
        </div>
      </div>
    </div>

    <nav class="nav" aria-label="Nawigacja">
      <div class="section">
        <div class="nav-item" tabindex="0" data-route="panel">
          <img class="nav-ico" src="https://d98a890ebc03293bc70c4f2e92e9e2e5.cdn.bubble.io/f1770249154059x102876966522698510/panel.svg" alt="" width="24" height="24" aria-hidden="true" />
          <span class="label">Panel</span>
          <span class="badge">NEW</span>
          <span class="tip">Panel</span>
        </div>
      </div>

      <div class="nav-label">Warsztat</div>

      <div class="section">
        <div class="nav-item" tabindex="0" data-route="boty">
          <img class="nav-ico" src="https://d98a890ebc03293bc70c4f2e92e9e2e5.cdn.bubble.io/f1770249140796x253773293772721950/boty.svg" alt="" width="24" height="24" aria-hidden="true" />
          <span class="label">Boty</span>
          <span class="tip">Boty</span>
        </div>

        <div class="nav-item" tabindex="0" data-route="historia">
          <img class="nav-ico" src="https://d98a890ebc03293bc70c4f2e92e9e2e5.cdn.bubble.io/f1770249131284x840037696645927700/hisotria.svg" alt="" width="24" height="24" aria-hidden="true" />
          <span class="label">Historia rozmów</span>
          <span class="tip">Historia rozmów</span>
        </div>

        <div class="nav-item" tabindex="0" data-route="prompt">
          <img class="nav-ico" src="https://d98a890ebc03293bc70c4f2e92e9e2e5.cdn.bubble.io/f1770249125077x656254872647275600/prompt.svg" alt="" width="24" height="24" aria-hidden="true" />
          <span class="label">Prompt</span>
          <span class="tip">Prompt</span>
        </div>

        <div class="nav-item" tabindex="0" data-route="wyglad">
          <img class="nav-ico" src="https://d98a890ebc03293bc70c4f2e92e9e2e5.cdn.bubble.io/f1770249145896x475580076785379700/wyglad.svg" alt="" width="24" height="24" aria-hidden="true" />
          <span class="label">Wygląd</span>
          <span class="tip">Wygląd</span>
        </div>

        <div class="nav-item" tabindex="0" data-route="pliki">
          <img class="nav-ico" src="https://d98a890ebc03293bc70c4f2e92e9e2e5.cdn.bubble.io/f1770249121272x452195540458458100/pliki.svg" alt="" width="24" height="24" aria-hidden="true" />
          <span class="label">Pliki</span>
          <span class="tip">Pliki</span>
        </div>

        <div class="nav-item" tabindex="0" data-route="instalacja">
          <img class="nav-ico" src="https://d98a890ebc03293bc70c4f2e92e9e2e5.cdn.bubble.io/f1770249115665x192170676080926980/intalacja.svg" alt="" width="24" height="24" aria-hidden="true" />
          <span class="label">Instalacja</span>
          <span class="tip">Instalacja</span>
        </div>
      </div>
    </nav>

    <!-- PLAN -->
    <div class="plan-card" id="sidebar-plan-card">
      <div class="plan-card-header">
        <div>
          <div class="plan-label">Twój plan</div>
          <div class="plan-name" id="sidebar-plan-name">—</div>
        </div>
        <span class="plan-pill" id="sidebar-plan-pill">PLAN</span>
      </div>

      <div class="plan-card-body">
        <div class="plan-liquid">
          <div class="plan-liquid-shell" aria-hidden="true">
            <canvas id="planLiquidCanvas" width="220" height="220"></canvas>
            <div class="plan-liquid-ui">
              <div class="plan-liquid-percent" id="sidebar-plan-percent">0%</div>
              <div class="plan-liquid-sub">ZOSTAŁO</div>
            </div>
          </div>
        </div>

        <div class="plan-credits-box">
          <div class="plan-credits-main" id="sidebar-plan-credits-main">Ładuję dane…</div>
          <div class="plan-credits-sub" id="sidebar-plan-credits-sub">
            Sprawdzamy Twoje kredyty w tym okresie rozliczeniowym.
          </div>
        </div>
      </div>
    </div><!-- /plan-card -->

    <!-- THEME TOGGLE -->
    <div class="theme-toggle-section">
      <div class="theme-toggle-buttons">
        <button class="theme-btn active" data-theme="system" title="Systemowy">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="3" width="20" height="14" rx="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg>
        </button>
        <button class="theme-btn" data-theme="light" title="Jasny">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="4"/><path d="M12 2v2M12 20v2M4.93 4.93l1.41 1.41M17.66 17.66l1.41 1.41M2 12h2M20 12h2M6.34 17.66l-1.41 1.41M19.07 4.93l-1.41 1.41"/></svg>
        </button>
        <button class="theme-btn" data-theme="dark" title="Ciemny">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
        </button>
      </div>
    </div>

    <!-- USER -->
    <div class="user">
      <div class="dropdown ck-dropdown dv-dd" id="userDropdown">
        <button class="dd-item" type="button" id="goProfileBtn">
          <svg viewBox="0 0 24 24"><path d="M20 21a8 8 0 0 0-16 0"/><circle cx="12" cy="8" r="4"/></svg>
          Profil
        </button>
        <button class="dd-item danger" type="button" id="logoutBtn">
          <svg viewBox="0 0 24 24"><path d="M10 17l5-5-5-5"/><path d="M15 12H3"/><path d="M21 21V3"/></svg>
          Wyloguj
        </button>
      </div>

      <button class="user-btn" id="userBtn" type="button" aria-label="Menu użytkownika">
        <div class="avatar" id="avatarBox" title="Użytkownik"></div>
        <div class="user-meta">
          <strong id="userName">Użytkownik</strong>
          <span id="userSub">—</span>
        </div>
        <svg class="chev" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M6 9l6 6 6-6"/>
        </svg>
      </button>
    </div>
  </aside>
</div>


<script type="module">
  import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

  // Bubble function placeholders
  window.bubble_fn_logout ||= (() => alert("LOCAL: logout (mock)"));
  window.bubble_fn_profile ||= (() => alert("LOCAL: profile (mock)"));
  window.bubble_fn_nav     ||= (route => console.log("LOCAL nav:", route));

  const SUPABASE_URL = "https://inayqymryrriobowyysw.supabase.co";
  const SUPABASE_KEY = "sb_publishable_r3Lvhhf751_SNXg_rmCLQA_LJXv381f";
  const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

  const $  = (sel, root=document) => root.querySelector(sel);
  const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

const LS_KEY = "chatekai_sidebar_collapsed";
  const LS_THEME_KEY = "chatekai_theme";
  const ROUTES = ["panel","boty","historia","prompt","wyglad","pliki","instalacja"];

  // ===== THEME TOGGLE =====
  function getSystemTheme() {
    return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
  }

  function applyTheme(theme) {
    let actualTheme = theme;
    if (theme === 'system') {
      actualTheme = getSystemTheme();
    }
    document.documentElement.setAttribute('data-theme', actualTheme);
    
    // Update active button
    const buttons = document.querySelectorAll('.theme-btn');
    buttons.forEach(btn => {
      btn.classList.toggle('active', btn.dataset.theme === theme);
    });
    
    // Save preference
    localStorage.setItem(LS_THEME_KEY, theme);
  }

  function initTheme() {
    const saved = localStorage.getItem(LS_THEME_KEY) || 'system';
    applyTheme(saved);
    
    // Listen for system theme changes
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
      const current = localStorage.getItem(LS_THEME_KEY) || 'system';
      if (current === 'system') {
        applyTheme('system');
      }
    });
    
    // Theme button clicks
    document.querySelectorAll('.theme-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        applyTheme(btn.dataset.theme);
      });
    });
  }

  // ===== CHAT TOGGLE FUNCTIONS =====
  function openChat() {
    document.body.classList.add('chat-open');
    const els = getEls();
    if(els && els.sidebar) {
      els.sidebar.classList.remove('hidden');
    }
    syncSidebarState(); // DODANE: synchronizuj po otwarciu chatu
  }

  function closeChat() {
    document.body.classList.remove('chat-open');
    const els = getEls();
    if(els && els.sidebar) {
      els.sidebar.classList.add('hidden');
    }
    syncSidebarState(); // DODANE: synchronizuj po zamknięciu chatu
  }

  function toggleChat() {
    if(document.body.classList.contains('chat-open')) {
      closeChat();
    } else {
      openChat();
    }
  }

  // ===== ROOT ELEMENTS =====
  function getRoot(){
    const roots = $$("#chatekai_root");
    return roots.length ? roots[roots.length - 1] : null;
  }

  function getSidebar(){
    const root = getRoot();
    return root ? $("#sidebar", root) : null;
  }

  function getEls(){
    const root    = getRoot();
    const sidebar = getSidebar();
    if(!root || !sidebar) return null;

    return {
      root,
      sidebar,
      nav: $(".nav", sidebar),

      // header
      collapseBtn: $("#collapseBtn", sidebar),
      mark: $(".mark", sidebar),
      markImg: $(".mark img", sidebar),

      // user
      userBtn: $("#userBtn", sidebar),
      userDropdown: $("#userDropdown", sidebar),
      avatarBox: $("#avatarBox", sidebar),
      userName: $("#userName", sidebar),
      userSub: $("#userSub", sidebar),
      logoutBtn: $("#logoutBtn", sidebar),
      goProfileBtn: $("#goProfileBtn", sidebar),

      // plan
      planCard: $("#sidebar-plan-card", sidebar),
      planName: $("#sidebar-plan-name", sidebar),
      planPill: $("#sidebar-plan-pill", sidebar),
      planPercent: $("#sidebar-plan-percent", sidebar),
      planCreditsMain: $("#sidebar-plan-credits-main", sidebar),
      planCreditsSub: $("#sidebar-plan-credits-sub", sidebar),
      liquidCanvas: $("#planLiquidCanvas", sidebar),
    };
  }

  // ===== SIDEBAR STATE =====
  function getHost(root){
    return root.closest(".bubble-element") || root.parentElement;
  }

  function syncHostWidth(root, sidebar){
    const host = getHost(root);
    if(!host) return;
    const collapsed = sidebar.classList.contains("collapsed");
    const w = collapsed ? "76px" : "272px";
    host.style.width    = w;
    host.style.minWidth = w;
    host.style.maxWidth = w;
    document.documentElement.style.setProperty("--sidebarW", w);
  }

  function restoreSidebarState(sidebar){
    try{
      const v = localStorage.getItem(LS_KEY);
      if(v === "1") sidebar.classList.add("collapsed");
    }catch(e){}
  }

  function saveSidebarState(sidebar){
    try{
      localStorage.setItem(LS_KEY, sidebar.classList.contains("collapsed") ? "1" : "0");
    }catch(e){}
  }

  // ===== USER MANAGEMENT =====
  function initials(name){
    const parts = (name || "").trim().split(/\s+/).filter(Boolean);
    if(!parts.length) return "U";
    const a = parts[0][0] || "U";
    const b = parts.length > 1 ? (parts[parts.length-1][0] || "") : "";
    return (a + b).toUpperCase();
  }

  function normalizeProvider(p){
    return String(p||"").trim().toLowerCase() === "google" ? "google" : "email";
  }

  function getUserFromHolders(){
    const provider  = ($("#b_provider")?.textContent || "").trim();
    const name      = ($("#b_name")?.textContent || "").trim();
    const email     = ($("#b_email")?.textContent || "").trim();
    const avatarUrl = ($("#b_avatar")?.textContent || "").trim();
    return {provider,name,email,avatarUrl};
  }

  function renderAvatar(avatarBox,{avatarUrl,name,provider}){
    if(!avatarBox) return;
    avatarBox.innerHTML = "";
    if(avatarUrl){
      const img = document.createElement("img");
      img.src = avatarUrl;
      img.alt = name || "Użytkownik";
      img.referrerPolicy = "no-referrer";
      avatarBox.appendChild(img);
      return;
    }
    const badge = document.createElement("div");
    badge.style.width  = "100%";
    badge.style.height = "100%";
    badge.style.display = "grid";
    badge.style.placeItems = "center";
    badge.style.fontWeight = "800";
    badge.style.color = "#e5e7eb";
    badge.textContent = provider === "email" ? "C" : initials(name);
    avatarBox.appendChild(badge);
  }

  function loadUser(els){
    const raw       = getUserFromHolders();
    const provider  = normalizeProvider(raw.provider);
    const email     = (raw.email || "").trim();
    const name      = (raw.name || "").trim() || (email ? email.split("@")[0] : "Użytkownik");
    const avatarUrl = (raw.avatarUrl || "").trim();

    if(els.userName) els.userName.textContent = name;
    if(els.userSub){
      els.userSub.textContent = provider === "google"
        ? "Konto Google"
        : email ? `Email • ${email}` : "Email";
    }
    renderAvatar(els.avatarBox, {avatarUrl,name,provider});
  }

  function getUserId(){
    const root = getRoot();
    const id = (root?.dataset.userId || "").trim();
    console.log("[Sidebar] userId =", id);
    return id || null;
  }

 // ===== PLAN LIQUID ENGINE + PLAN DATA (FIXED) =====
function clamp(n,a,b){ return Math.max(a, Math.min(b, n)); }

function createLiquidEngine(canvas){
  const ctx = canvas.getContext("2d", { alpha: true });
  const state = {
    canvas, ctx,
    dpr: Math.max(1, Math.min(2, window.devicePixelRatio || 1)),
    w: 0, h: 0,
    t: 0,
    fillNow: 1,
    fillTarget: 1,
    running: false,
  };

  function resizeToCSS(){
    const r = canvas.getBoundingClientRect();
    if(!r || r.width < 20 || r.height < 20) return false;

    const cssW = Math.max(1, Math.round(r.width));
    const cssH = Math.max(1, Math.round(r.height));
    const W = Math.round(cssW * state.dpr);
    const H = Math.round(cssH * state.dpr);

    if(canvas.width !== W || canvas.height !== H){
      canvas.width = W;
      canvas.height = H;
    }
    state.w = W; state.h = H;
    return true;
  }

  function setFill01(v01){
    state.fillTarget = clamp(v01, 0, 1);
  }

 function draw(){
  const ok = resizeToCSS();
  if(!ok){
    if(state.running) requestAnimationFrame(draw);
    return;
  }

  const {ctx,w,h} = state;
  ctx.clearRect(0,0,w,h);

  const cx = w/2, cy = h/2;
  const R  = Math.min(w,h) * 0.48;

  // ===== CIRCLE CLIP =====
  ctx.save();
  ctx.beginPath();
  ctx.arc(cx, cy, R, 0, Math.PI*2);
  ctx.clip();

  // ===== BASE "BLACK PEARL" BACKGROUND =====
  const base = ctx.createRadialGradient(cx-R*0.3, cy-R*0.4, R*0.2, cx, cy, R);
  base.addColorStop(0,"rgba(255,255,255,0.10)");
  base.addColorStop(0.35,"rgba(30,30,40,0.95)");
  base.addColorStop(1,"rgba(5,6,8,1)");
  ctx.fillStyle = base;
  ctx.fillRect(0,0,w,h);

  // ===== FILL VALUE =====
  state.fillNow += (state.fillTarget - state.fillNow) * 0.08;
  const level = (1 - state.fillNow) * h; // 0% -> prawie dno, 100% -> góra

  // ===== WAVE (ANIMATED) =====
  // t rośnie płynnie w rAF
  state.t += 0.016;

  const amp   = Math.max(2.5, R * 0.045);
  const freq  = 2.15;
  const speed = 0.90;
  const phase = state.t * speed;

  const left  = -w*0.10;
  const right =  w*1.10;
  const topY  = level;

  // ===== LIQUID MASK (BOTTOM AREA UNDER WAVE) =====
  ctx.save();
  ctx.beginPath();
  ctx.moveTo(left, h);
  ctx.lineTo(left, topY);

  const steps = 70;
  for(let i=0;i<=steps;i++){
    const x = left + (right-left) * (i/steps);
    const n =
      Math.sin((x/w)*Math.PI*2*freq + phase) * amp +
      Math.sin((x/w)*Math.PI*2*(freq*0.55) - phase*1.25) * (amp*0.45);
    ctx.lineTo(x, topY + n);
  }

  ctx.lineTo(right, h);
  ctx.closePath();
  ctx.clip();

  // ===== LIQUID "BLACK PEARL" WITH BRAND GLITTER =====
  // ciemna perła jako baza cieczy
  const liquidBase = ctx.createLinearGradient(0, topY, 0, h);
  liquidBase.addColorStop(0, "rgba(18,18,26,0.92)");
  liquidBase.addColorStop(1, "rgba(5,6,8,1)");
  ctx.fillStyle = liquidBase;
  ctx.fillRect(0, topY - 120, w, h - (topY - 120));

  // subtelny brand glow w cieczy (burg->vio->blue)
  ctx.globalCompositeOperation = "screen";
  ctx.globalAlpha = 0.35;
  const g = ctx.createLinearGradient(0, topY - R*0.25, w, h);
  g.addColorStop(0.00, "rgba(251,113,133,0.35)");
  g.addColorStop(0.55, "rgba(168,85,247,0.35)");
  g.addColorStop(1.00, "rgba(96,165,250,0.35)");
  ctx.fillStyle = g;
  ctx.fillRect(0, topY - 160, w, h);
  ctx.globalAlpha = 1;
  ctx.globalCompositeOperation = "source-over";

  // brokat w cieczy (drobny, premium)
  ctx.globalAlpha = 0.22;
  for(let i=0;i<18;i++){
    const a = (i/18)*Math.PI*2 + state.t*1.3;
    const rr = R*0.18 + (i%6)*R*0.05;
    const x = cx + Math.sin(a+i)*rr;
    const y = clamp(topY + (h-topY)*(0.25 + (i/18)*0.7) + Math.cos(a*1.4+i)*R*0.06, topY+6, h-6);
    const rad = R*(0.010 + (i%3)*0.004);

    const dot = ctx.createRadialGradient(x,y,0,x,y,rad*4);
    dot.addColorStop(0, i%3===0 ? "rgba(251,113,133,0.9)" : i%3===1 ? "rgba(168,85,247,0.9)" : "rgba(96,165,250,0.9)");
    dot.addColorStop(1, "rgba(0,0,0,0)");
    ctx.fillStyle = dot;
    ctx.beginPath();
    ctx.arc(x,y,rad*4,0,Math.PI*2);
    ctx.fill();
  }
  ctx.globalAlpha = 1;

  // depth shade
  const g2 = ctx.createLinearGradient(0, topY, 0, h);
  g2.addColorStop(0, "rgba(0,0,0,0.00)");
  g2.addColorStop(1, "rgba(0,0,0,0.30)");
  ctx.fillStyle = g2;
  ctx.fillRect(0, topY, w, h-topY);

  ctx.restore(); // end liquid mask

  // ===== MENISCUS (WAVE LINE HIGHLIGHT) =====
  ctx.save();
  ctx.globalCompositeOperation = "screen";
  ctx.globalAlpha = 0.22;
  ctx.strokeStyle = "rgba(255,255,255,0.9)";
  ctx.lineWidth = Math.max(1.2, R*0.02);
  ctx.beginPath();

  for(let i=0;i<=steps;i++){
    const x = left + (right-left) * (i/steps);
    const n =
      Math.sin((x/w)*Math.PI*2*freq + phase) * amp +
      Math.sin((x/w)*Math.PI*2*(freq*0.55) - phase*1.25) * (amp*0.45);
    if(i===0) ctx.moveTo(x, topY + n);
    else ctx.lineTo(x, topY + n);
  }

  ctx.stroke();
  ctx.restore();

  // ===== GLASS HIGHLIGHT OVER EVERYTHING =====
  ctx.save();
  const glass = ctx.createRadialGradient(cx-R*0.2, cy-R*0.35, R*0.1, cx, cy, R);
  glass.addColorStop(0,"rgba(255,255,255,0.32)");
  glass.addColorStop(0.45,"rgba(255,255,255,0.08)");
  glass.addColorStop(1,"rgba(255,255,255,0)");
  ctx.globalCompositeOperation = "screen";
  ctx.fillStyle = glass;
  ctx.fillRect(0,0,w,h);
  ctx.restore();

  ctx.restore(); // circle clip

  if(state.running) requestAnimationFrame(draw);
}

  function start(){
    if(state.running) return;
    state.running = true;
    requestAnimationFrame(draw);
  }

  function stop(){ state.running = false; }

  return { setFill01, start, stop };
}

let __liquid = null;

function setPlanLiquid(els, pct){
  const p = clamp(Number(pct||0), 0, 100);
  if(!els.liquidCanvas) return;

  if(!__liquid){
    __liquid = createLiquidEngine(els.liquidCanvas);
    __liquid.start();
    __liquid.setFill01(1);
  }
  __liquid.setFill01(p/100);
}

// ===== PLAN DATA =====
function applyPlanVisualSimple(els, row){
  const plan  = String(row.plan_id || "").toLowerCase();
  const used  = Number(row.messages_used ?? 0);
  const limit = row.messages_limit != null ? Number(row.messages_limit) : null;

  let name = "Plan";
  let badge = "PLAN";
  let pct = 100;
  let creditsText = "";
  let centerText = "—"; // tekst w środku

  if(plan === "starter" || plan === "free"){
  name = "Free";
  badge = "PLAN FREE";
  creditsText = "Plan darmowy (brak limitu)";
  
  pct = 0;                 // <-- ciecz na dole
  centerText = "0%";       // <-- środek orba

  if(els.planCreditsSub) 
    els.planCreditsSub.textContent = "Plan darmowy.";
}
else {
    if(plan === "standard") name = "Standard";
    else if(plan === "business") name = "Business";
    else if(plan === "pro") name = "Pro";
    else name = plan || "Plan";

    badge = `PLAN ${name.toUpperCase()}`;

    if(limit && limit > 0){
      const left = Math.max(limit - used, 0);
      pct = Math.round((left / limit) * 100);
      creditsText = `${left} / ${limit} kredytów`;
      centerText = String(left);
      if(els.planCreditsSub) els.planCreditsSub.textContent = "Pozostało w tym miesiącu.";
    } else {
      pct = 100;
      creditsText = "Brak limitu kredytów";
      centerText = "∞";
      if(els.planCreditsSub) els.planCreditsSub.textContent = "Plan nie posiada limitu wiadomości.";
    }
  }

  if(els.planName) els.planName.textContent = name;
  if(els.planPill) els.planPill.textContent = badge;
  if(els.planCreditsMain) els.planCreditsMain.textContent = creditsText;

  // TEKST w środku (nie nadpisujemy go już w setPlanLiquid)
  if(els.planPercent) els.planPercent.textContent = centerText;

  // fill
  setPlanLiquid(els, pct);
}

async function loadPlanForSidebar(els){
  const userId = getUserId();
  if(!userId){
    if(els.planCreditsMain) els.planCreditsMain.textContent = "Brak user_id";
    if(els.planCreditsSub)  els.planCreditsSub.textContent  = "Ustaw data-user-id na #chatekai_root w Bubble.";
    setPlanLiquid(els, 0);
    return;
  }

  try{
    const { data:user, error:uErr } = await supabase
      .from("users")
      .select("plan_id, messages_used, email")
      .eq("id", userId)
      .maybeSingle();

    if(uErr) console.warn("users load err", uErr);

    if(!user){
      applyPlanVisualSimple(els, { plan_id: "starter", messages_used: 0, messages_limit: null });
      return;
    }

    const planId = user.plan_id || "starter";

    const { data:plan, error:pErr } = await supabase
      .from("plans")
      .select("id, messages_limit")
      .eq("id", planId)
      .maybeSingle();

    if(pErr) console.warn("plans load err", pErr);

    applyPlanVisualSimple(els, {
      plan_id: planId,
      messages_used: Number(user.messages_used || 0),
      messages_limit: plan?.messages_limit ?? null
    });

  }catch(e){
    console.error("loadPlanForSidebar exception", e);
    if(els.planCreditsMain) els.planCreditsMain.textContent = "Błąd ładowania planu";
    if(els.planCreditsSub)  els.planCreditsSub.textContent  = "Sprawdź konsolę przeglądarki.";
    setPlanLiquid(els, 0);
  }
}

  // ===== DROPDOWN =====
  function portalDropdownToBody(dd){
    if(!dd || dd.__portaled) return;
    document.body.appendChild(dd);
    dd.__portaled = true;
  }

  function positionDropdown(sidebar,userBtn,dd){
    if(!sidebar || !userBtn || !dd) return;
    const r = userBtn.getBoundingClientRect();
    const collapsed = sidebar.classList.contains("collapsed");
    dd.style.position = "fixed";
    dd.style.right = "auto";
    dd.style.left  = collapsed ? `${r.right+10}px` : `${r.left}px`;
    dd.style.bottom = `${window.innerHeight - r.top + 10}px`;
    const expandedW = Math.max(220, Math.min(320, r.width));
    dd.style.width = collapsed ? "260px" : `${expandedW}px`;
  }

  function closeDropdown(dd){ dd?.classList.remove("open"); }

  function toggleDropdown(els){
    portalDropdownToBody(els.userDropdown);
    positionDropdown(els.sidebar, els.userBtn, els.userDropdown);
    els.userDropdown.classList.toggle("open");
  }

  // ===== ACTIVE NAVIGATION =====
  function setActive(nav,item){
    nav.querySelectorAll(".nav-item").forEach(x => x.classList.remove("active"));
    item.classList.add("active");
  }

  function detectRouteFromPageId(){
    for(const r of ROUTES){
      if(document.getElementById(r)) return r;
    }
    return "";
  }

  function applyActiveFromPageId(){
    const els = getEls();
    if(!els || !els.sidebar || !els.nav) return false;
    const route = detectRouteFromPageId();
    if(!route) return false;
    const item = els.sidebar.querySelector(`.nav-item[data-route="${route}"]`);
    if(!item) return false;
    if(!item.classList.contains("active")){
      setActive(els.nav, item);
    }
    return true;
  }

  function scheduleApplyActiveRetries(){
    let tries = 0;
    const t = setInterval(() => {
      tries++;
      const ok = applyActiveFromPageId();
      if(ok || tries >= 18) clearInterval(t);
    }, 160);
  }

  // ===== INITIALIZATION =====
  function initLogoSwap(els){
    if(!els?.mark || !els?.markImg) return;

    if(els.mark.__dvLogoWired) return;
    els.mark.__dvLogoWired = true;

    els.mark.addEventListener("mouseenter", () => {
      if(els.sidebar.classList.contains("collapsed")){
        els.sidebar.classList.add("logo-hover");
      }
    });
    els.mark.addEventListener("mouseleave", () => {
      els.sidebar.classList.remove("logo-hover");
    });
  }

  function initOnce(){
    const els = getEls();
    if(!els) return false;

    if(els.root.__dv_inited) return true;
    els.root.__dv_inited = true;

    portalDropdownToBody(els.userDropdown);
    restoreSidebarState(els.sidebar);
    syncHostWidth(els.root, els.sidebar);

    loadUser(els);
    loadPlanForSidebar(els);

    initTheme();
    initLogoSwap(els);
    applyActiveFromPageId();
    scheduleApplyActiveRetries();

    closeDropdown(els.userDropdown);

    // Keyboard support for nav items
    els.sidebar.querySelectorAll(".nav-item").forEach(item => {
      if(item.__wiredKey) return;
      item.__wiredKey = true;
      item.addEventListener("keydown", e => {
        if(e.key === "Enter" || e.key === " "){
          e.preventDefault();
          item.click();
        }
      });
    });

    return true;
  }

  // ===== SYNC Z PRAWYM BLOKIEM =====
  function syncSidebarState() {
    const els = getEls();
    if (!els) return;
    
const collapsed = els.sidebar.classList.contains("collapsed");
    const hidden = els.sidebar.classList.contains("hidden");
    const width = collapsed ? 72 : 260;
    
    // 1. Zapis do localStorage (komunikacja z prawym blokiem)
    localStorage.setItem('sidebar-collapsed', collapsed ? '1' : '0');
    localStorage.setItem('sidebar-hidden', hidden ? '1' : '0');
    localStorage.setItem('sidebar-width', width.toString());
    
    // 2. Wysyłanie custom event
    window.dispatchEvent(new CustomEvent('sidebar-state-change', {
      detail: { collapsed, hidden, width }
    }));
    
    // 3. Komunikacja przez postMessage (jeśli w iframe)
    if (window.parent !== window) {
      try {
        window.parent.postMessage({
          type: 'SIDEBAR_STATE',
          collapsed,
          hidden,
          width
        }, '*');
      } catch(e) {
        console.log('PostMessage error:', e);
      }
    }
    
    // 4. CSS Custom Property dla łatwego dostępu
    document.documentElement.style.setProperty('--sidebar-width', width + 'px');
    
    console.log('[Sidebar] State synced:', { collapsed, hidden, width });
  }
  
  function toggleSidebar() {
    const els = getEls();
    if(!els) return;
    
    els.sidebar.classList.toggle("collapsed");
    saveSidebarState(els.sidebar);
    syncHostWidth(els.root, els.sidebar);
    applyActiveFromPageId();
    
    // SYNCHRONIZACJA Z PRAWYM BLOKIEM
    syncSidebarState();
    
    return els.sidebar.classList.contains("collapsed");
  }
  
  function initCrossComponentSync() {
    // Nasłuchuj na żądania od prawego bloku
    window.addEventListener('storage', (e) => {
      if (e.key === 'sidebar-toggle-request') {
        const els = getEls();
        if (els) {
          toggleSidebar();
        }
      }
    });
    
    // Nasłuchuj na postMessage
    window.addEventListener('message', (e) => {
      if (e.data && e.data.type === 'TOGGLE_SIDEBAR') {
        toggleSidebar();
      }
      if (e.data && e.data.type === 'GET_SIDEBAR_STATE') {
        const els = getEls();
        if (els && window.parent !== window) {
          window.parent.postMessage({
            type: 'SIDEBAR_STATE_RESPONSE',
            collapsed: els.sidebar.classList.contains("collapsed"),
            hidden: els.sidebar.classList.contains("hidden")
          }, '*');
        }
      }
    });
    
    // Inicjalizuj stan przy starcie
    setTimeout(() => {
      syncSidebarState();
    }, 100);
  }
  
  // ===== GLOBAL EVENT HANDLERS =====
  function wireGlobalsOnce(){
    if(window.__DV_SIDEBAR_GLOBALS_WIRED) return;
    window.__DV_SIDEBAR_GLOBALS_WIRED = true;

    document.addEventListener("click", e => {
      const els = getEls();
      if(!els) return;

      // Collapse button
      const collapseBtn = e.target.closest("#collapseBtn");
      if(collapseBtn){
        e.preventDefault();
        e.stopPropagation();
        closeDropdown(els.userDropdown);
        toggleSidebar(); // ZMIENIONE: używamy nowej funkcji
        return;
      }

      // Logo click when collapsed
      const mark = e.target.closest(".mark");
      if(mark && els.sidebar.contains(mark) && els.sidebar.classList.contains("collapsed")){
        e.preventDefault();
        e.stopPropagation();
        closeDropdown(els.userDropdown);
        els.sidebar.classList.remove("logo-hover");
        toggleSidebar(); // ZMIENIONE: używamy nowej funkcji
        return;
      }

      // User menu
      const userBtn = e.target.closest("#userBtn");
      if(userBtn){
        e.preventDefault();
        e.stopPropagation();
        toggleDropdown(els);
        return;
      }

      // Dropdown actions
      if(els.userDropdown && els.userDropdown.contains(e.target)){
        e.stopPropagation();
        const logout  = e.target.closest("#logoutBtn");
        const profile = e.target.closest("#goProfileBtn");
        if(logout){
          closeDropdown(els.userDropdown);
          window.bubble_fn_logout();
        }
        if(profile){
          closeDropdown(els.userDropdown);
          window.bubble_fn_profile();
        }
        return;
      }

      // Navigation
      const navItem = e.target.closest(".nav-item");
      if(navItem && els.sidebar.contains(navItem)){
        setActive(els.nav, navItem);
        const route = navItem.getAttribute("data-route") || "";
        window.bubble_fn_nav(route);
        return;
      }

      closeDropdown(els.userDropdown);
    }, true);

    // Close dropdown on Escape
    document.addEventListener("keydown", e => {
      if(e.key !== "Escape") return;
      const els = getEls();
      if(!els) return;
      closeDropdown(els.userDropdown);
    });

    // Resize handler
    window.addEventListener("resize", () => {
      const els = getEls();
      if(!els) return;
      syncHostWidth(els.root, els.sidebar);
      applyActiveFromPageId();
      if(els.userDropdown?.classList.contains("open")){
        positionDropdown(els.sidebar, els.userBtn, els.userDropdown);
      }
    });

    // Reposition dropdown on scroll
    window.addEventListener("scroll", () => {
      const els = getEls();
      if(!els) return;
      if(els.userDropdown?.classList.contains("open")){
        positionDropdown(els.sidebar, els.userBtn, els.userDropdown);
      }
    }, true);
  }

  // ===== BOOTSTRAP =====
  wireGlobalsOnce();
  
  // DODAJ: inicjalizuj komunikację między komponentami
  initCrossComponentSync();

  (function boot(){
    if(initOnce()) return;
    setTimeout(boot, 150);
  })();
</script>

<!-- Liquid SVG Filter -->
<svg width="0" height="0" style="position:absolute; left:-9999px; top:-9999px;">
  <filter id="dvLiquid">
    <feTurbulence type="fractalNoise"
                  baseFrequency="0.010"
                  numOctaves="2"
                  seed="8"
                  result="noise">
      <animate attributeName="baseFrequency"
               dur="8s"
               values="0.009;0.014;0.009"
               repeatCount="indefinite"/>
    </feTurbulence>
    <feDisplacementMap in="SourceGraphic"
                       in2="noise"
                       scale="18"
                       xChannelSelector="R"
                       yChannelSelector="G"/>
  </filter>
</svg>

</body>
</html>
