<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" type="image/svg+xml" href="/assets/icons/logo.svg" />
<title data-i18n="auth.page.title"></title>

<style>

* { box-sizing: border-box; }

body {
  margin:0;
  background:#ffffff;
  font-family: Inter, system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
  color:#111827;
}

/* layer */
.auth-layer {
  position: fixed;
  inset: 0;
  background: #ffffff;
  z-index: 9999;
  overflow-y: auto;
}

/* logo */
.auth-logo {
  text-align: center;
  margin-top: 64px;
  margin-bottom: 48px;
}

.auth-logo-img {
  height: 64px;
}

/* center */
.auth-center {
  display:flex;
  justify-content:center;
  padding-bottom:64px;
}

.auth-box {
  width:380px;
  position:relative;
}

/* views */
.auth-view {
  position:absolute;
  inset:0;
  opacity:0;
  transform:translateY(16px);
  transition:.35s;
  pointer-events:none;
}

.auth-view.active {
  opacity:1;
  transform:none;
  pointer-events:all;
}

/* title */
.auth-title {
  text-align:center;
  font-size:22px;
  margin-bottom:26px;
}

/* input */
.input {
  width:100%;
  height:44px;
  border-radius:10px;
  border:1px solid #e5e7eb;
  padding:0 14px;
  margin-bottom:14px;
}

/* buttons */
.btn {
  width:100%;
  height:44px;
  border-radius:10px;
  border:1px solid #e5e7eb;
  background:#fff;
  cursor:pointer;
  margin-bottom:12px;
}

.btn.primary {
  background:#111827;
  color:#fff;
  border:none;
}

.btn.social {
  display:flex;
  align-items:center;
  justify-content:center;
  gap:10px;
}

.btn.social img {
  width:18px;
}

/* divider */
.divider {
  text-align:center;
  font-size:12px;
  color:#9ca3af;
  margin:20px 0;
}

/* checkbox */
.checkbox {
  display:flex;
  gap:8px;
  font-size:12px;
  margin-bottom:18px;
}

/* footer */
.footer {
  text-align:center;
  font-size:13px;
}

.link {
  font-weight:600;
  cursor:pointer;
}

.auth-legal-note {
  margin: 6px 0 0;
  text-align: center;
  font-size: 12px;
  line-height: 1.5;
  color: #6b7280;
}

.auth-legal-note a {
  color: #111827;
  font-weight: 600;
  text-decoration: underline;
  text-underline-offset: 2px;
}

</style>
</head>


<body>

<div class="auth-layer">

<div class="auth-logo">
<img class="auth-logo-img"
src="/assets/logo.png">
</div>

<div class="auth-center">
<div class="auth-box">


<!-- LOGIN -->

<div class="auth-view active" id="login-view">

<div class="auth-title" data-i18n="auth.login.title"></div>

<button class="btn social" onclick="loginGoogle()">
<img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg">
<span data-i18n="auth.login.google"></span>
</button>
<p class="auth-legal-note">
By continuing, you agree to the
<a href="/terms/" data-legal-path="/terms/">Terms of Service</a>
and
<a href="/privacy/" data-legal-path="/privacy/">Privacy Policy</a>.
</p>

<div class="divider" data-i18n="auth.divider.or"></div>

<input class="input" id="login-email" data-i18n-placeholder="auth.fields.email" placeholder="">
<input class="input" id="login-pass" type="password" data-i18n-placeholder="auth.fields.password" placeholder="">

<button class="btn primary" onclick="loginEmail()">
<span data-i18n="auth.login.submit"></span>
</button>

<div class="footer">
<span data-i18n="auth.login.noAccount"></span>
<span class="link" onclick="switchView('signup-view')" data-i18n="auth.login.createAccount"></span>
</div>

</div>


<!-- SIGNUP -->

<div class="auth-view" id="signup-view">

<div class="auth-title" data-i18n="auth.signup.title"></div>

<button class="btn social" onclick="loginGoogle()">
<img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg">
<span data-i18n="auth.signup.google"></span>
</button>
<p class="auth-legal-note">
By continuing, you agree to the
<a href="/terms/" data-legal-path="/terms/">Terms of Service</a>
and
<a href="/privacy/" data-legal-path="/privacy/">Privacy Policy</a>.
</p>

<div class="divider" data-i18n="auth.divider.or"></div>

<input class="input" id="signup-email" data-i18n-placeholder="auth.fields.email" placeholder="">
<input class="input" id="signup-pass" type="password" data-i18n-placeholder="auth.fields.password" placeholder="">

<div class="checkbox">
<input id="signup-legal" type="checkbox">
<span data-i18n="auth.signup.acceptTerms"></span>
</div>

<button class="btn primary" onclick="signupEmail()">
<span data-i18n="auth.signup.submit"></span>
</button>

<div class="footer">
<span data-i18n="auth.signup.haveAccount"></span>
<span class="link" onclick="switchView('login-view')" data-i18n="auth.signup.goToLogin"></span>
</div>

</div>

</div>
</div>
</div>

<div id="auth-i18n" style="display:none">
  <span id="i18n-auth-missing-credentials" data-i18n="auth.errors.missingCredentials"></span>
  <span id="i18n-auth-login-error" data-i18n="auth.errors.loginFailed"></span>
  <span id="i18n-auth-accept-terms" data-i18n="auth.errors.acceptTerms"></span>
  <span id="i18n-auth-signup-error" data-i18n="auth.errors.signupFailed"></span>
</div>

<script type="module">
import { supabase } from "../js/supabaseClient.js";
import { getDashboardUrl } from "../js/auth-store.js";

const i18nText = (id) => document.getElementById(id)?.textContent || "";
const LOGIN_REDIRECT_KEY = "daveri_login_redirect";
const SUPABASE_GOOGLE_CALLBACK_URL = "https://inayqymryrriobowyysw.supabase.co/auth/v1/callback";

const readRedirectTarget = () => {
  try {
    const raw = localStorage.getItem(LOGIN_REDIRECT_KEY);
    if (typeof raw === "string" && raw.trim()) {
      localStorage.removeItem(LOGIN_REDIRECT_KEY);
      return raw.trim();
    }
  } catch {}
  return getDashboardUrl();
};

const rememberLoginRedirect = (target = getDashboardUrl()) => {
  try {
    localStorage.setItem(LOGIN_REDIRECT_KEY, target);
  } catch {}
};

const switchView = (id) => {
  document.querySelectorAll(".auth-view").forEach((view) => view.classList.remove("active"));
  document.getElementById(id)?.classList.add("active");
};

const loginGoogle = async (target = getDashboardUrl()) => {
  rememberLoginRedirect(target);
  const redirectTo = new URL(readRedirectTarget(), window.location.origin).toString();
  console.log("[AUTH GOOGLE]", {
    redirectTo,
    callbackPrefix: SUPABASE_GOOGLE_CALLBACK_URL.slice(0, 40),
  });
  const { error } = await supabase.auth.signInWithOAuth({
    provider: "google",
    options: { redirectTo },
  });
  if (error) {
    alert(error.message || i18nText("i18n-auth-login-error"));
  }
};

const loginEmail = async () => {
  const email = document.getElementById("login-email")?.value?.trim() || "";
  const password = document.getElementById("login-pass")?.value || "";

  if (!email || !password) {
    alert(i18nText("i18n-auth-missing-credentials"));
    return;
  }

  const { error } = await supabase.auth.signInWithPassword({
    email,
    password,
  });

  if (error) {
    alert(error.message || i18nText("i18n-auth-login-error"));
    return;
  }

  window.location.href = readRedirectTarget();
};

const signupEmail = async () => {
  const email = document.getElementById("signup-email")?.value?.trim() || "";
  const password = document.getElementById("signup-pass")?.value || "";
  const legal = document.getElementById("signup-legal")?.checked === true;

  if (!legal) {
    alert(i18nText("i18n-auth-accept-terms"));
    return;
  }

  if (!email || !password) {
    alert(i18nText("i18n-auth-missing-credentials"));
    return;
  }

  const { data, error } = await supabase.auth.signUp({
    email,
    password,
  });

  if (error) {
    alert(error.message || i18nText("i18n-auth-signup-error"));
    return;
  }

  if (data?.session) {
    window.location.href = readRedirectTarget();
    return;
  }

  alert("Account created. Verify your email, then sign in.");
  switchView("login-view");
};

const checkAuth = async () => {
  const { data } = await supabase.auth.getSession();
  if (data?.session?.user) {
    window.location.href = readRedirectTarget();
    return true;
  }
  return false;
};

const maybeAutoStartGoogle = () => {
  const params = new URLSearchParams(window.location.search);
  const autoGoogle = params.get("oauth") === "google" || params.get("provider") === "google";
  if (!autoGoogle) return;

  const next = params.get("next");
  const target = typeof next === "string" && next.trim() ? next.trim() : getDashboardUrl();

  const cleanedUrl = new URL(window.location.href);
  cleanedUrl.searchParams.delete("oauth");
  cleanedUrl.searchParams.delete("provider");
  cleanedUrl.searchParams.delete("next");
  window.history.replaceState({}, "", `${cleanedUrl.pathname}${cleanedUrl.search}${cleanedUrl.hash}`);

  void loginGoogle(target);
};

window.switchView = switchView;
window.loginGoogle = loginGoogle;
window.loginEmail = loginEmail;
window.signupEmail = signupEmail;

void (async () => {
  const alreadyLoggedIn = await checkAuth();
  if (!alreadyLoggedIn) {
    maybeAutoStartGoogle();
  }
})();
</script>

  <script type="module" src="../js/i18n.js"></script>
</body>
</html>


