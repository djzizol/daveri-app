<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title data-i18n="dashboard.page.title"></title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/css/main.css">
  
  <style>
:root {
  --bg-primary: #0e0e10;
  --bg-secondary: #151517;
  --bg-tertiary: #1c1c1f;
  --surface-default: rgba(255,255,255,0.02);
  --surface-hover: rgba(255,255,255,0.04);
  --surface-active: rgba(255,255,255,0.06);
  --text-primary: rgba(255,255,255,0.92);
  --text-secondary: rgba(255,255,255,0.55);
  --text-muted: rgba(255,255,255,0.35);
  --accent-primary: #7c3aed;
  --radius-small: 8px;
  --radius-medium: 12px;
  --radius-large: 16px;
  --space-2: 8px;
  --space-3: 12px;
  --space-4: 16px;
  --space-5: 24px;
  --space-6: 32px;
  --space-7: 48px;
  --dv-bg: var(--bg-primary);
  --dv-bg2: var(--bg-secondary);
  --dv-surface: var(--surface-default);
  --dv-surface2: var(--surface-hover);
  --dv-stroke: rgba(255,255,255,0.08);
  --dv-stroke2: rgba(255,255,255,0.16);
  --dv-text: var(--text-primary);
  --dv-text2: var(--text-secondary);
  --dv-muted: var(--text-secondary);
  --dv-muted2: var(--text-muted);
  --dv-burg: #c08a8a;
  --dv-grad: var(--surface-active);
  --dv-radius-xl: var(--radius-large);
  --dv-radius-lg: var(--radius-large);
  --dv-radius-md: var(--radius-medium);
  --dv-radius-sm: var(--radius-small);
  --dv-ease: ease;
  --page-max: 1400px;
  --page-pad: var(--space-6);
  --dv-sidebar-w: 0px;
}

[data-theme="light"] {
  --bg-primary: #f2f2f3;
  --bg-secondary: #e8e8ea;
  --bg-tertiary: #dddddf;
  --surface-default: rgba(10,10,12,0.03);
  --surface-hover: rgba(10,10,12,0.06);
  --surface-active: rgba(10,10,12,0.1);
  --text-primary: rgba(10,10,12,0.9);
  --text-secondary: rgba(10,10,12,0.62);
  --text-muted: rgba(10,10,12,0.42);
  --dv-stroke: rgba(0,0,0,0.08);
  --dv-stroke2: rgba(0,0,0,0.14);
}

* { box-sizing: border-box; margin: 0; padding: 0; }

body {
  font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
  -webkit-font-smoothing: antialiased;
  background: #0e0e10;
  color: var(--text-primary);
  min-height: 100vh;
  line-height: 1.5;
  letter-spacing: -0.01em;
}

#ambientParticles { display: none; }

#page-wrapper {
  display: flex;
  min-height: 100vh;
  width: 100%;
}

#sidebar-spacer {
  width: var(--dv-sidebar-w, 0px);
  flex-shrink: 0;
  transition: width 120ms ease;
}

#main-content {
  flex: 1;
  min-width: 0;
  max-width: 100%;
  overflow-x: hidden;
}

.page {
  max-width: var(--page-max);
  margin: 0 auto;
  padding: var(--page-pad);
  min-height: 100vh;
}

.dashboard-container {
  display: flex;
  flex-direction: column;
  gap: var(--space-7);
}

.dashboard-layout {
  display: grid;
  grid-template-columns: 1fr 340px;
  gap: var(--space-7);
  padding: var(--space-7);
  max-width: 1400px;
  margin: 0 auto;
}

.dashboard-main {
  display: flex;
  flex-direction: column;
  gap: var(--space-7);
  background: transparent;
}

.dashboard-rail {
  display: flex;
  flex-direction: column;
  gap: var(--space-5);
}

.dashboard-metrics {
  display: flex;
  flex-wrap: wrap;
  gap: var(--space-7);
}

.metric {
  display: flex;
  flex-direction: column;
  gap: var(--space-2);
}

.metric-label {
  font-size: 13px;
  color: rgba(255,255,255,0.45);
}

.metric-value {
  font-size: 28px;
  font-weight: 600;
  color: rgba(255,255,255,0.92);
  line-height: 1;
}

.dashboard-section {
  display: flex;
  flex-direction: column;
  gap: var(--space-4);
}

.section-head {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: var(--space-4);
}

.section-title {
  font-size: 18px;
  font-weight: 600;
  color: var(--text-primary);
}

.section-subtitle {
  font-size: 13px;
  color: var(--text-secondary);
}

.card-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: var(--space-4);
  padding: var(--space-3) 0;
  cursor: pointer;
  user-select: none;
  transition: all 120ms ease;
}

.card-header:hover { background: var(--surface-default); }

.card-header-left {
  display: flex;
  align-items: center;
  gap: var(--space-3);
}

.card-icon {
  width: 24px;
  height: 24px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: var(--text-secondary);
}

.card-icon svg { width: 18px; height: 18px; stroke-width: 1.8; }

.card-title {
  font-size: 18px;
  font-weight: 600;
  color: var(--text-primary);
}

.card-subtitle {
  font-size: 13px;
  color: var(--text-secondary);
}

.card-arrow {
  color: var(--text-muted);
  transition: all 120ms ease;
}

.card-arrow svg { width: 16px; height: 16px; stroke-width: 2; }

.glass-card.active .card-arrow {
  transform: rotate(180deg);
  color: var(--text-secondary);
}

.card-body {
  max-height: 0;
  overflow: hidden;
  opacity: 0;
  transition: max-height 120ms ease, opacity 120ms ease;
}

.glass-card.active .card-body {
  max-height: 1600px;
  opacity: 1;
}

.progress-container { margin-bottom: var(--space-4); }

.progress-bar {
  height: var(--space-2);
  background: var(--surface-default);
  border-radius: 999px;
  overflow: hidden;
  margin-bottom: var(--space-2);
}

.progress-fill {
  height: 100%;
  width: 0;
  background: rgba(124, 58, 237, 0.75);
  border-radius: 999px;
  transition: width 120ms ease;
}

.progress-text {
  display: flex;
  justify-content: space-between;
  font-size: 13px;
  color: var(--text-muted);
}

.onboarding-flow {
  display: flex;
  flex-direction: column;
  gap: var(--space-3);
}

.onboarding-step,
.check-item {
  position: relative;
  display: flex;
  align-items: center;
  gap: var(--space-3);
  padding: var(--space-3) 0;
  border-radius: var(--radius-small);
  transition: all 120ms ease;
}

.onboarding-step:hover,
.check-item:hover { background: rgba(255,255,255,0.03); }

.onboarding-step.active,
.check-item.active { background: rgba(124, 58, 237, 0.08); }

.onboarding-step.active::before,
.check-item.active::before {
  content: "";
  width: 2px;
  height: 100%;
  background: var(--accent-primary);
  position: absolute;
  left: 0;
  top: 0;
}

.check-item.done { background: rgba(124, 58, 237, 0.08); }

.check-icon {
  width: 32px;
  height: 32px;
  border-radius: var(--radius-small);
  background: var(--surface-default);
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
  color: var(--text-secondary);
}

.check-icon svg { width: 16px; height: 16px; stroke-width: 1.8; }

.check-content { min-width: 0; }

.check-title {
  font-size: 14px;
  font-weight: 600;
  color: var(--text-primary);
}

.check-hint {
  font-size: 13px;
  color: var(--text-secondary);
}

.check-status {
  width: 16px;
  height: 16px;
  border-radius: 50%;
  background: var(--surface-default);
  display: flex;
  align-items: center;
  justify-content: center;
  margin-left: auto;
}

.check-status svg {
  width: 12px;
  height: 12px;
  stroke-width: 2.5;
  color: var(--accent-primary);
  opacity: 0;
}

.check-item.done .check-status svg { opacity: 1; }

.btn {
  padding: var(--space-3) var(--space-4);
  background: var(--surface-default);
  border: none;
  border-radius: var(--radius-small);
  color: var(--text-primary);
  font-size: 13px;
  font-weight: 600;
  font-family: inherit;
  cursor: pointer;
  transition: all 120ms ease;
  display: inline-flex;
  align-items: center;
  gap: var(--space-2);
}

.btn:hover { background: var(--surface-hover); }

.btn-primary { background: var(--surface-active); }

.files-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
  gap: var(--space-3);
}

.file-item {
  padding: var(--space-3);
  display: flex;
  flex-direction: column;
  align-items: center;
  text-align: center;
  cursor: pointer;
  border-radius: var(--radius-small);
  background: var(--surface-default);
  transition: all 120ms ease;
}

.file-item:hover { background: var(--surface-hover); }

.file-icon {
  width: 32px;
  height: 32px;
  margin-bottom: var(--space-2);
  display: flex;
  align-items: center;
  justify-content: center;
  color: var(--text-secondary);
}

.file-icon svg { width: 20px; height: 20px; stroke-width: 1.5; }

.file-name {
  font-size: 13px;
  font-weight: 600;
  color: var(--text-primary);
  margin-bottom: var(--space-2);
  max-width: 100%;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.file-date { font-size: 12px; color: var(--text-muted); }

.quick-actions {
  display: grid;
  grid-template-columns: repeat(2, minmax(0, 1fr));
  gap: var(--space-3);
}

.quick-action {
  display: flex;
  align-items: center;
  gap: var(--space-3);
  padding: var(--space-3);
  text-decoration: none;
  color: var(--text-primary);
  border-radius: var(--radius-small);
  background: var(--surface-default);
  transition: all 120ms ease;
}

.quick-action:hover { background: var(--surface-hover); }

.quick-action-icon {
  width: 24px;
  height: 24px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: var(--text-secondary);
}

.quick-action-icon svg { width: 18px; height: 18px; stroke-width: 1.8; }

.quick-action-text { font-size: 13px; font-weight: 600; color: var(--text-primary); }

.plans-tile {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: var(--space-4);
  padding: var(--space-4) 0;
  text-decoration: none;
  color: var(--text-primary);
  border-top: 1px solid var(--dv-stroke);
  border-bottom: 1px solid var(--dv-stroke);
  transition: all 120ms ease;
}

.plans-tile:hover { background: var(--surface-default); }

.plans-tile-content { display: flex; align-items: center; gap: var(--space-3); }

.plans-tile-icon {
  width: 24px;
  height: 24px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: var(--text-primary);
}

.plans-tile-icon svg { width: 18px; height: 18px; stroke-width: 1.8; }

.plans-tile-text h3 {
  font-size: 16px;
  font-weight: 600;
}

.plans-tile-text p { font-size: 13px; color: var(--text-secondary); }

.plans-tile-arrow {
  color: var(--text-muted);
  transition: all 120ms ease;
}

.plans-tile:hover .plans-tile-arrow { color: var(--text-primary); }

.plans-tile-arrow svg { width: 16px; height: 16px; stroke-width: 2; }

.activity-rail {
  display: flex;
  flex-direction: column;
  gap: var(--space-4);
}

.activity-item,
.conv-list,
.conv-detail {
  padding: var(--space-3);
  border-radius: 10px;
  background: rgba(255,255,255,0.02);
  transition: all 120ms ease;
}

.activity-item:hover,
.conv-list:hover,
.conv-detail:hover { background: rgba(255,255,255,0.04); }

.conv-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.bot-selector { display: flex; flex-direction: column; gap: var(--space-2); width: 100%; }

.bot-select {
  width: 100%;
  padding: var(--space-3);
  background: var(--surface-default);
  border: none;
  border-radius: var(--radius-small);
  color: var(--text-primary);
  font-size: 13px;
  font-family: inherit;
  outline: none;
  cursor: pointer;
  transition: all 120ms ease;
}

.bot-select:focus { background: var(--surface-hover); }

.bot-select option { background: #18181b; color: var(--text-primary); }

.conv-layout {
  display: flex;
  flex-direction: column;
  gap: var(--space-4);
}

.conv-list,
.conv-detail {
  overflow: hidden;
  display: flex;
  flex-direction: column;
}

.conv-list-header {
  padding-bottom: var(--space-3);
  font-size: 13px;
  color: var(--text-secondary);
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.conv-count {
  background: var(--surface-default);
  color: var(--text-primary);
  padding: 0 var(--space-2);
  border-radius: 999px;
  font-size: 11px;
  font-weight: 600;
}

.conv-items {
  max-height: 280px;
  overflow-y: auto;
}

.conv-item {
  width: 100%;
  padding: var(--space-3);
  background: transparent;
  border: none;
  border-radius: var(--radius-small);
  text-align: left;
  cursor: pointer;
  margin-bottom: var(--space-2);
  transition: all 120ms ease;
}

.conv-item:hover { background: var(--surface-default); }

.conv-item.active {
  background: rgba(124, 58, 237, 0.08);
  border-left: 2px solid var(--accent-primary);
}

.conv-visitor {
  font-size: 13px;
  font-weight: 600;
  color: var(--text-primary);
  margin-bottom: var(--space-2);
}

.conv-preview {
  font-size: 12px;
  color: var(--text-secondary);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  margin-bottom: var(--space-2);
}

.conv-date { font-size: 11px; color: var(--text-muted); }

.conv-meta {
  padding-bottom: var(--space-3);
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.conv-meta-title {
  font-size: 14px;
  font-weight: 600;
  color: var(--text-primary);
}

.conv-meta-visitor { font-size: 12px; color: var(--text-secondary); }

.messages-container {
  min-height: 220px;
  max-height: 360px;
  padding: var(--space-3);
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  gap: var(--space-3);
  background: var(--surface-default);
  border-radius: var(--radius-small);
}

.message {
  max-width: 100%;
  padding: var(--space-3);
  border-radius: var(--radius-medium);
  font-size: 13px;
  line-height: 1.45;
  background: rgba(255,255,255,0.03);
}

.message.user {
  align-self: flex-end;
  background: var(--surface-active);
}

.message.assistant { align-self: flex-start; }

.message-time {
  font-size: 11px;
  color: var(--text-muted);
  margin-top: var(--space-2);
  text-align: right;
}

.empty-state {
  padding: var(--space-6) var(--space-4);
  text-align: center;
  color: var(--text-secondary);
  font-size: 13px;
}

.empty-state-icon {
  width: var(--space-6);
  height: var(--space-6);
  margin: 0 auto var(--space-3);
  display: flex;
  align-items: center;
  justify-content: center;
  color: var(--text-muted);
}

.empty-state-icon svg { width: 24px; height: 24px; stroke-width: 1.5; }

.conv-items::-webkit-scrollbar,
.messages-container::-webkit-scrollbar { width: 6px; }

.conv-items::-webkit-scrollbar-thumb,
.messages-container::-webkit-scrollbar-thumb {
  background: rgba(255,255,255,0.12);
  border-radius: 999px;
}

.conv-items::-webkit-scrollbar-track,
.messages-container::-webkit-scrollbar-track { background: transparent; }

#auth-screen {
  position: fixed;
  inset: 0;
  background: var(--bg-primary);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
  flex-direction: column;
  gap: var(--space-5);
}

.auth-container {
  text-align: center;
  padding: var(--space-6);
  max-width: 420px;
  width: 90%;
  border-radius: var(--radius-medium);
  background: var(--surface-default);
  transition: all 120ms ease;
}

.auth-spinner {
  width: var(--space-7);
  height: var(--space-7);
  border: 3px solid var(--surface-active);
  border-top: 3px solid var(--text-secondary);
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin: 0 auto var(--space-5);
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

@media (max-width: 1200px) {
  .dashboard-layout {
    grid-template-columns: 1fr;
    gap: var(--space-6);
    padding: var(--space-6);
  }

  .dashboard-rail { order: 2; }
}

@media (max-width: 768px) {
  .page { padding: var(--space-4); }

  .dashboard-layout {
    padding: var(--space-5);
    gap: var(--space-5);
  }

  .dashboard-main,
  .dashboard-container { gap: var(--space-5); }

  .dashboard-metrics { gap: var(--space-5); }

  .quick-actions { grid-template-columns: 1fr; }

  .progress-text { flex-direction: column; gap: var(--space-2); }
}

@media (max-width: 520px) {
  .dashboard-layout { padding: var(--space-4); }

  .metric-value { font-size: 24px; }

  .card-title,
  .section-title,
  .plans-tile-text h3 { font-size: 16px; }
}
</style>
</head>

<body>
  <!-- AUTH SCREEN - pokazuje siÄ™ przed sprawdzeniem sesji -->
  <div id="auth-screen">
    <div class="auth-container">
      <div class="auth-spinner"></div>
      <h3 style="margin-bottom: 10px; color: var(--dv-text);" data-i18n="dashboard.auth.title"></h3>
      <p style="color: var(--dv-text2); margin-bottom: 20px;" data-i18n="dashboard.auth.subtitle"></p>
      <div id="auth-message" style="font-size: 14px; color: var(--dv-muted);"></div>
    </div>
  </div>

  <canvas id="ambientParticles"></canvas>
  
  <div id="page-wrapper" style="display: none;">
    <div id="sidebar-spacer"></div>
    <div id="main-content">
      <div class="page" id="panel_root" data-user-id="CURRENT USER" data-active-bot-id="">

      <div class="dashboard-container">
        <div class="dashboard-layout">
          <div class="dashboard-main">
            <div class="dashboard-metrics">
              <div class="metric">
                <span class="metric-label" data-i18n="dashboard.kpi.conversations"></span>
                <span class="metric-value" id="kpi-conversations">0</span>
              </div>
              <div class="metric">
                <span class="metric-label" data-i18n="dashboard.kpi.messages"></span>
                <span class="metric-value" id="kpi-messages">0</span>
              </div>
              <div class="metric">
                <span class="metric-label" data-i18n="dashboard.kpi.sources"></span>
                <span class="metric-value" id="kpi-sources">0</span>
              </div>
              <div class="metric">
                <span class="metric-label" data-i18n="dashboard.kpi.avgResponse"></span>
                <span class="metric-value" id="kpi-avg-time">--</span>
              </div>
            </div>

            <section class="dashboard-section">
              <div class="section-head">
                <div>
                  <div class="section-title" data-i18n="dashboard.checklist.title"></div>
                  <div class="section-subtitle" id="panel-progress-text" data-i18n="dashboard.checklist.subtitle"></div>
                </div>
              </div>

              <div class="progress-container">
                <div class="progress-bar">
                  <div class="progress-fill" id="panel-progress-fill" style="width: 0%"></div>
                </div>
                <div class="progress-text">
                  <span id="panel-progress-label">0/5</span>
                  <span data-i18n="dashboard.checklist.stepsSuffix"></span>
                  <span data-i18n="dashboard.checklist.selectBotHint"></span>
                </div>
              </div>

              <div class="onboarding-flow">
                <div class="onboarding-step check-item active" id="step-create-bot">
                  <div class="check-icon">
                    <img src="https://d98a890ebc03293bc70c4f2e92e9e2e5.cdn.bubble.io/f1770249140796x253773293772721950/boty.svg" alt="Boty" style="width:16px;height:16px;filter:brightness(0) invert(1);opacity:0.7;">
                  </div>
                  <div class="check-content">
                    <div class="check-title" data-i18n="dashboard.checklist.createBot.title"></div>
                    <div class="check-hint" data-i18n="dashboard.checklist.createBot.hint"></div>
                  </div>
                  <div class="check-status">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" />
                    </svg>
                  </div>
                </div>
                <div class="onboarding-step check-item" id="step-prompt">
                  <div class="check-icon">
                    <img src="https://d98a890ebc03293bc70c4f2e92e9e2e5.cdn.bubble.io/f1770249125077x656254872647275600/prompt.svg" alt="Prompt" style="width:16px;height:16px;filter:brightness(0) invert(1);opacity:0.7;">
                  </div>
                  <div class="check-content">
                    <div class="check-title" data-i18n="dashboard.checklist.prompt.title"></div>
                    <div class="check-hint" data-i18n="dashboard.checklist.prompt.hint"></div>
                  </div>
                  <div class="check-status">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" />
                    </svg>
                  </div>
                </div>
                <div class="onboarding-step check-item" id="step-style">
                  <div class="check-icon">
                    <img src="https://d98a890ebc03293bc70c4f2e92e9e2e5.cdn.bubble.io/f1770249145896x475580076785379700/wyglad.svg" alt="Wyglad" style="width:16px;height:16px;filter:brightness(0) invert(1);opacity:0.7;">
                  </div>
                  <div class="check-content">
                    <div class="check-title" data-i18n="dashboard.checklist.appearance.title"></div>
                    <div class="check-hint" data-i18n="dashboard.checklist.appearance.hint"></div>
                  </div>
                  <div class="check-status">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" />
                    </svg>
                  </div>
                </div>
                <div class="onboarding-step check-item" id="step-add-files">
                  <div class="check-icon">
                    <img src="https://d98a890ebc03293bc70c4f2e92e9e2e5.cdn.bubble.io/f1770249121272x452195540458458100/pliki.svg" alt="Pliki" style="width:16px;height:16px;filter:brightness(0) invert(1);opacity:0.7;">
                  </div>
                  <div class="check-content">
                    <div class="check-title" data-i18n="dashboard.checklist.files.title"></div>
                    <div class="check-hint" data-i18n="dashboard.checklist.files.hint"></div>
                  </div>
                  <div class="check-status">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" />
                    </svg>
                  </div>
                </div>
                <div class="onboarding-step check-item" id="step-install">
                  <div class="check-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M17.25 6.75L22.5 12l-5.25 5.25m-10.5 0L1.5 12l5.25-5.25m7.5-3l-4.5 16.5" />
                    </svg>
                  </div>
                  <div class="check-content">
                    <div class="check-title" data-i18n="dashboard.checklist.install.title"></div>
                    <div class="check-hint" data-i18n="dashboard.checklist.install.hint"></div>
                  </div>
                  <div class="check-status">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" />
                    </svg>
                  </div>
                </div>
              </div>

              <button class="btn btn-primary" id="btn-continue" style="margin-top: 24px; width: 100%;">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" style="width:16px;height:16px;stroke-width:2;">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M13.5 4.5L21 12m0 0l-7.5 7.5M21 12H3" />
                </svg>
                <span data-i18n="dashboard.checklist.continue"></span>
              </button>
            </section>

            <section class="dashboard-section glass-card active" data-card="files">
              <div class="card-header" onclick="toggleCard(this)">
                <div class="card-header-left">
                  <div class="card-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12.75V12A2.25 2.25 0 014.5 9.75h15A2.25 2.25 0 0121.75 12v.75m-8.69-6.44l-2.12-2.12a1.5 1.5 0 00-1.061-.44H4.5A2.25 2.25 0 002.25 6v12a2.25 2.25 0 002.25 2.25h15A2.25 2.25 0 0021.75 18V9a2.25 2.25 0 00-2.25-2.25h-5.379a1.5 1.5 0 01-1.06-.44z" />
                    </svg>
                  </div>
                  <div>
                    <div class="card-title" data-i18n="dashboard.files.title"></div>
                    <div class="card-subtitle" data-i18n="dashboard.files.subtitle"></div>
                  </div>
                </div>
                <div class="card-arrow">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
                  </svg>
                </div>
              </div>
              <div class="card-body">
                <div class="files-grid" id="panel-files-list"></div>
                <div class="empty-state" id="files-empty">
                  <div class="empty-state-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m2.25 0H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" />
                    </svg>
                  </div>
                  <div data-i18n="dashboard.files.empty"></div>
                </div>
              </div>
            </section>

            <div class="quick-actions">
              <a href="#boty" class="quick-action" data-action="boty">
                <div class="quick-action-icon">
                  <img src="https://d98a890ebc03293bc70c4f2e92e9e2e5.cdn.bubble.io/f1770249140796x253773293772721950/boty.svg" alt="Boty" style="width:16px;height:16px;filter:brightness(0) invert(1);">
                </div>
                <div class="quick-action-text" data-i18n="dashboard.quickActions.createBot"></div>
              </a>
              <a href="#pliki" class="quick-action" data-action="pliki">
                <div class="quick-action-icon">
                  <img src="https://d98a890ebc03293bc70c4f2e92e9e2e5.cdn.bubble.io/f1770249121272x452195540458458100/pliki.svg" alt="Pliki" style="width:16px;height:16px;filter:brightness(0) invert(1);">
                </div>
                <div class="quick-action-text" data-i18n="dashboard.quickActions.addKnowledge"></div>
              </a>
              <a href="#wyglad" class="quick-action" data-action="wyglad">
                <div class="quick-action-icon">
                  <img src="https://d98a890ebc03293bc70c4f2e92e9e2e5.cdn.bubble.io/f1770249145896x475580076785379700/wyglad.svg" alt="Wyglad" style="width:16px;height:16px;filter:brightness(0) invert(1);">
                </div>
                <div class="quick-action-text" data-i18n="dashboard.quickActions.appearance"></div>
              </a>
              <a href="#instalacja" class="quick-action" data-action="instalacja">
                <div class="quick-action-icon">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M17.25 6.75L22.5 12l-5.25 5.25m-10.5 0L1.5 12l5.25-5.25m7.5-3l-4.5 16.5" />
                  </svg>
                </div>
                <div class="quick-action-text" data-i18n="dashboard.quickActions.install"></div>
              </a>
            </div>

            <a href="/plany" class="plans-tile">
              <div class="plans-tile-content">
                <div class="plans-tile-icon">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 13.5l10.5-11.25L12 10.5h8.25L9.75 21.75 12 13.5H3.75z" />
                  </svg>
                </div>
                <div class="plans-tile-text">
                  <h3 data-i18n="dashboard.plans.title"></h3>
                  <p data-i18n="dashboard.plans.subtitle"></p>
                </div>
              </div>
              <div class="plans-tile-arrow">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" />
                </svg>
              </div>
            </a>
          </div>

          <div class="dashboard-rail">
            <section class="dashboard-section glass-card active" data-card="conversations">
              <div class="card-header" onclick="toggleCard(this)">
                <div class="card-header-left">
                  <div class="card-icon">
                    <img src="https://d98a890ebc03293bc70c4f2e92e9e2e5.cdn.bubble.io/f1770249131284x840037696645927700/hisotria.svg" alt="Historia" style="width:16px;height:16px;filter:brightness(0) invert(1);">
                  </div>
                  <div>
                    <div class="card-title" data-i18n="dashboard.conversations.title"></div>
                    <div class="card-subtitle" id="ckpConvInfo" data-i18n="dashboard.conversations.selectHint"></div>
                  </div>
                </div>
                <div class="card-arrow">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
                  </svg>
                </div>
              </div>
              <div class="card-body">
                <div class="activity-rail">
                  <div class="activity-item conv-header">
                    <div class="bot-selector">
                      <select id="panel-active-bot" class="bot-select">
                        <option value="" data-i18n="dashboard.activeBot.loading"></option>
                      </select>
                      <div class="card-subtitle" id="panel-active-bot-label">
                        <span data-i18n="dashboard.activeBot.label"></span>
                        <span id="panel-active-bot-name">--</span>
                      </div>
                    </div>
                  </div>
                  <div class="conv-layout">
                    <div class="conv-list activity-item">
                      <div class="conv-list-header">
                        <span data-i18n="dashboard.conversations.listTitle"></span>
                        <span class="conv-count" id="conv-count">0</span>
                      </div>
                      <div class="conv-items" id="ckpConvList">
                        <div class="empty-state">
                          <div class="empty-state-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                              <path stroke-linecap="round" stroke-linejoin="round" d="M8.625 12a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0H8.25m4.125 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0H12m4.125 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0h-.375M21 12c0 4.556-4.03 8.25-9 8.25a9.764 9.764 0 01-2.555-.337A5.972 5.972 0 015.41 20.97a5.969 5.969 0 01-.474-.065 4.48 4.48 0 00.978-2.025c.09-.457-.133-.901-.467-1.226C3.93 16.178 3 14.189 3 12c0-4.556 4.03-8.25 9-8.25s9 3.694 9 8.25z" />
                            </svg>
                          </div>
                          <div data-i18n="dashboard.conversations.empty"></div>
                        </div>
                      </div>
                    </div>

                    <div class="conv-detail activity-item">
                      <div class="conv-meta" id="ckpConvMeta">
                        <div class="conv-meta-title" data-i18n="dashboard.conversations.detailsTitle"></div>
                        <div id="ckpConvMetaVisitor" class="conv-meta-visitor" data-i18n="dashboard.conversations.detailsHint"></div>
                      </div>
                      <div class="messages-container" id="ckpConvMessages">
                        <div class="empty-state">
                          <div class="empty-state-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                              <path stroke-linecap="round" stroke-linejoin="round" d="M7.5 8.25h9m-9 3H12m-9.75 1.51c0 1.6 1.123 2.994 2.707 3.227 1.129.166 2.27.293 3.423.379.35.026.67.21.865.501L12 21l2.755-4.133a1.14 1.14 0 01.865-.501 48.172 48.172 0 003.423-.379c1.584-.233 2.707-1.626 2.707-3.228V6.741c0-1.602-1.123-2.995-2.707-3.228A48.394 48.394 0 0012 3c-2.392 0-4.744.175-7.043.513C3.373 3.746 2.25 5.14 2.25 6.741v6.018z" />
                            </svg>
                          </div>
                          <div data-i18n="dashboard.conversations.selectLeftHint"></div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </section>
          </div>
        </div>
      </div>
  </div><!-- /page -->

  </div><!-- /main-content -->
  </div><!-- /page-wrapper -->

  <div id="dashboard-i18n" style="display:none">
    <span id="i18n-dashboard-no-bots" data-i18n="dashboard.activeBot.none"></span>
    <span id="i18n-dashboard-file-default" data-i18n="dashboard.files.defaultName"></span>
    <span id="i18n-dashboard-conv-empty-week" data-i18n="dashboard.conversations.emptyWeek"></span>
    <span id="i18n-dashboard-anonymous" data-i18n="dashboard.conversations.anonymous"></span>
    <span id="i18n-dashboard-no-preview" data-i18n="dashboard.conversations.noPreview"></span>
    <span id="i18n-dashboard-conv-count-label" data-i18n="dashboard.conversations.countLabel"></span>
  </div>

  <script type="module" src="../js/language.js"></script>
  <script type="module" src="../js/lang-dropdown.js"></script>
  <script type="module" src="../js/auth-bootstrap.js"></script>

  <!-- SYSTEM AUTORYZACJI - wykonuje siÄ™ jako pierwszy -->
  <script>
  (async function checkAuth() {
    console.log('đź” Dashboard: sprawdzam sesjÄ™...');

    const getLanguage = () => window.DaVeriLanguage?.getCurrentLanguage?.() || 'en';
    const buildLoginUrl = () => {
      const langApi = window.DaVeriLanguage;
      if (langApi?.buildLanguageUrl) {
        return langApi.buildLanguageUrl(getLanguage(), { pathname: '/login/' });
      }
      return `/${getLanguage()}/login/`;
    };

    const waitForAuth = () => {
      if (window.DaVeriAuth?.ready) {
        return window.DaVeriAuth.ready;
      }
      return new Promise((resolve, reject) => {
        const handleReady = (event) => {
          cleanup();
          resolve(event.detail);
        };
        const handleFailed = (event) => {
          cleanup();
          reject(event.detail?.error || new Error('Not authenticated'));
        };
        const cleanup = () => {
          document.removeEventListener('auth:ready', handleReady);
          document.removeEventListener('auth:failed', handleFailed);
        };
        document.addEventListener('auth:ready', handleReady, { once: true });
        document.addEventListener('auth:failed', handleFailed, { once: true });
      });
    };

    try {
      const data = await waitForAuth();
      console.log('Dane sesji:', data);

      console.log('âś… ZALOGOWANY jako:', data.user.email);

      const root = document.getElementById('panel_root');
      if (root) {
        root.dataset.userId = data.user.id || data.user.email || "";
      }

      document.getElementById('auth-screen').style.display = 'none';
      document.getElementById('page-wrapper').style.display = 'flex';

      if (typeof initPanel === 'function') initPanel();
    } catch (error) {
      console.error('âťŚ BĹ‚Ä…d autoryzacji:', error);

      const authMessage = document.getElementById('auth-message');
      if (authMessage) {
        authMessage.innerHTML = `
          <p style="color: var(--dv-burg); margin-bottom: 15px;" data-i18n="dashboard.auth.notLoggedIn"></p>
          <button onclick="window.location.href='https://api.daveri.io/auth/google'" 
                  style="padding: 10px 20px; background: var(--dv-grad); border: none; border-radius: var(--dv-radius-sm); color: white; font-weight: 600; cursor: pointer;">
            Zaloguj przez Google
          </button>
          <p style="margin-top: 15px; font-size: 12px;">
            <a href="javascript:location.reload()" style="color: var(--dv-muted); text-decoration: underline;" data-i18n="dashboard.auth.refresh"></a>
          </p>
        `;
      }

      window.location.href = buildLoginUrl();
    }
  })();
  </script>

  <!-- Particles Animation -->
  <script>
  (function() {
    'use strict';
    const canvas = document.getElementById('ambientParticles');
    if (!canvas) return;
    const ctx = canvas.getContext('2d');
    let particles = [];
    const particleCount = 50;
    let animationId;
    
    function resize() {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
    }
    
    function createParticle() {
      return {
        x: Math.random() * canvas.width,
        y: Math.random() * canvas.height,
        size: Math.random() * 1 + 0.8,
        speedX: (Math.random() - 0.5) * 0.12,
        speedY: (Math.random() - 0.5) * 0.12,
        opacity: Math.random() * 0.08 + 0.04,
        opacityDirection: Math.random() > 0.5 ? 1 : -1,
        opacitySpeed: Math.random() * 0.0008 + 0.0004
      };
    }
    
    function initParticles() {
      particles = [];
      for (let i = 0; i < particleCount; i++) {
        particles.push(createParticle());
      }
    }
    
    function animate() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      const isLight = document.documentElement.getAttribute('data-theme') === 'light';
      particles.forEach(p => {
        p.x += p.speedX;
        p.y += p.speedY;
        if (p.x < 0) p.x = canvas.width;
        if (p.x > canvas.width) p.x = 0;
        if (p.y < 0) p.y = canvas.height;
        if (p.y > canvas.height) p.y = 0;
        p.opacity += p.opacityDirection * p.opacitySpeed;
        if (p.opacity >= 0.12) {
          p.opacity = 0.12;
          p.opacityDirection = -1;
        } else if (p.opacity <= 0.04) {
          p.opacity = 0.04;
          p.opacityDirection = 1;
        }
        ctx.beginPath();
        ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
        ctx.fillStyle = isLight 
          ? `rgba(0, 0, 0, ${p.opacity})` 
          : `rgba(255, 255, 255, ${p.opacity})`;
        ctx.fill();
      });
      animationId = requestAnimationFrame(animate);
    }
    
    resize();
    initParticles();
    animate();
    window.addEventListener('resize', () => { resize(); initParticles(); });
    window.addEventListener('unload', () => { if (animationId) cancelAnimationFrame(animationId); });
  })();
  </script>

  <!-- Toggle Card Function -->
  <script>
  function toggleCard(header) {
    const card = header.closest('.glass-card');
    if (card) card.classList.toggle('active');
  }
  </script>

  <script type="module" src="../js/sidebar-loader.js"></script>

  <!-- Application Data API -->
  <script type="module">
    import { getApiUrl } from "../js/api.js";
    import { getActiveBotId, setActiveBotId } from "../js/active-bot.js";

    const API_BOTS = getApiUrl("/api/bots");
    const API_FILES = getApiUrl("/api/files");
    const API_CONVERSATIONS = getApiUrl("/api/conversations");
    const API_MESSAGES = getApiUrl("/api/messages");
    const root = document.getElementById("panel_root");
    const botSelect = document.getElementById("panel-active-bot");
    const kpiConversationsEl = document.getElementById("kpi-conversations");
    const kpiMessagesEl = document.getElementById("kpi-messages");
    const kpiSourcesEl = document.getElementById("kpi-sources");
    const kpiAvgTimeEl = document.getElementById("kpi-avg-time");
    const convCountEl = document.getElementById("conv-count");
    const filesListEl = document.getElementById("panel-files-list");
    const filesEmptyEl = document.getElementById("files-empty");
    const stepElements = {
      create: document.getElementById("step-create-bot"),
      prompt: document.getElementById("step-prompt"),
      style: document.getElementById("step-style"),
      files: document.getElementById("step-add-files"),
      install: document.getElementById("step-install")
    };
    const progressFill = document.getElementById("panel-progress-fill");
    const progressLabel = document.getElementById("panel-progress-label");
    const convListEl = document.getElementById("ckpConvList");
    const convMessagesEl = document.getElementById("ckpConvMessages");
    const convInfoEl = document.getElementById("ckpConvInfo");
    const convMetaVisitor = document.getElementById("ckpConvMetaVisitor");

    const state = {
      bots: [],
      activeBotId: null,
      totalFilesForUser: 0,
      conversations: [],
      selectedConversationId: null
    };

    const fetchJson = async (url, options = {}) => {
      const method = String(options.method || "GET").toUpperCase();
      const headers = { ...(options.headers || {}) };
      if (method !== "GET" && method !== "HEAD" && !("Content-Type" in headers)) {
        headers["Content-Type"] = "application/json";
      }

      const response = await fetch(url, {
        credentials: "include",
        ...options,
        headers
      });

      let payload = null;
      try {
        payload = await response.json();
      } catch {
        payload = null;
      }

      if (!response.ok) {
        throw new Error(payload?.error || `Request failed: ${response.status}`);
      }
      return payload;
    };

    function getUserId() {
      const id = String(root?.dataset.userId || window?.DaVeriAuth?.user?.id || "").trim();
      return id || null;
    }

    function getInitialActiveBotId() {
      const stored = getActiveBotId();
      if (stored) return stored;
      return (root?.dataset.activeBotId || "").trim() || null;
    }

    function sendToBubble(action, payload) {
      const payloadStr = payload == null ? "" : (typeof payload === "string" ? payload : JSON.stringify(payload));
      if (window.bubble_fn_j2b_payload) window.bubble_fn_j2b_payload(payloadStr);
      if (window.bubble_fn_j2b_action) window.bubble_fn_j2b_action(String(action || ""));
    }

    const i18nText = (id) => document.getElementById(id)?.textContent || "";

    function translateDynamicContent() {
      if (window.DaVeriI18n?.translatePage) {
        window.DaVeriI18n.translatePage();
      }
    }

    function renderBotsInPanel() {
      if (!botSelect) return;
      botSelect.innerHTML = "";
      if (!state.bots.length) {
        setActiveBotId("");
        const opt = document.createElement("option");
        opt.value = "";
        opt.textContent = i18nText("i18n-dashboard-no-bots");
        botSelect.appendChild(opt);
        const botNameEl = document.getElementById("panel-active-bot-name");
        if (botNameEl) botNameEl.textContent = "--";
        return;
      }
      state.bots.forEach(bot => {
        const opt = document.createElement("option");
        opt.value = bot.id;
        opt.textContent = bot.name || ("Bot " + bot.id);
        botSelect.appendChild(opt);
      });
      const preferredId = state.activeBotId || getInitialActiveBotId();
      const hasPreferred = preferredId ? state.bots.some((bot) => String(bot.id) === String(preferredId)) : false;
      state.activeBotId = hasPreferred ? preferredId : state.bots[0]?.id || null;
      setActiveBotId(state.activeBotId || "");
      botSelect.value = state.activeBotId || "";
      const current = state.bots.find(b => String(b.id) === String(state.activeBotId));
      const botNameEl = document.getElementById("panel-active-bot-name");
      if (botNameEl) botNameEl.textContent = current ? (current.name || current.id) : "--";
      updateChecklist();
      loadFilesList();
      loadConversationsAndKpis();
    }

    async function loadBotsForPanel() {
      try {
        const payload = await fetchJson(API_BOTS);
        state.bots = Array.isArray(payload) ? payload : (Array.isArray(payload?.bots) ? payload.bots : []);
        renderBotsInPanel();
      } catch (e) { console.error("[Panel] loadBotsForPanel failed:", e); }
    }

    function updateChecklist() {
      const hasBot = state.bots.length > 0;
      const hasFiles = state.totalFilesForUser > 0;
      const activeBotInstalled = state.bots.some(b => String(b.id) === String(state.activeBotId) && (b.installed === true || b.installed === "yes"));
      const steps = [
        { el: stepElements.create, done: hasBot },
        { el: stepElements.prompt, done: hasBot },
        { el: stepElements.style, done: hasBot },
        { el: stepElements.files, done: hasFiles },
        { el: stepElements.install, done: activeBotInstalled }
      ];
      steps.forEach(step => {
        if (step.el) step.done ? step.el.classList.add("done") : step.el.classList.remove("done");
      });
      const doneCount = steps.filter(s => s.done).length;
      const pct = (doneCount / 5) * 100;
      if (progressFill) progressFill.style.width = `${pct}%`;
      if (progressLabel) progressLabel.textContent = `${doneCount}/5`;
    }

    async function loadSourcesKpiAndFileCount() {
      if (!kpiSourcesEl) return;
      try {
        const payload = await fetchJson(`${API_FILES}?limit=1&include_count=1`);
        const total = Number.isFinite(Number(payload?.count)) ? Number(payload.count) : 0;
        state.totalFilesForUser = total;
        kpiSourcesEl.textContent = total;
        updateChecklist();
      } catch (e) { console.error("[Panel] loadSourcesKpiAndFileCount failed:", e); }
    }

    function formatDateTime(iso) {
      if (!iso) return "";
      try {
        const d = new Date(iso);
        return d.toLocaleDateString("pl-PL") + " " + d.toLocaleTimeString("pl-PL", { hour: '2-digit', minute: '2-digit' });
      } catch (e) { return iso; }
    }

    async function loadFilesList() {
      if (!filesListEl) return;
      try {
        let endpoint = `${API_FILES}?limit=8`;
        if (state.activeBotId) endpoint += `&bot_id=${encodeURIComponent(state.activeBotId)}`;
        const payload = await fetchJson(endpoint);
        const rows = Array.isArray(payload?.files) ? payload.files : [];
      if (!rows.length) { filesEmptyEl.style.display = "block"; filesListEl.innerHTML = ""; return; }
      filesEmptyEl.style.display = "none";
      filesListEl.innerHTML = "";
      rows.forEach(row => {
          const fileEl = document.createElement("div");
          fileEl.className = "file-item";
          const icon = document.createElement("div");
          icon.className = "file-icon";
          icon.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m2.25 0H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" /></svg>`;
          const name = document.createElement("div");
          name.className = "file-name";
          name.textContent = row.name || i18nText("i18n-dashboard-file-default");
          const date = document.createElement("div");
          date.className = "file-date";
          date.textContent = formatDateTime(row.created_at);
          fileEl.appendChild(icon);
          fileEl.appendChild(name);
          fileEl.appendChild(date);
          filesListEl.appendChild(fileEl);
        });
      } catch (e) { filesEmptyEl.style.display = "block"; filesListEl.innerHTML = ""; }
    }

    function formatShortDate(iso) {
      if (!iso) return "";
      try {
        const d = new Date(iso);
        return d.toLocaleDateString("pl-PL", { day: '2-digit', month: '2-digit', year: 'numeric' }) + " " + d.toLocaleTimeString("pl-PL", { hour: '2-digit', minute: '2-digit' });
      } catch (e) { return ""; }
    }

    function renderConversationList() {
      if (!convListEl || !convCountEl) return;
      if (!state.conversations.length) {
        convListEl.innerHTML = `<div class="empty-state"><div class="empty-state-icon"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M8.625 12a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0H8.25m4.125 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0H12m4.125 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0h-.375M21 12c0 4.556-4.03 8.25-9 8.25a9.764 9.764 0 01-2.555-.337A5.972 5.972 0 015.41 20.97a5.969 5.969 0 01-.474-.065 4.48 4.48 0 00.978-2.025c.09-.457-.133-.901-.467-1.226C3.93 16.178 3 14.189 3 12c0-4.556 4.03-8.25 9-8.25s9 3.694 9 8.25z" /></svg></div><div data-i18n="dashboard.conversations.emptyForBot"></div></div>`;
        convCountEl.textContent = "0";
        if (convInfoEl) convInfoEl.textContent = i18nText("i18n-dashboard-conv-empty-week");
        translateDynamicContent();
        return;
      }
      convCountEl.textContent = state.conversations.length;
      convListEl.innerHTML = "";
      state.conversations.forEach(conv => {
        const item = document.createElement("button");
        item.className = "conv-item" + (conv.id === state.selectedConversationId ? " active" : "");
        item.type = "button";
        const visitor = document.createElement("div");
        visitor.className = "conv-visitor";
        visitor.textContent = conv.visitor_id || i18nText("i18n-dashboard-anonymous");
        const preview = document.createElement("div");
        preview.className = "conv-preview";
        preview.textContent = conv.last_message_preview || i18nText("i18n-dashboard-no-preview");
        const date = document.createElement("div");
        date.className = "conv-date";
        date.textContent = formatShortDate(conv.last_message_at) || "";
        item.appendChild(visitor);
        item.appendChild(preview);
        item.appendChild(date);
        item.addEventListener("click", () => {
          state.selectedConversationId = conv.id;
          renderConversationList();
          loadMessages(conv.id);
          if (convMetaVisitor) {
            convMetaVisitor.innerHTML = `<span data-i18n="dashboard.conversations.visitorLabel"></span> <span>${conv.visitor_id || i18nText("i18n-dashboard-anonymous")}</span>`;
            translateDynamicContent();
          }
        });
        convListEl.appendChild(item);
      });
      if (convInfoEl) convInfoEl.textContent = `${i18nText("i18n-dashboard-conv-count-label")} ${state.conversations.length}`;
    }

    async function loadMessages(conversationId) {
      if (!convMessagesEl) return;
      convMessagesEl.innerHTML = '<div class="empty-state"><div class="empty-state-icon"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" /></svg></div><div data-i18n="dashboard.conversations.loading"></div></div>';
      translateDynamicContent();
      try {
        const payload = await fetchJson(`${API_MESSAGES}?conversation_id=${encodeURIComponent(conversationId)}`);
        const msgs = Array.isArray(payload?.messages) ? payload.messages : [];
        if (!msgs.length) { convMessagesEl.innerHTML = '<div class="empty-state"><div class="empty-state-icon"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M7.5 8.25h9m-9 3H12m-9.75 1.51c0 1.6 1.123 2.994 2.707 3.227 1.129.166 2.27.293 3.423.379.35.026.67.21.865.501L12 21l2.755-4.133a1.14 1.14 0 01.865-.501 48.172 48.172 0 003.423-.379c1.584-.233 2.707-1.626 2.707-3.228V6.741c0-1.602-1.123-2.995-2.707-3.228A48.394 48.394 0 0012 3c-2.392 0-4.744.175-7.043.513C3.373 3.746 2.25 5.14 2.25 6.741v6.018z" /></svg></div><div data-i18n="dashboard.conversations.noMessages"></div></div>'; translateDynamicContent(); return; }
        convMessagesEl.innerHTML = "";
        msgs.forEach(m => {
          const isUser = (m.sender === "user" || m.role === "user");
          const msgEl = document.createElement("div");
          msgEl.className = `message ${isUser ? "user" : "assistant"}`;
          const content = document.createElement("div");
          content.textContent = m.content || "";
          const time = document.createElement("div");
          time.className = "message-time";
          time.textContent = formatShortDate(m.created_at);
          msgEl.appendChild(content);
          msgEl.appendChild(time);
          convMessagesEl.appendChild(msgEl);
        });
        convMessagesEl.scrollTop = convMessagesEl.scrollHeight;
      } catch (e) { convMessagesEl.innerHTML = '<div class="empty-state"><div class="empty-state-icon"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" /></svg></div><div data-i18n="dashboard.conversations.genericError"></div></div>'; translateDynamicContent(); }
    }

    async function loadConversationsAndKpis() {
      const botId = state.activeBotId;
      if (!botId) {
        if (convListEl) convListEl.innerHTML = '<div class="empty-state"><div class="empty-state-icon"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 00-2.456 2.456z" /></svg></div><div data-i18n="dashboard.conversations.selectBot"></div></div>';
        if (convMessagesEl) convMessagesEl.innerHTML = '<div class="empty-state"><div class="empty-state-icon"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M7.5 8.25h9m-9 3H12m-9.75 1.51c0 1.6 1.123 2.994 2.707 3.227 1.129.166 2.27.293 3.423.379.35.026.67.21.865.501L12 21l2.755-4.133a1.14 1.14 0 01.865-.501 48.172 48.172 0 003.423-.379c1.584-.233 2.707-1.626 2.707-3.228V6.741c0-1.602-1.123-2.995-2.707-3.228A48.394 48.394 0 0012 3c-2.392 0-4.744.175-7.043.513C3.373 3.746 2.25 5.14 2.25 6.741v6.018z" /></svg></div><div data-i18n="dashboard.conversations.selectConversation"></div></div>';
        if (kpiConversationsEl) kpiConversationsEl.textContent = "0";
        if (kpiMessagesEl) kpiMessagesEl.textContent = "0";
        if (kpiAvgTimeEl) kpiAvgTimeEl.textContent = "--";
        if (convCountEl) convCountEl.textContent = "0";
        state.conversations = [];
        state.selectedConversationId = null;
        translateDynamicContent();
        return;
      }
      try {
        const payload = await fetchJson(`${API_CONVERSATIONS}?bot_id=${encodeURIComponent(botId)}&days=7&limit=100&include_message_count=1`);
        state.conversations = Array.isArray(payload?.conversations) ? payload.conversations : [];
        state.selectedConversationId = null;
        if (kpiConversationsEl) kpiConversationsEl.textContent = state.conversations.length;
        renderConversationList();
        convMessagesEl.innerHTML = '<div class="empty-state"><div class="empty-state-icon"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M7.5 8.25h9m-9 3H12m-9.75 1.51c0 1.6 1.123 2.994 2.707 3.227 1.129.166 2.27.293 3.423.379.35.026.67.21.865.501L12 21l2.755-4.133a1.14 1.14 0 01.865-.501 48.172 48.172 0 003.423-.379c1.584-.233 2.707-1.626 2.707-3.228V6.741c0-1.602-1.123-2.995-2.707-3.228A48.394 48.394 0 0012 3c-2.392 0-4.744.175-7.043.513C3.373 3.746 2.25 5.14 2.25 6.741v6.018z" /></svg></div><div data-i18n="dashboard.conversations.selectConversation"></div></div>';
        translateDynamicContent();
        const totalMessages = Number.isFinite(Number(payload?.messages_count)) ? Number(payload.messages_count) : 0;
        if (kpiMessagesEl) kpiMessagesEl.textContent = totalMessages;
        if (kpiAvgTimeEl) kpiAvgTimeEl.textContent = "--";
      } catch (e) {
        convListEl.innerHTML = '<div class="empty-state"><div class="empty-state-icon"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" /></svg></div><div data-i18n="dashboard.conversations.genericError"></div></div>';
        if (kpiConversationsEl) kpiConversationsEl.textContent = "0";
        if (kpiMessagesEl) kpiMessagesEl.textContent = "0";
        if (convCountEl) convCountEl.textContent = "0";
        translateDynamicContent();
      }
    }

    function wirePanel() {
      if (botSelect && !botSelect.__wired) {
        botSelect.__wired = true;
        botSelect.addEventListener("change", () => {
          state.activeBotId = botSelect.value || null;
          setActiveBotId(state.activeBotId || "");
          const current = state.bots.find(b => String(b.id) === String(state.activeBotId));
          const botNameEl = document.getElementById("panel-active-bot-name");
          if (botNameEl) botNameEl.textContent = current ? (current.name || current.id) : "--";
          updateChecklist();
          loadFilesList();
          loadConversationsAndKpis();
          sendToBubble("panel:active_bot_changed", { bot_id: state.activeBotId, user_id: getUserId() });
        });
      }
      const btnContinue = document.getElementById("btn-continue");
      if (btnContinue && !btnContinue.__wired) {
        btnContinue.__wired = true;
        btnContinue.addEventListener("click", () => {
          const order = [
            { el: stepElements.create, route: "boty" },
            { el: stepElements.prompt, route: "prompt" },
            { el: stepElements.style, route: "wyglad" },
            { el: stepElements.files, route: "pliki" },
            { el: stepElements.install, route: "instalacja" }
          ];
          const missing = order.find(x => x.el && !x.el.classList.contains("done"));
          sendToBubble("panel:navigate", missing ? missing.route : "boty");
        });
      }
      document.querySelectorAll('.quick-action').forEach(action => {
        action.addEventListener('click', (e) => {
          e.preventDefault();
          const route = action.dataset.action;
          if (route) sendToBubble("panel:navigate", route);
        });
      });
      const plansTile = document.querySelector('.plans-tile');
      if (plansTile) {
        plansTile.addEventListener('click', (e) => {
          e.preventDefault();
          sendToBubble("panel:navigate", "plany");
        });
      }
    }

    // Export initPanel dla systemu autoryzacji
    window.initPanel = function() {
      console.log("[Panel] init...");
      state.activeBotId = getInitialActiveBotId();
      wirePanel();
      loadBotsForPanel();
      loadSourcesKpiAndFileCount();
    };
    
  </script>
  <script type="module" src="../js/i18n.js"></script>
</body>
</html>




